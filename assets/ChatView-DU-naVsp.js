import{a as e,j as s,B as a,A as t,C as r}from"./index-D85gtc9V.js";import{r as n}from"./leaflet-QxLtkkBL.js";import"./react-Z2Iecplj.js";import"./genai-DmvHCT3V.js";const i=({user:e,personnel:a,conversations:n,onClose:i,onStartConversation:l})=>{const d=new Set(n.flatMap(e=>e.participantIds).filter(s=>s!==e.id)),o=a.filter(s=>s.id!==e.id&&!d.has(s.id));return s.jsx("div",{className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",onClick:i,children:s.jsxs(r,{className:"w-full max-w-md",onClick:e=>e.stopPropagation(),children:[s.jsx("h3",{className:"text-lg font-bold mb-4",children:"Start a New Chat"}),s.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:o.length>0?o.map(e=>s.jsxs("button",{onClick:()=>l(e),className:"w-full flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100",children:[s.jsx(t,{name:`${e.firstName} ${e.lastName}`,imageUrl:e.avatar,className:"w-10 h-10"}),s.jsx("div",{children:`${e.firstName} ${e.lastName}`})]},e.id)):s.jsx("p",{className:"text-slate-500 text-center py-4",children:"No new people to message."})})]})})},l=({user:r,addToast:l,initialRecipient:d})=>{const[o,c]=n.useState([]),[m,f]=n.useState(null),[x,g]=n.useState([]),[u,h]=n.useState(""),[p,b]=n.useState([]),[j,N]=n.useState(!0),[v,w]=n.useState(!1),[y,k]=n.useState(!1),C=n.useRef(null),S=n.useRef(null),$=n.useMemo(()=>new Map(p.map(e=>[e.id,e])),[p]),I=n.useMemo(()=>o.find(e=>e.id===m),[o,m]),M=n.useCallback(async(s=!1)=>{const a=new AbortController;S.current?.abort(),S.current=a,s&&N(!0);try{if(!r.companyId)return;const[t,n]=await Promise.all([e.getConversationsForUser(r.id,{signal:a.signal}),e.getUsersByCompany(r.companyId,{signal:a.signal})]);if(a.signal.aborted)return;if(c(t),a.signal.aborted)return;if(b(n),s){if(a.signal.aborted)return;d?F(d):t.length>0&&f(t[0].id)}}catch(t){if(a.signal.aborted)return;l("Failed to load chat data","error")}finally{s&&!a.signal.aborted&&N(!1)}},[r,l,d]);n.useEffect(()=>(M(!0),()=>{S.current?.abort()}),[M]),n.useEffect(()=>{if(!m)return;const s=async()=>{try{const s=await e.getMessagesForConversation(m,r.id);g(e=>{const a=new Set(e.map(e=>e.id)),t=s.filter(e=>!a.has(e.id));return[...e,...t]})}catch(s){console.error("Failed to fetch messages",s)}};s();const a=setInterval(s,5e3);return()=>clearInterval(a)},[m,r.id]),n.useEffect(()=>{C.current?.scrollIntoView({behavior:"smooth"})},[x]);const F=e=>{k(!1);const s=o.find(s=>s.participantIds.includes(e.id));if(s)f(s.id);else{const s={id:`new-${e.id}`,participantIds:[r.id,e.id],lastMessage:null};c(e=>[s,...e]),f(s.id),g([])}},U=async()=>{if(!u.trim()||!I)return;const s=I.participantIds.find(e=>e!==r.id);if(!s)return;const a=`temp-${Date.now()}`,t={id:a,conversationId:I.id,senderId:r.id,content:u,timestamp:new Date,isRead:!0,isSending:!0};g(e=>[...e,t]),h(""),w(!0);try{const{conversation:n,message:i}=await e.sendMessage(r.id,s,t.content,I.id.startsWith("new-")?void 0:I.id);g(e=>e.map(e=>e.id===a?i:e)),c(e=>e.map(e=>e.id===I.id||e.id===n.id?n:e)),I.id!==n.id&&f(n.id)}catch(n){g(e=>e.map(e=>e.id===a?{...e,isSending:!1,error:"Failed to send"}:e)),l("Failed to send message.","error")}finally{w(!1)}},R=e=>{const s=e.participantIds.find(e=>e!==r.id);return $.get(s||"")};return s.jsxs(s.Fragment,{children:[y&&s.jsx(i,{user:r,personnel:p,conversations:o,onClose:()=>k(!1),onStartConversation:F}),s.jsxs("div",{className:"flex h-[calc(100vh-8rem)] border rounded-lg bg-white dark:bg-slate-900 dark:border-slate-700",children:[s.jsxs("aside",{className:"w-1/3 border-r dark:border-slate-700 flex flex-col",children:[s.jsxs("div",{className:"p-4 border-b dark:border-slate-700 flex justify-between items-center",children:[s.jsx("h2",{className:"font-semibold text-lg",children:"Conversations"}),s.jsx(a,{variant:"ghost",size:"sm",onClick:()=>k(!0),children:"New Chat"})]}),s.jsx("div",{className:"overflow-y-auto",children:o.map(e=>{const a=R(e);if(!a)return null;const n=e.lastMessage&&!e.lastMessage.isRead&&e.lastMessage.senderId!==r.id;return s.jsxs("button",{onClick:()=>f(e.id),className:"w-full text-left p-4 flex gap-3 items-center relative "+(m===e.id?"bg-sky-50 dark:bg-sky-900/50":"hover:bg-slate-50 dark:hover:bg-slate-800"),children:[n&&s.jsx("div",{className:"absolute left-2 top-1/2 -translate-y-1/2 w-2 h-2 rounded-full bg-sky-500"}),s.jsx(t,{name:`${a.firstName} ${a.lastName}`,imageUrl:a.avatar,className:"w-10 h-10"}),s.jsxs("div",{className:"flex-grow overflow-hidden",children:[s.jsx("p",{className:"font-semibold "+(n?"text-slate-900 dark:text-slate-50":""),children:`${a.firstName} ${a.lastName}`}),s.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400 truncate",children:e.lastMessage?.content})]})]},e.id)})})]}),s.jsx("main",{className:"w-2/3 flex flex-col",children:I?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"p-4 border-b dark:border-slate-700 flex items-center gap-3",children:[s.jsx(t,{name:`${R(I)?.firstName} ${R(I)?.lastName}`||"",imageUrl:R(I)?.avatar,className:"w-8 h-8"}),s.jsx("h3",{className:"font-semibold",children:`${R(I)?.firstName} ${R(I)?.lastName}`})]}),s.jsxs("div",{className:"flex-grow p-4 overflow-y-auto space-y-4",children:[x.map(e=>s.jsxs("div",{className:"flex gap-3 "+(e.senderId===r.id?"justify-end":"justify-start"),children:[e.senderId!==r.id&&s.jsx(t,{name:`${R(I)?.firstName} ${R(I)?.lastName}`||"",imageUrl:R(I)?.avatar,className:"w-8 h-8 self-end"}),s.jsxs("div",{className:`p-3 rounded-lg max-w-lg ${e.senderId===r.id?"bg-sky-600 text-white":"bg-slate-100 dark:bg-slate-700"} ${e.isSending?"opacity-70":""}`,children:[e.content,e.error&&s.jsx("span",{className:"text-xs text-red-300 block mt-1",children:e.error})]})]},e.id)),s.jsx("div",{ref:C})]}),s.jsxs("div",{className:"p-4 border-t dark:border-slate-700 flex gap-2",children:[s.jsx("input",{value:u,onChange:e=>h(e.target.value),onKeyDown:e=>"Enter"===e.key&&U(),className:"w-full p-2 border rounded-md dark:bg-slate-800 dark:border-slate-600",placeholder:"Type a message..."}),s.jsx(a,{onClick:U,isLoading:v,children:"Send"})]})]}):s.jsx("div",{className:"flex-grow flex items-center justify-center text-slate-500",children:s.jsx("p",{children:"Select a conversation or start a new one."})})})]})]})};export{l as ChatView};
