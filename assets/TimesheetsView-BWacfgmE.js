import{h as e,P as t,a as s,e as a,j as r,C as i,B as l}from"./index-D85gtc9V.js";import{r as n}from"./leaflet-QxLtkkBL.js";import{T as c}from"./StatusBadge-DqYvwqgD.js";import"./react-Z2Iecplj.js";import"./genai-DmvHCT3V.js";import"./Tag-CPyoOo4I.js";const o=({user:e,projects:t,timesheetToEdit:a,onClose:c,onSuccess:o,addToast:d})=>{const[m,x]=n.useState(a?.projectId.toString()||t[0]?.id.toString()||""),[u,p]=n.useState(a?new Date(a.clockIn).toISOString().split("T")[0]:(new Date).toISOString().split("T")[0]),[h,j]=n.useState(a?new Date(a.clockIn).toTimeString().substring(0,5):"09:00"),[y,g]=n.useState(a?.clockOut?new Date(a.clockOut).toTimeString().substring(0,5):"17:00"),[f,b]=n.useState(a?.notes||""),[w,N]=n.useState(!1);return r.jsx("div",{className:"fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4",onClick:c,children:r.jsxs(i,{className:"w-full max-w-lg",onClick:e=>e.stopPropagation(),children:[r.jsxs("h2",{className:"text-2xl font-bold text-slate-800 mb-4",children:[a?"Edit":"Log"," Time"]}),r.jsxs("form",{onSubmit:async t=>{t.preventDefault();const r=new Date(`${u}T${h}`),i=new Date(`${u}T${y}`);if(r>=i)d("Clock-in time must be before clock-out time.","error");else{N(!0);try{a?(await s.updateTimesheetEntry(a.id,{projectId:m,clockIn:r,clockOut:i,notes:f},e.id),d("Timesheet updated successfully.","success")):(await s.submitTimesheet({userId:e.id,projectId:m,clockIn:r,clockOut:i,notes:f},e.id),d("Time logged successfully.","success")),o(),c()}catch(l){d(l instanceof Error?l.message:"Failed to save timesheet.","error")}finally{N(!1)}}},className:"space-y-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Project"}),r.jsx("select",{value:m,onChange:e=>x(e.target.value),className:"mt-1 w-full p-2 border rounded-md bg-white",children:t.map(e=>r.jsx("option",{value:e.id,children:e.name},e.id))})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Date"}),r.jsx("input",{type:"date",value:u,onChange:e=>p(e.target.value),className:"mt-1 w-full p-2 border rounded-md"})]}),r.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Start Time"}),r.jsx("input",{type:"time",value:h,onChange:e=>j(e.target.value),className:"mt-1 w-full p-2 border rounded-md"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"End Time"}),r.jsx("input",{type:"time",value:y,onChange:e=>g(e.target.value),className:"mt-1 w-full p-2 border rounded-md"})]})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Notes (Optional)"}),r.jsx("textarea",{value:f,onChange:e=>b(e.target.value),rows:3,className:"mt-1 w-full p-2 border rounded-md"})]}),r.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[r.jsx(l,{type:"button",variant:"secondary",onClick:c,children:"Cancel"}),r.jsx(l,{type:"submit",isLoading:w,children:"Submit"})]})]})]})})},d=({user:d,addToast:m})=>{const[x,u]=n.useState([]),[p,h]=n.useState([]),[j,y]=n.useState([]),[g,f]=n.useState(!0),[b,w]=n.useState("my-timesheets"),[N,v]=n.useState(!1),[k,T]=n.useState(null),S=n.useRef(null),C=e(d,t.MANAGE_TIMESHEETS);n.useEffect(()=>{w(C?"review":"my-timesheets")},[C]);const E=n.useCallback(async()=>{const e=new AbortController;S.current?.abort(),S.current=e,f(!0);try{if(!d.companyId)return;const[t,a,r]=await Promise.all([s.getTimesheetsByCompany(d.companyId,d.id,{signal:e.signal}),s.getProjectsByCompany(d.companyId,{signal:e.signal}),s.getUsersByCompany(d.companyId,{signal:e.signal})]);if(e.signal.aborted)return;if(u(t.sort((e,t)=>new Date(t.clockIn).getTime()-new Date(e.clockIn).getTime())),e.signal.aborted)return;if(h(a),e.signal.aborted)return;y(r)}catch(t){if(e.signal.aborted)return;m("Failed to load timesheet data.","error")}finally{if(e.signal.aborted)return;f(!1)}},[d,m]);n.useEffect(()=>(E(),()=>{S.current?.abort()}),[E]);const I=n.useMemo(()=>new Map(j.map(e=>[e.id,`${e.firstName} ${e.lastName}`])),[j]),D=n.useMemo(()=>new Map(p.map(e=>[e.id,e.name])),[p]),P=async(e,t)=>{try{let r;if(t===a.REJECTED&&(r=prompt("Please provide a reason for rejection:")||"No reason provided.",null===r))return;await s.updateTimesheetStatus(e,t,d.id,r),m(`Timesheet ${t.toLowerCase()}.`,"success"),E()}catch(r){m("Failed to update timesheet.","error")}},{reviewQueue:O,myTimesheets:M}=n.useMemo(()=>{const e=[],t=[];return x.forEach(s=>{s.userId===d.id&&t.push(s),s.status===a.PENDING&&e.push(s)}),{reviewQueue:e,myTimesheets:t}},[x,d.id]),R=(e=null)=>{T(e),v(!0)},A=e=>r.jsxs("div",{className:"overflow-x-auto",children:[r.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[r.jsx("thead",{className:"bg-slate-50",children:r.jsxs("tr",{children:[r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Employee"}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Project"}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Date"}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Hours"}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Status"}),r.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Notes"}),r.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase",children:"Actions"})]})}),r.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:e.map(e=>{const t=e.clockOut?((new Date(e.clockOut).getTime()-new Date(e.clockIn).getTime())/36e5).toFixed(2):"N/A";return r.jsxs("tr",{children:[r.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:I.get(e.userId)}),r.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:D.get(e.projectId)}),r.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:new Date(e.clockIn).toLocaleDateString()}),r.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:t}),r.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:r.jsx(c,{status:e.status})}),r.jsx("td",{className:"px-6 py-4 text-sm text-slate-500 max-w-xs truncate",title:e.notes,children:e.notes||e.rejectionReason}),r.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-right space-x-2",children:["review"===b&&e.status===a.PENDING&&r.jsxs(r.Fragment,{children:[r.jsx(l,{size:"sm",variant:"success",onClick:()=>P(e.id,a.APPROVED),children:"Approve"}),r.jsx(l,{size:"sm",variant:"danger",onClick:()=>P(e.id,a.REJECTED),children:"Reject"})]}),"my-timesheets"===b&&(e.status===a.PENDING||e.status===a.REJECTED)&&r.jsx(l,{size:"sm",variant:"secondary",onClick:()=>R(e),children:"Edit"})]})]},e.id)})})]}),0===e.length&&r.jsx("p",{className:"text-center py-10 text-slate-500",children:"No timesheets to display."})]});return g?r.jsx(i,{children:r.jsx("p",{children:"Loading timesheets..."})}):r.jsxs("div",{className:"space-y-6",children:[N&&r.jsx(o,{user:d,projects:p,timesheetToEdit:k,onClose:()=>v(!1),onSuccess:E,addToast:m}),r.jsxs("div",{className:"flex flex-col md:flex-row justify-between md:items-center gap-4",children:[r.jsx("h2",{className:"text-3xl font-bold text-slate-800",children:"Timesheets"}),r.jsx(l,{onClick:()=>R(),children:"Log Time"})]}),r.jsxs(i,{children:[r.jsx("div",{className:"border-b border-gray-200",children:r.jsxs("nav",{className:"-mb-px flex space-x-6",children:[C&&r.jsxs("button",{onClick:()=>w("review"),className:"whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm "+("review"===b?"border-sky-500 text-sky-600":"border-transparent text-slate-500 hover:text-slate-700"),children:["Review Queue (",O.length,")"]}),r.jsx("button",{onClick:()=>w("my-timesheets"),className:"whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm "+("my-timesheets"===b?"border-sky-500 text-sky-600":"border-transparent text-slate-500 hover:text-slate-700"),children:"My Timesheets"})]})}),r.jsx("div",{className:"mt-4",children:A("review"===b?O:M)})]})]})};export{d as TimesheetsView};
