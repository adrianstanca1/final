import{a as e,c as s,I as t,d as a,e as r,f as n,j as i,C as l,B as o}from"./index-D85gtc9V.js";import{r as c}from"./leaflet-QxLtkkBL.js";import{T as d}from"./Tag-CPyoOo4I.js";import{V as m}from"./ViewHeader-B8uhkq6P.js";import{c as x}from"./projectPortfolio-VMbW4p0T.js";import{g as u,a as p}from"./finance-C6WgNQzT.js";import"./react-Z2Iecplj.js";import"./genai-DmvHCT3V.js";const h=(e,s="GBP")=>new Intl.NumberFormat("en-GB",{style:"currency",currency:s,maximumFractionDigits:0}).format(e||0),g=e=>Math.max(0,Math.min(100,Math.round(e))),f=e=>e.split("\n").map(e=>e.trim()).filter(e=>e.length>0).map((e,s)=>i.jsx("p",{className:"text-sm text-muted-foreground",dangerouslySetInnerHTML:{__html:e.replace(/\*\*(.*?)\*\*/g,'<strong class="text-foreground">$1</strong>').replace(/^[-•]\s+/,"• ")}},`${e}-${s}`)),j=({data:e,accent:s="primary",emptyLabel:t})=>{if(!e.length)return i.jsx("p",{className:"text-sm text-muted-foreground",children:t});const a=Math.max(...e.map(e=>e.value),1),r="emerald"===s?"bg-emerald-500":"amber"===s?"bg-amber-500":"bg-primary";return i.jsx("div",{className:"flex items-end gap-2",children:e.map(e=>i.jsxs("div",{className:"flex flex-1 flex-col items-center gap-1",children:[i.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:e.label}),i.jsx("div",{className:"flex h-32 w-full items-end overflow-hidden rounded bg-muted/60",children:i.jsx("div",{className:`${r} w-full rounded-t transition-all`,style:{height:`${Math.max(6,e.value/a*100)}%`},title:`${e.label}: ${e.value.toLocaleString()}`})})]},e.label))})},v=({data:e,currency:s})=>{if(!e.length)return i.jsx("p",{className:"text-sm text-muted-foreground",children:"No approved costs recorded."});const t=e.reduce((e,s)=>e+(s.amount||0),0)||1;return i.jsx("div",{className:"space-y-3",children:e.map(e=>{const a=Math.round((e.amount||0)/t*100);return i.jsxs("div",{className:"space-y-1",children:[i.jsxs("div",{className:"flex items-center justify-between text-sm font-semibold text-foreground",children:[i.jsx("span",{children:e.category}),i.jsx("span",{children:h(e.amount||0,s)})]}),i.jsx("div",{className:"h-2 w-full overflow-hidden rounded bg-muted",children:i.jsx("div",{className:"h-full rounded bg-primary/80",style:{width:`${a}%`}})}),i.jsxs("p",{className:"text-xs text-muted-foreground",children:[a,"% of tracked spend"]})]},e.category)})})},y=({user:y,addToast:b,onSelectProject:N,setActiveView:w})=>{const[I,k]=c.useState(!0),[P,C]=c.useState({projects:[],kpis:null,monthly:[],costs:[],invoices:[],expenses:[],incidents:[],timesheets:[],forecasts:[],companyName:null,users:[],operationalInsights:null}),[A,$]=c.useState(null),[D,M]=c.useState(!1),[O,R]=c.useState(3),E=c.useRef(null),L=P.kpis?.currency??"GBP",S=c.useCallback(async()=>{if(!y.companyId)return void k(!1);const s=new AbortController;E.current?.abort(),E.current=s,k(!0);try{const[t,a,r,n,i,l,o,c,d,m,x]=await Promise.all([e.getProjectsByCompany(y.companyId,{signal:s.signal}),e.getFinancialKPIsForCompany(y.companyId,{signal:s.signal}),e.getMonthlyFinancials(y.companyId,{signal:s.signal}),e.getCostBreakdown(y.companyId,{signal:s.signal}),e.getInvoicesByCompany(y.companyId,{signal:s.signal}),e.getExpensesByCompany(y.companyId,{signal:s.signal}),e.getUsersByCompany(y.companyId,{signal:s.signal}),e.getTimesheetsByCompany(y.companyId,y.id,{signal:s.signal}),e.getFinancialForecasts(y.companyId,{signal:s.signal}),e.getOperationalInsights(y.companyId,{signal:s.signal}),e.getCompanies({signal:s.signal})]);if(s.signal.aborted)return;const u=await e.getSafetyIncidentsByCompany(y.companyId);if(s.signal.aborted)return;const p=x.find(e=>e.id===y.companyId)?.name??null;C({projects:t,kpis:a,monthly:r,costs:n,invoices:i,expenses:l,incidents:u,timesheets:c,forecasts:d,companyName:p,users:o,operationalInsights:m})}catch(t){if(s.signal.aborted)return;console.error("Failed to load owner dashboard",t),b("Unable to load the executive dashboard right now.","error")}finally{s.signal.aborted||k(!1)}},[y.companyId,y.id,b]);c.useEffect(()=>(S(),()=>E.current?.abort()),[S]);const F=c.useMemo(()=>x(P.projects),[P.projects]),T=c.useMemo(()=>P.projects.map(e=>{const s=e.budget??0,t=e.actualCost??e.spent??0,a=e.progress??0,r=(s>0&&t/s>1.05?1.2:1)*("ON_HOLD"===e.status?1.3:1)*("CANCELLED"===e.status?0:1)*(a<40?1.2:1)*(F.upcomingDeadlines.some(s=>s.id===e.id&&s.isOverdue)?1.3:1);return{project:e,budget:s,actual:t,progress:a,riskScore:r}}).filter(e=>"COMPLETED"!==e.project.status&&"CANCELLED"!==e.project.status).sort((e,s)=>s.riskScore-e.riskScore).slice(0,4),[P.projects,F.upcomingDeadlines]),{outstandingReceivables:B,overdueReceivables:V,invoicePipeline:H}=c.useMemo(()=>P.invoices.reduce((e,t)=>{const{balance:a,total:r}=u(t);e.outstandingReceivables+=a,e.invoicePipeline+=r;return p(t)===s.OVERDUE&&(e.overdueReceivables+=a),e},{outstandingReceivables:0,overdueReceivables:0,invoicePipeline:0}),[P.invoices]),G=c.useMemo(()=>P.expenses.filter(e=>"APPROVED"===e.status||"PAID"===e.status).reduce((e,s)=>e+(s.amount||0),0),[P.expenses]),z=c.useMemo(()=>P.expenses.filter(e=>"APPROVED"===e.status||"PAID"===e.status),[P.expenses]),U=c.useMemo(()=>z.reduce((e,s)=>e+(s.amount||0),0),[z]),_=c.useMemo(()=>P.incidents.filter(e=>e.status!==t.RESOLVED),[P.incidents]),W=c.useMemo(()=>_.filter(e=>e.severity===a.HIGH||e.severity===a.CRITICAL),[_]);c.useMemo(()=>_.filter(e=>e.severity===a.HIGH||e.severity===a.CRITICAL),[_]);const J=c.useMemo(()=>{const e=P.timesheets.filter(e=>e.status!==r.DRAFT);if(!e.length)return 0;const s=e.filter(e=>e.status===r.APPROVED).length;return g(s/e.length*100)},[P.timesheets]),K=c.useMemo(()=>P.monthly.slice(-6).map(e=>({label:e.month,value:e.revenue})),[P.monthly]),q=c.useMemo(()=>P.monthly.slice(-6).map(e=>({label:e.month,value:e.profit})),[P.monthly]),Q=P.operationalInsights,X=Q?.financial.currency??L,Y=Q?.safety.openIncidents??_.length,Z=Q?.safety.highSeverity??W.length,ee=Q?.safety.daysSinceLastIncident??null,se=Q?.financial.approvedExpensesThisMonth??G,te=Q?.financial.burnRatePerActiveProject??null,ae=Q?.workforce.activeTimesheets??0,re=Q?.workforce.pendingApprovals??0,ne=Q?.workforce.approvedThisWeek??0,ie=Q?.workforce.overtimeHours??null,le=Q?.alerts??[],oe=P.forecasts[0]??null,ce=P.forecasts.slice(1,4),de=c.useCallback(async s=>{if(y.companyId){M(!0),$(null);try{const t=await n({companyName:P.companyName??"Portfolio",currency:L,horizonMonths:s,kpis:P.kpis,monthly:P.monthly,costs:P.costs,invoices:P.invoices,expenses:P.expenses}),a=await e.createFinancialForecast({companyId:y.companyId,summary:t.summary,horizonMonths:s,metadata:{...t.metadata,source:"owner-dashboard"},model:t.model},y.id);C(e=>({...e,forecasts:[a,...e.forecasts]})),b("Executive outlook refreshed.","success")}catch(t){console.error("Failed to generate financial forecast",t),$("Unable to generate the AI outlook right now."),b("Could not generate the AI briefing.","error")}finally{M(!1)}}},[y.companyId,y.id,P.companyName,P.kpis,P.monthly,P.costs,P.invoices,P.expenses,L,b]);return I?i.jsx(l,{children:"Loading executive overview…"}):i.jsxs("div",{className:"space-y-6",children:[i.jsx(m,{title:"Executive control centre",description:"Monitor the commercial pulse and operational risk across the portfolio.",actions:w?i.jsx(o,{variant:"secondary",onClick:()=>w("financials"),children:"Open financial workspace"}):void 0,meta:[{label:"Portfolio value",value:h(F.pipelineValue,L),helper:`${F.totalProjects} active engagements`},{label:"At-risk projects",value:`${T.length}`,helper:`${F.atRiskProjects} budget alerts`+(F.overdueProjects?` • ${F.overdueProjects} overdue`:""),indicator:F.atRiskProjects>0||F.overdueProjects>0?"warning":"positive"},{label:"Outstanding receivables",value:h(B,L),helper:V>0?`${h(V,L)} overdue`:"All current",indicator:B>0?"warning":"positive"},{label:"Workforce",value:`${P.users.length}`,helper:J>0?`${J}% approvals${ae?` • ${ae} clocked in`:""}`:ae?`${ae} team members clocked in`:"No approvals submitted",indicator:J<80?"warning":ae>0?"positive":"neutral"}]}),i.jsxs("section",{className:"grid gap-6 xl:grid-cols-[2fr,1fr]",children:[i.jsxs(l,{className:"space-y-6 p-6",children:[i.jsxs("div",{className:"flex flex-col gap-2",children:[i.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Financial pulse"}),i.jsx("p",{className:"text-sm text-muted-foreground",children:"Revenue momentum and profitability signals over the last six months."})]}),i.jsx(j,{data:K,accent:"primary",emptyLabel:"No revenue history captured."}),i.jsx(j,{data:q,accent:"emerald",emptyLabel:"No profit history captured."})]}),i.jsxs(l,{className:"space-y-4 p-6",children:[i.jsxs("div",{className:"flex flex-col gap-2",children:[i.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Operational signals"}),i.jsx("p",{className:"text-sm text-muted-foreground",children:"Live risk and workforce telemetry."})]}),i.jsxs("div",{className:"space-y-3 text-sm",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{className:"text-muted-foreground",children:"Open incidents"}),i.jsxs("span",{className:"font-semibold text-foreground",children:[Y,Z>0&&i.jsxs("span",{className:"text-xs font-medium text-destructive",children:[" • ",Z," high"]})]})]}),i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{className:"text-muted-foreground",children:"Days since last incident"}),i.jsx("span",{className:"font-semibold text-foreground",children:null===ee?"—":0===ee?"Today":`${ee} day${1===ee?"":"s"}`})]}),i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{className:"text-muted-foreground",children:"Approved expense run rate"}),i.jsx("span",{className:"font-semibold text-foreground",children:h(U,L)})]}),i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{className:"text-muted-foreground",children:"Timesheet compliance"}),i.jsxs("span",{className:"font-semibold "+(J<80?"text-amber-600":"text-foreground"),children:[J,"%"]})]}),i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{className:"text-muted-foreground",children:"Pending approvals"}),i.jsx("span",{className:"font-semibold text-foreground",children:re})]}),i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{className:"text-muted-foreground",children:"Approved cost this month"}),i.jsx("span",{className:"font-semibold text-foreground",children:h(se,X)}),i.jsxs("span",{className:"font-semibold text-foreground",children:[J,"%"]})]}),i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsx("span",{className:"text-muted-foreground",children:"Invoice pipeline"}),i.jsx("span",{className:"font-semibold text-foreground",children:h(H,X)})]})]}),Q&&i.jsxs("p",{className:"text-xs text-muted-foreground",children:["Burn per active project: ",h(te??0,X),ie&&ie>0?` • ${ie.toFixed(1)} overtime hrs`:""]}),le.length>0&&i.jsxs("div",{className:"space-y-2 rounded-md border border-amber-500/40 bg-amber-500/10 p-3",children:[i.jsx("p",{className:"text-xs font-semibold uppercase tracking-wide text-amber-700",children:"Action items"}),i.jsx("ul",{className:"space-y-1 text-sm text-foreground",children:le.map(e=>i.jsxs("li",{className:"flex items-start gap-2",children:[i.jsx("span",{className:"mt-1 h-2 w-2 rounded-full "+("critical"===e.severity?"bg-destructive":"warning"===e.severity?"bg-amber-500":"bg-primary")}),i.jsx("span",{className:"text-muted-foreground",children:e.message})]},e.id))})]}),i.jsxs("div",{className:"space-y-2",children:[i.jsx("h3",{className:"text-sm font-semibold text-muted-foreground",children:"Approved cost mix"}),i.jsx(v,{data:P.costs,currency:X})]})]})]}),i.jsxs("section",{className:"grid gap-6 lg:grid-cols-2 xl:grid-cols-3",children:[i.jsxs(l,{className:"space-y-4 p-6",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Focus projects"}),i.jsx("p",{className:"text-sm text-muted-foreground",children:"Jobs with the highest commercial or delivery risk."})]}),i.jsx(o,{variant:"ghost",size:"sm",onClick:()=>w?.("projects"),children:"View all"})]}),0===T.length?i.jsx("p",{className:"text-sm text-muted-foreground",children:"All live projects are currently steady."}):i.jsx("div",{className:"space-y-4",children:T.map(({project:e,budget:s,actual:t,progress:a})=>i.jsxs("div",{className:"space-y-2 rounded-lg border border-border/60 p-3",children:[i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("p",{className:"font-semibold text-foreground",children:e.name}),i.jsx("p",{className:"text-xs text-muted-foreground",children:e.location?.city??e.location?.address})]}),i.jsx(d,{label:e.status.replace(/_/g," "),color:"ACTIVE"===e.status?"green":"ON_HOLD"===e.status?"yellow":"red"})]}),i.jsxs("div",{className:"grid grid-cols-3 gap-3 text-xs text-muted-foreground",children:[i.jsxs("div",{children:[i.jsx("p",{children:"Budget"}),i.jsx("p",{className:"font-semibold text-foreground",children:h(s,L)})]}),i.jsxs("div",{children:[i.jsx("p",{children:"Actual"}),i.jsx("p",{className:"font-semibold text-foreground",children:h(t,L)})]}),i.jsxs("div",{children:[i.jsx("p",{children:"Progress"}),i.jsxs("p",{className:"font-semibold text-foreground",children:[g(a),"%"]})]})]}),i.jsx(o,{size:"sm",onClick:()=>N(e),children:"Inspect project"})]},e.id))})]}),i.jsxs(l,{className:"space-y-4 p-6",children:[i.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Upcoming deadlines"}),0===F.upcomingDeadlines.length?i.jsx("p",{className:"text-sm text-muted-foreground",children:"No delivery deadlines in the next few weeks."}):i.jsx("ul",{className:"space-y-3 text-sm",children:F.upcomingDeadlines.map(e=>{const s=`${new Date(e.endDate).toLocaleDateString()} • ${e.isOverdue?"Overdue":"Due soon"}`;return i.jsxs("li",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("p",{className:"font-semibold text-foreground",children:e.name}),i.jsx("p",{className:"text-xs "+(e.isOverdue?"text-destructive":"text-muted-foreground"),children:s})]}),i.jsx(d,{label:`${g(e.daysRemaining<0?0:e.daysRemaining)}d`,color:e.isOverdue?"red":"blue"})]},e.id)})})]}),i.jsxs(l,{className:"space-y-4 p-6",children:[i.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Collections"}),0===P.invoices.length?i.jsx("p",{className:"text-sm text-muted-foreground",children:"No invoices have been raised yet."}):i.jsx("ul",{className:"space-y-3 text-sm",children:P.invoices.filter(e=>p(e)!==s.PAID).sort((e,s)=>u(s).balance-u(e).balance).slice(0,4).map(e=>{const{balance:t}=u(e),a=p(e);return i.jsxs("li",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("p",{className:"font-semibold text-foreground",children:e.invoiceNumber??e.id}),i.jsx("p",{className:"text-xs text-muted-foreground",children:e.clientId})]}),i.jsxs("div",{className:"text-right",children:[i.jsx("p",{className:"font-semibold text-foreground",children:h(t,L)}),i.jsx("p",{className:"text-xs "+(a===s.OVERDUE?"text-destructive":"text-muted-foreground"),children:a})]})]},e.id)})})]})]}),i.jsxs("section",{className:"grid gap-6 xl:grid-cols-[2fr,1fr]",children:[i.jsxs(l,{className:"space-y-4 p-6",children:[i.jsxs("div",{className:"flex flex-col gap-2",children:[i.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"AI executive briefing"}),i.jsx("p",{className:"text-sm text-muted-foreground",children:"Summarise the commercial outlook using Gemini with live ledger data."})]}),i.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[i.jsx("label",{className:"text-sm font-medium text-muted-foreground",htmlFor:"owner-brief-horizon",children:"Horizon"}),i.jsxs("select",{id:"owner-brief-horizon",value:O,onChange:e=>R(Number(e.target.value)),className:"rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary",disabled:D,children:[i.jsx("option",{value:3,children:"Next 3 months"}),i.jsx("option",{value:6,children:"Next 6 months"}),i.jsx("option",{value:12,children:"Next 12 months"})]}),i.jsx(o,{onClick:()=>de(O),isLoading:D,disabled:D,children:oe?"Refresh briefing":"Generate briefing"})]}),A&&i.jsx("p",{className:"text-sm text-destructive",children:A}),oe?i.jsxs("div",{className:"space-y-4",children:[i.jsx("div",{className:"space-y-2",children:f(oe.summary)}),i.jsxs("p",{className:"text-xs text-muted-foreground",children:["Generated ",new Date(oe.createdAt).toLocaleString(),oe.model?` • ${oe.model}`:"",oe.metadata?.isFallback?" • Offline summary":""]})]}):i.jsx("p",{className:"text-sm text-muted-foreground",children:"Run the assistant to get an actionable runway and profitability update for leadership."}),ce.length>0&&i.jsxs("details",{className:"rounded-md border border-border/60 bg-muted/40 p-3 text-sm",children:[i.jsx("summary",{className:"cursor-pointer font-semibold text-muted-foreground",children:"Previous briefings"}),i.jsx("div",{className:"mt-3 space-y-3 max-h-40 overflow-y-auto pr-1",children:ce.map(e=>i.jsxs("div",{className:"rounded border border-border/60 bg-background/80 p-3",children:[i.jsxs("p",{className:"text-xs text-muted-foreground",children:[new Date(e.createdAt).toLocaleString(),e.model?` • ${e.model}`:""]}),i.jsx("div",{className:"mt-2 space-y-1",children:f(e.summary)})]},e.id))})]})]}),i.jsxs(l,{className:"space-y-4 p-6",children:[i.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Workforce snapshot"}),Q&&i.jsxs("p",{className:"text-xs text-muted-foreground",children:[ne," approvals cleared this week • ",re," awaiting sign-off"]}),0===P.users.length?i.jsx("p",{className:"text-sm text-muted-foreground",children:"No team members recorded for this company."}):i.jsx("ul",{className:"space-y-3 text-sm",children:P.users.slice(0,6).map(e=>i.jsxs("li",{className:"flex items-center justify-between",children:[i.jsxs("div",{children:[i.jsx("p",{className:"font-semibold text-foreground",children:`${e.firstName} ${e.lastName}`}),i.jsx("p",{className:"text-xs text-muted-foreground",children:e.role})]}),i.jsx(d,{label:e.availability??"Unknown",color:"ON_PROJECT"===e.availability?"blue":"ON_LEAVE"===e.availability?"gray":"green"})]},e.id))})]})]})]})};export{y as OwnerDashboard};
