import{a as e,h as s,P as a,j as t,C as r,B as l,R as n,A as i,b as d}from"./index-D85gtc9V.js";import{r as o}from"./leaflet-QxLtkkBL.js";import{T as c}from"./Tag-CPyoOo4I.js";import"./react-Z2Iecplj.js";import"./genai-DmvHCT3V.js";const m={[d.AVAILABLE]:"green",[d.ON_PROJECT]:"blue",[d.ON_LEAVE]:"gray"},x=({loggedInUser:m,member:x,projects:u,allAssignments:g,onClose:p,onSuccess:h,addToast:b,onStartChat:j})=>{const[f,N]=o.useState({}),[v,y]=o.useState(new Set),[A,C]=o.useState(null),[k,S]=o.useState("details"),[w,E]=o.useState(""),[I,P]=o.useState(!1),[L,T]=o.useState(""),M=!x,_=s(m,a.MANAGE_TEAM);o.useEffect(()=>{const s=M?{role:n.OPERATIVE,availability:d.AVAILABLE,skills:[]}:{...x};if(N(s),x){const s=g.filter(e=>e.userId===x.id).map(e=>e.projectId);y(new Set(s)),e.getUserPerformanceMetrics(x.id).then(C)}else y(new Set),C(null)},[x,g,M]);const U=(e,s)=>{N(a=>({...a,[e]:s}))},R=()=>{w&&!f.skills?.includes(w)&&(U("skills",[...f.skills||[],w]),E(""))},$=(e,s,a,r=!0)=>t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-muted-foreground",children:e}),_&&r?t.jsx("input",{type:s,value:String(f[a]||""),onChange:e=>U(a,e.target.value),className:"w-full p-2 border rounded bg-background"}):t.jsx("p",{className:"p-2 text-foreground",children:String(f[a]||"N/A")})]}),B=(e,s,a)=>t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-muted-foreground",children:e}),_?t.jsx("select",{value:String(f[s]||""),onChange:e=>U(s,e.target.value),className:"w-full p-2 border rounded bg-background",children:a.map(e=>t.jsx("option",{value:e,children:e.replace(/_/g," ")},e))}):t.jsx("p",{className:"p-2 text-foreground",children:String(f[s]||"N/A").replace(/_/g," ")})]});return t.jsx("div",{className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",onClick:p,children:t.jsx("form",{onSubmit:async s=>{s.preventDefault(),P(!0);try{M?(await e.createUser(f,m.id),b("Team member added.","success")):x&&(await e.updateUser(x.id,f,Array.from(v),m.id),b("Profile updated.","success")),h(),p()}catch(a){b(a instanceof Error?a.message:"Failed to save changes.","error")}finally{P(!1)}},className:"w-full max-w-4xl",onClick:e=>e.stopPropagation(),children:t.jsxs(r,{children:[t.jsxs("div",{className:"flex gap-6",children:[t.jsxs("div",{className:"w-1/3 text-center",children:[t.jsx(i,{name:`${f.firstName||""} ${f.lastName||""}`.trim()||"?",imageUrl:f.avatar,className:"w-32 h-32 mx-auto mb-4 text-4xl"}),_&&t.jsx(l,{type:"button",variant:"secondary",size:"sm",children:"Upload Photo"}),t.jsx("h3",{className:"font-bold text-2xl mt-4",children:`${f.firstName||""} ${f.lastName||""}`.trim()}),t.jsx("p",{className:"text-muted-foreground",children:f.email}),!M&&m.id!==x.id&&s(m,a.SEND_DIRECT_MESSAGE)&&t.jsx(l,{size:"sm",className:"mt-4 w-full",onClick:()=>j(x),children:"Message"})]}),t.jsxs("div",{className:"w-2/3",children:[t.jsx("div",{className:"border-b",children:t.jsxs("nav",{className:"-mb-px flex space-x-4",children:[t.jsx("button",{type:"button",onClick:()=>S("details"),className:"py-2 px-1 border-b-2 text-sm "+("details"===k?"border-primary text-primary":"border-transparent text-muted-foreground hover:text-foreground"),children:"Details"}),!M&&t.jsx("button",{type:"button",onClick:()=>S("performance"),className:"py-2 px-1 border-b-2 text-sm "+("performance"===k?"border-primary text-primary":"border-transparent text-muted-foreground hover:text-foreground"),children:"Performance"}),!M&&t.jsx("button",{type:"button",onClick:()=>S("assignments"),className:"py-2 px-1 border-b-2 text-sm "+("assignments"===k?"border-primary text-primary":"border-transparent text-muted-foreground hover:text-foreground"),children:"Assignments"})]})}),t.jsxs("div",{className:"pt-4",children:["details"===k&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[$("First Name","text","firstName"),$("Last Name","text","lastName"),$("Email","email","email",M),$("Phone","tel","phone"),B("Role","role",Object.values(n).filter(e=>e!==n.PRINCIPAL_ADMIN)),B("Availability","availability",Object.values(d))]}),t.jsxs("div",{className:"mt-4",children:[t.jsx("label",{className:"block text-sm font-medium text-muted-foreground",children:"Skills"}),t.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:f.skills?.map(e=>t.jsx(c,{label:e,onDoubleClick:_?()=>(e=>{U("skills",f.skills?.filter(s=>s!==e))})(e):void 0},e))}),_&&t.jsxs("div",{className:"flex gap-2 mt-2",children:[t.jsx("input",{value:w,onChange:e=>E(e.target.value),placeholder:"Add a skill",className:"flex-grow p-1 border rounded bg-background"}),t.jsx(l,{type:"button",size:"sm",variant:"secondary",onClick:R,children:"Add"})]})]})]}),"performance"===k&&t.jsx("div",{className:"space-y-4",children:t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs(r,{className:"text-center",children:[t.jsx("p",{className:"text-sm",children:"Total Hours Logged"}),t.jsx("p",{className:"text-3xl font-bold",children:A?.totalHours||0})]}),t.jsxs(r,{className:"text-center",children:[t.jsx("p",{className:"text-sm",children:"Tasks Completed"}),t.jsx("p",{className:"text-3xl font-bold",children:A?.tasksCompleted||0})]})]})}),"assignments"===k&&(()=>{const e=u.filter(e=>v.has(e.id)),s=u.filter(e=>e.name.toLowerCase().includes(L.toLowerCase()));return t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("h4",{className:"font-semibold text-muted-foreground mb-2",children:"Currently Assigned Projects"}),e.length>0?t.jsx("div",{className:"flex flex-wrap gap-2",children:e.map(e=>t.jsx(c,{label:e.name,color:"blue"},e.id))}):t.jsx("p",{className:"text-sm text-muted-foreground",children:"Not assigned to any projects."})]}),_&&t.jsxs("div",{className:"pt-4 border-t",children:[t.jsx("h4",{className:"font-semibold text-muted-foreground mb-2",children:"Edit Assignments"}),t.jsx("input",{type:"text",placeholder:"Search projects to assign...",value:L,onChange:e=>T(e.target.value),className:"w-full p-2 border rounded bg-background mb-2"}),t.jsx("div",{className:"space-y-2 max-h-48 overflow-y-auto pr-2",children:s.map(e=>t.jsxs("div",{className:"flex items-center justify-between p-2 rounded hover:bg-accent",children:[t.jsx("label",{htmlFor:`proj-${e.id}`,className:"font-medium cursor-pointer flex-grow",children:e.name}),t.jsx("input",{type:"checkbox",id:`proj-${e.id}`,checked:v.has(e.id),onChange:()=>{return s=e.id,void y(e=>{const a=new Set(e);return a.has(s)?a.delete(s):a.add(s),a});var s},className:"h-4 w-4 text-primary focus:ring-ring border-border rounded"})]},e.id))})]})]})})()]})]})]}),t.jsxs("div",{className:"flex justify-end gap-2 mt-6 pt-4 border-t",children:[t.jsx(l,{type:"button",variant:"secondary",onClick:p,children:"Cancel"}),_&&t.jsx(l,{type:"submit",isLoading:I,children:M?"Add Member":"Save Changes"})]})]})})})},u=({user:u,addToast:g,onStartChat:p})=>{const[h,b]=o.useState([]),[j,f]=o.useState([]),[N,v]=o.useState([]),[y,A]=o.useState(!0),[C,k]=o.useState(null),S=o.useRef(null),w=o.useCallback(async()=>{const s=new AbortController;S.current?.abort(),S.current=s,A(!0);try{if(!u.companyId)return;const[a,t,r]=await Promise.all([e.getUsersByCompany(u.companyId,{signal:s.signal}),e.getProjectsByCompany(u.companyId,{signal:s.signal}),e.getProjectAssignmentsByCompany(u.companyId,{signal:s.signal})]);if(s.signal.aborted)return;if(b(a),s.signal.aborted)return;if(f(t),s.signal.aborted)return;v(r)}catch(a){if(s.signal.aborted)return;g("Failed to load team data.","error")}finally{if(s.signal.aborted)return;A(!1)}},[u.companyId,g]);o.useEffect(()=>(w(),()=>{S.current?.abort()}),[w]);const E=s(u,a.MANAGE_TEAM);return y?t.jsx(r,{children:t.jsx("p",{children:"Loading team members..."})}):t.jsxs("div",{className:"space-y-6",children:[C&&t.jsx(x,{loggedInUser:u,member:"edit"===C.mode?C.member:null,projects:j,allAssignments:N,onClose:()=>k(null),onSuccess:w,addToast:g,onStartChat:p}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("h2",{className:"text-3xl font-bold text-foreground",children:"Team Members"}),E&&t.jsx(l,{onClick:()=>k({mode:"add"}),children:"Add Member"})]}),t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6",children:h.filter(e=>e.role!==n.PRINCIPAL_ADMIN).map(e=>{const s=`${e.firstName} ${e.lastName}`;return t.jsxs(r,{onClick:()=>k({mode:"edit",member:e}),className:"text-center animate-card-enter cursor-pointer hover:shadow-lg hover:-translate-y-1 transition-transform",children:[t.jsx(i,{name:s,imageUrl:e.avatar,className:"w-24 h-24 mx-auto mb-4"}),t.jsx("h3",{className:"font-bold text-lg",children:s}),t.jsx("p",{className:"text-sm text-muted-foreground",children:e.role.replace(/_/g," ")}),t.jsx("div",{className:"mt-2",children:t.jsx(c,{label:(e.availability||"Unknown").replace(/_/g," "),color:m[e.availability||d.AVAILABLE]})})]},e.id)})})]})};export{u as TeamView};
