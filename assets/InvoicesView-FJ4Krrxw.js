import{a as e,c as t,j as s,B as a,C as r}from"./index-D85gtc9V.js";import{r as l}from"./leaflet-QxLtkkBL.js";import{I as n}from"./StatusBadge-DqYvwqgD.js";import{T as i}from"./Tag-CPyoOo4I.js";import{V as o}from"./ViewHeader-B8uhkq6P.js";import{g as d,a as c}from"./finance-C6WgNQzT.js";import{d as m,f as u}from"./dateFns-RCDwAoDQ.js";import"./react-Z2Iecplj.js";import"./genai-DmvHCT3V.js";const x=[{id:"ALL",label:"All"},{id:t.DRAFT,label:"Draft"},{id:t.SENT,label:"Sent"},{id:t.OVERDUE,label:"Overdue"},{id:t.PAID,label:"Paid"},{id:t.CANCELLED,label:"Cancelled"}],p={[t.OVERDUE]:0,[t.SENT]:1,[t.DRAFT]:2,[t.PAID]:3,[t.CANCELLED]:4},h=e=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(e||0),g=e=>{if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?"—":u(t,"d MMM yyyy")},f=e=>e.dueAt||e.dueDate,b=e=>e.issuedAt||e.issueDate,j=e=>{if(!e)return null;const t=new Date(e).getTime();return Number.isNaN(t)?null:t},v=e=>j(f(e)),N=e=>j(b(e)),y=e=>{const t=v(e);if(null===t)return{label:"No due date",color:"gray"};const s=m(new Date(t),new Date);return s>0?s<=3?{label:`${s} day${1===s?"":"s"} remaining`,color:"yellow"}:{label:`${s} day${1===s?"":"s"} remaining`,color:"green"}:0===s?{label:"Due today",color:"yellow"}:{label:`${Math.abs(s)} day${1===Math.abs(s)?"":"s"} overdue`,color:"red"}},w=({title:e,value:t,helper:a,tone:l="default"})=>s.jsxs(r,{className:"relative overflow-hidden",children:[s.jsx("span",{className:`absolute inset-x-0 top-0 h-1 ${{default:"bg-primary/30",warning:"bg-yellow-400/80",success:"bg-green-500/80",danger:"bg-red-500/80"}[l]}`,"aria-hidden":"true"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:e}),s.jsx("p",{className:"mt-3 text-3xl font-bold tracking-tight",children:t}),a&&s.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:a})]}),C=({user:m,addToast:u})=>{const[j,C]=l.useState([]),[E,D]=l.useState([]),[L,A]=l.useState([]),[R,I]=l.useState(!0),[k,S]=l.useState(""),[T,F]=l.useState("ALL"),[M,P]=l.useState(null),[B,O]=l.useState(""),[$,z]=l.useState("BANK_TRANSFER"),[U,V]=l.useState(!1),[_,q]=l.useState(!1),G=l.useRef(null),K=l.useCallback(async(t=!1)=>{const s=new AbortController;if(G.current?.abort(),G.current=s,t&&I(!0),!m.companyId)return s.signal.aborted?null:(C([]),s.signal.aborted?null:(D([]),s.signal.aborted||(A([]),t&&!s.signal.aborted&&I(!1)),null));try{const[t,a,r]=await Promise.all([e.getInvoicesByCompany(m.companyId,{signal:s.signal}),e.getProjectsByCompany(m.companyId,{signal:s.signal}),e.getClientsByCompany(m.companyId,{signal:s.signal})]);return s.signal.aborted?null:(C(t),s.signal.aborted?null:(D(a),s.signal.aborted?null:(A(r),{invoiceData:t,projectData:a,clientData:r})))}catch(a){return console.error("Failed to load invoices",a),s.signal.aborted||u("Failed to load invoices.","error"),null}finally{t&&!s.signal.aborted&&I(!1)}},[m.companyId,u]);l.useEffect(()=>(K(!0),()=>{G.current?.abort()}),[K]),l.useEffect(()=>{M&&!j.some(e=>e.id===M)&&P(null)},[M,j]);const H=l.useMemo(()=>new Map(E.map(e=>[e.id,e.name])),[E]),X=l.useMemo(()=>new Map(L.map(e=>[e.id,e.name])),[L]),Q=l.useMemo(()=>M?j.find(e=>e.id===M)??null:null,[j,M]);l.useEffect(()=>{if(!Q)return void O("");const{balance:e}=d(Q);O(e>0?e.toFixed(2):""),z("BANK_TRANSFER")},[Q]);const J=l.useMemo(()=>{let e=0,s=0,a=0,r=0,l=0,n=0;const i=new Date;i.setDate(i.getDate()-30),j.forEach(o=>{const{total:m,amountPaid:u,balance:x,payments:p}=d(o);l+=m,n+=u,o.status===t.DRAFT&&(a+=1),o.status!==t.CANCELLED&&x>0&&(e+=x),c(o)===t.OVERDUE&&(s+=x),(p||[]).forEach(e=>{const t=new Date(e.date);!Number.isNaN(t.getTime())&&t>=i&&(r+=e.amount)})});const o=l>0?Math.round(n/l*100):0;return{outstanding:e,overdue:s,draft:a,paidLast30:r,collectionRate:o}},[j]),W=l.useMemo(()=>{const e={ALL:j.length,[t.DRAFT]:0,[t.SENT]:0,[t.OVERDUE]:0,[t.PAID]:0,[t.CANCELLED]:0};return j.forEach(t=>{const s=c(t);e[s]=(e[s]??0)+1}),e.ALL=j.length,e},[j]),Y=l.useMemo(()=>{const e=k.trim().toLowerCase();return j.filter(e=>"ALL"===T||c(e)===T).filter(t=>{if(!e)return!0;const s=H.get(t.projectId)??"",a=X.get(t.clientId)??"";return t.invoiceNumber.toLowerCase().includes(e)||s.toLowerCase().includes(e)||a.toLowerCase().includes(e)}).sort((e,t)=>{const s=p[c(e)]-p[c(t)];if(0!==s)return s;const a=v(e)??Number.MAX_SAFE_INTEGER,r=v(t)??Number.MAX_SAFE_INTEGER;if(a!==r)return a-r;const l=N(e)??0;return(N(t)??0)-l})},[j,T,k,H,X]),Z=()=>{S(""),F("ALL")},ee=async s=>{if(Q){if(s===t.CANCELLED){if(!window.confirm("Are you sure you want to cancel this invoice? This action cannot be undone."))return}q(!0);try{await e.updateInvoice(Q.id,{...Q,status:s},m.id),u(`Invoice marked as ${s.toLowerCase()}.`,"success"),await K()}catch(a){console.error("Failed to update invoice status",a),u("Failed to update invoice status.","error")}finally{q(!1)}}},te=Q?c(Q):null,se=Q?d(Q):null,ae=Q?y(Q):null,re=J.collectionRate>=90?"positive":J.collectionRate>=75?"warning":"negative";return s.jsxs("div",{className:"relative space-y-6",children:[Q&&s.jsxs("div",{className:"fixed inset-0 z-50 flex",children:[s.jsx("div",{className:"flex-1 bg-black/50",onClick:()=>P(null),"aria-hidden":"true"}),s.jsxs("div",{className:"relative h-full w-full max-w-xl overflow-y-auto border-l border-border bg-background p-6 shadow-2xl",children:[s.jsxs("div",{className:"flex items-start justify-between gap-4",children:[s.jsxs("div",{children:[s.jsxs("h2",{className:"text-2xl font-bold",children:["Invoice ",Q.invoiceNumber]}),s.jsxs("p",{className:"mt-1 text-sm text-muted-foreground",children:[X.get(Q.clientId)||"Client unavailable"," ·"," ",H.get(Q.projectId)||"Project unavailable"]}),s.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2 text-xs text-muted-foreground",children:[s.jsxs("span",{children:["Issued ",g(b(Q))]}),s.jsx("span",{className:"h-1 w-1 rounded-full bg-border"}),s.jsxs("span",{children:["Due ",g(f(Q))]}),ae&&s.jsx(i,{label:ae.label,color:ae.color})]})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[te&&s.jsx(n,{status:te}),s.jsx("button",{type:"button",onClick:()=>P(null),className:"rounded-full p-2 text-muted-foreground hover:bg-muted","aria-label":"Close details",children:s.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:s.jsx("path",{fillRule:"evenodd",d:"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z",clipRule:"evenodd"})})})]})]}),se&&s.jsxs("div",{className:"mt-6 grid gap-4 sm:grid-cols-3",children:[s.jsxs("div",{className:"rounded-lg border border-border bg-muted/40 p-4",children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:"Total"}),s.jsx("p",{className:"mt-1 text-lg font-semibold",children:h(se.total)})]}),s.jsxs("div",{className:"rounded-lg border border-border bg-muted/40 p-4",children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:"Paid"}),s.jsx("p",{className:"mt-1 text-lg font-semibold text-green-600",children:h(se.amountPaid)})]}),s.jsxs("div",{className:"rounded-lg border border-border bg-muted/40 p-4",children:[s.jsx("p",{className:"text-xs text-muted-foreground",children:"Balance due"}),s.jsx("p",{className:"mt-1 text-lg font-semibold text-red-600",children:h(se.balance)})]})]}),s.jsxs("div",{className:"mt-8 space-y-6",children:[s.jsxs("div",{children:[s.jsx("h3",{className:"text-sm font-semibold uppercase tracking-wide text-muted-foreground",children:"Line items"}),s.jsx("div",{className:"mt-3 overflow-hidden rounded-lg border border-border",children:(Q.lineItems||[]).length>0?s.jsxs("table",{className:"min-w-full text-sm",children:[s.jsx("thead",{className:"bg-muted/60 text-xs uppercase text-muted-foreground",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-4 py-2 text-left font-medium",children:"Description"}),s.jsx("th",{className:"px-4 py-2 text-right font-medium",children:"Quantity"}),s.jsx("th",{className:"px-4 py-2 text-right font-medium",children:"Unit price"}),s.jsx("th",{className:"px-4 py-2 text-right font-medium",children:"Line total"})]})}),s.jsx("tbody",{className:"divide-y divide-border bg-card",children:Q.lineItems.map(e=>s.jsxs("tr",{children:[s.jsx("td",{className:"px-4 py-2",children:e.description}),s.jsx("td",{className:"px-4 py-2 text-right",children:e.quantity}),s.jsx("td",{className:"px-4 py-2 text-right",children:h(e.unitPrice??e.rate)}),s.jsx("td",{className:"px-4 py-2 text-right",children:h((Number(e.quantity)||0)*(Number(e.unitPrice??e.rate)||0))})]},e.id))})]}):s.jsx("p",{className:"px-4 py-6 text-sm text-muted-foreground",children:"No line items recorded for this invoice."})})]}),s.jsxs("div",{children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h3",{className:"text-sm font-semibold uppercase tracking-wide text-muted-foreground",children:"Payment history"}),se&&se.balance>0&&te!==t.CANCELLED&&s.jsx(a,{size:"sm",variant:"secondary",onClick:()=>O(se.balance.toFixed(2)),children:"Fill balance"})]}),s.jsx("div",{className:"mt-3 space-y-3",children:se&&se.payments.length>0?se.payments.slice().sort((e,t)=>new Date(t.date).getTime()-new Date(e.date).getTime()).map(e=>s.jsxs("div",{className:"rounded-lg border border-border bg-card px-4 py-3 text-sm shadow-sm",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("p",{className:"font-medium",children:h(e.amount)}),s.jsx("span",{className:"text-xs text-muted-foreground",children:g(e.date)})]}),s.jsxs("p",{className:"mt-1 text-xs text-muted-foreground capitalize",children:[e.method.replace("_"," ").toLowerCase(),e.reference?` · Ref ${e.reference}`:""]})]},e.id)):s.jsx("p",{className:"text-sm text-muted-foreground",children:"No payments recorded yet."})}),se&&se.balance>0&&te!==t.CANCELLED&&s.jsxs("form",{onSubmit:async t=>{if(t.preventDefault(),!Q)return;const s=Number(B);if(!s||s<=0)return void u("Enter a valid payment amount.","error");const{balance:a}=d(Q);if(s>a)u("Amount exceeds outstanding balance.","error");else{V(!0);try{await e.recordPaymentForInvoice(Q.id,{amount:s,method:$},m.id),u("Payment recorded.","success"),await K()}catch(r){console.error("Failed to record payment",r),u("Failed to record payment.","error")}finally{V(!1)}}},className:"mt-4 space-y-3 rounded-lg border border-dashed border-border p-4",children:[s.jsx("p",{className:"text-sm font-medium",children:"Record a payment"}),s.jsxs("div",{className:"grid gap-3 sm:grid-cols-[1fr,180px]",children:[s.jsxs("label",{className:"text-sm",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"Amount"}),s.jsx("input",{type:"number",step:"0.01",min:"0",value:B,onChange:e=>O(e.target.value),className:"mt-1 w-full rounded-md border border-border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/40",placeholder:"0.00"})]}),s.jsxs("label",{className:"text-sm",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:"Method"}),s.jsxs("select",{value:$,onChange:e=>z(e.target.value),className:"mt-1 w-full rounded-md border border-border bg-background px-3 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/40",children:[s.jsx("option",{value:"BANK_TRANSFER",children:"Bank transfer"}),s.jsx("option",{value:"CREDIT_CARD",children:"Card"}),s.jsx("option",{value:"CASH",children:"Cash"}),s.jsx("option",{value:"CHECK",children:"Cheque"})]})]})]}),s.jsxs("div",{className:"flex justify-end gap-2",children:[s.jsx(a,{type:"button",variant:"ghost",size:"sm",onClick:()=>O(se.balance.toFixed(2)),children:"Use balance"}),s.jsx(a,{type:"submit",size:"sm",isLoading:U,children:"Record payment"})]})]})]}),s.jsxs("div",{className:"flex flex-wrap gap-2",children:[te===t.DRAFT&&s.jsx(a,{variant:"success",size:"sm",isLoading:_,onClick:()=>ee(t.SENT),children:"Mark as sent"}),te&&[t.SENT,t.OVERDUE].includes(te)&&s.jsx(a,{variant:"danger",size:"sm",isLoading:_,onClick:()=>ee(t.CANCELLED),children:"Cancel invoice"})]})]})]})]}),s.jsx(o,{view:"invoices",actions:s.jsx(a,{variant:"secondary",onClick:()=>u("Invoice creation is available from the Financials workspace.","success"),children:"New invoice"}),meta:[{label:"Outstanding balance",value:h(J.outstanding),helper:J.outstanding>0?"Across open invoices":"All invoices settled",indicator:J.outstanding>0?"warning":"positive"},{label:"Overdue exposure",value:h(J.overdue),helper:J.overdue>0?"Requires follow up":"No overdue balances",indicator:J.overdue>0?"negative":"positive"},{label:"Collection rate",value:`${J.collectionRate}%`,helper:"Paid in the last 30 days",indicator:re}]}),R?s.jsx(r,{children:"Loading invoices..."}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"grid gap-4 md:grid-cols-2 xl:grid-cols-4",children:[s.jsx(w,{title:"Outstanding balance",value:h(J.outstanding),helper:J.outstanding>0?"Outstanding balance across sent invoices.":"All invoices have been settled.",tone:J.outstanding>0?"warning":"success"}),s.jsx(w,{title:"Overdue invoices",value:h(J.overdue),helper:W[t.OVERDUE]>0?`${W[t.OVERDUE]} invoice${1===W[t.OVERDUE]?"":"s"} require attention.`:"No invoices are overdue right now.",tone:J.overdue>0?"danger":"success"}),s.jsx(w,{title:"Draft invoices",value:`${J.draft}`,helper:"Prepare and send these invoices to start the billing cycle.",tone:J.draft>0?"warning":"default"}),s.jsx(w,{title:"Collection rate",value:`${J.collectionRate}%`,helper:J.collectionRate>=90?"Collections are on track.":"Aim for at least 90% to maintain healthy cash flow.",tone:J.collectionRate>=90?"success":J.collectionRate>=60?"warning":"danger"})]}),s.jsxs(r,{children:[s.jsxs("div",{className:"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between",children:[s.jsx("div",{className:"flex flex-wrap items-center gap-2",children:x.map(e=>{const t=T===e.id;return s.jsxs("button",{type:"button",onClick:()=>F(e.id),className:"flex items-center gap-2 rounded-full border px-3 py-1 text-sm transition-colors "+(t?"border-primary bg-primary/10 text-primary":"border-border bg-background text-muted-foreground hover:bg-muted"),children:[s.jsx("span",{children:e.label}),s.jsx("span",{className:"rounded-full bg-muted px-2 py-0.5 text-xs font-semibold text-muted-foreground",children:W[e.id]??0})]},e.id)})}),s.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center",children:[s.jsxs("div",{className:"relative",children:[s.jsx("span",{className:"pointer-events-none absolute inset-y-0 left-3 flex items-center text-muted-foreground",children:s.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:s.jsx("path",{fillRule:"evenodd",d:"M12.9 14.32a8 8 0 111.414-1.414l4.387 4.387a1 1 0 01-1.414 1.414l-4.387-4.387zM14 8a6 6 0 11-12 0 6 6 0 0112 0z",clipRule:"evenodd"})})}),s.jsx("input",{type:"search",value:k,onChange:e=>S(e.target.value),placeholder:"Search by invoice, client, or project",className:"w-full rounded-full border border-border bg-background py-2 pl-9 pr-3 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/40"})]}),s.jsx(a,{variant:"ghost",size:"sm",onClick:Z,disabled:"ALL"===T&&0===k.trim().length,children:"Reset filters"})]})]}),s.jsx("div",{className:"mt-4 overflow-hidden rounded-lg border border-border",children:Y.length>0?s.jsxs("table",{className:"min-w-full divide-y divide-border text-sm",children:[s.jsx("thead",{className:"bg-muted/60 text-xs uppercase text-muted-foreground",children:s.jsxs("tr",{children:[s.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Invoice"}),s.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Client & project"}),s.jsx("th",{className:"px-4 py-3 text-left font-medium",children:"Due"}),s.jsx("th",{className:"px-4 py-3 text-right font-medium",children:"Total"}),s.jsx("th",{className:"px-4 py-3 text-right font-medium",children:"Balance"}),s.jsx("th",{className:"px-4 py-3 text-right font-medium",children:"Status"})]})}),s.jsx("tbody",{className:"divide-y divide-border bg-card",children:Y.map(e=>{const a=c(e),r=d(e),l=y(e);return s.jsxs("tr",{onClick:()=>P(e.id),className:"cursor-pointer transition-colors hover:bg-muted/60",children:[s.jsxs("td",{className:"px-4 py-4 align-top",children:[s.jsxs("div",{className:"flex items-center gap-2 font-semibold",children:[e.invoiceNumber,a===t.OVERDUE&&s.jsx("span",{className:"h-2 w-2 rounded-full bg-red-500"})]}),s.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:["Issued ",g(b(e))]})]}),s.jsxs("td",{className:"px-4 py-4 align-top",children:[s.jsx("p",{className:"font-medium",children:X.get(e.clientId)||"Client unavailable"}),s.jsx("p",{className:"text-xs text-muted-foreground",children:H.get(e.projectId)||"Project unavailable"})]}),s.jsxs("td",{className:"px-4 py-4 align-top",children:[s.jsx("div",{className:"font-medium",children:g(f(e))}),l&&s.jsx(i,{label:l.label,color:l.color,className:"mt-1"})]}),s.jsxs("td",{className:"px-4 py-4 text-right align-top",children:[s.jsx("div",{className:"font-semibold",children:h(r.total)}),s.jsxs("p",{className:"text-xs text-muted-foreground",children:["Paid ",h(r.amountPaid)]})]}),s.jsx("td",{className:"px-4 py-4 text-right align-top font-semibold",children:h(r.balance)}),s.jsx("td",{className:"px-4 py-4 text-right align-top",children:s.jsx(n,{status:a})})]},e.id)})})]}):s.jsxs("div",{className:"flex flex-col items-center justify-center gap-2 py-12 text-center text-sm text-muted-foreground",children:[s.jsx("p",{children:"No invoices match your current filters."}),s.jsx(a,{variant:"secondary",size:"sm",onClick:Z,children:"Clear filters"})]})})]}),!R&&0===j.length&&s.jsxs(r,{className:"text-center",children:[s.jsx("h3",{className:"text-lg font-semibold",children:"No invoices yet"}),s.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Start tracking project billing by creating your first invoice in the Financials workspace."})]})]})]})};export{C as InvoicesView};
