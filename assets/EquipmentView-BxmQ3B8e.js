import{h as e,P as s,a as t,j as a,C as n,B as r,i}from"./index-D85gtc9V.js";import{r as l}from"./leaflet-QxLtkkBL.js";import{E as d}from"./StatusBadge-DqYvwqgD.js";import"./react-Z2Iecplj.js";import"./genai-DmvHCT3V.js";import"./Tag-CPyoOo4I.js";const c=({equipmentToEdit:e,projects:s,assignments:d,user:c,onClose:o,onSuccess:m,addToast:u,currentAssignment:x})=>{const[p,h]=l.useState(""),[g,j]=l.useState(i.AVAILABLE),[f,y]=l.useState(!1),b=!!x;l.useEffect(()=>{if(e){h(e.name);const s=e.status===i.IN_USE?i.AVAILABLE:e.status;j(s)}else h(""),j(i.AVAILABLE)},[e]);const N=l.useMemo(()=>new Map(s.map(e=>[e.id,e.name])),[s]),k=l.useMemo(()=>e?d.filter(s=>"equipment"===s.resourceType&&s.resourceId===e.id).sort((e,s)=>new Date(s.startDate).getTime()-new Date(e.startDate).getTime()):[],[d,e]);return a.jsx("div",{className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",onClick:o,children:a.jsxs(n,{className:"w-full max-w-xl",onClick:e=>e.stopPropagation(),children:[a.jsx("h3",{className:"font-bold text-lg mb-4",children:e?"Equipment Details":"Add Equipment"}),a.jsxs("form",{onSubmit:async s=>{s.preventDefault(),y(!0);try{e?(await t.updateEquipment(e.id,{name:p,status:g},c.id),u("Equipment updated successfully.","success")):(await t.createEquipment({name:p,status:g},c.id),u("Equipment added successfully.","success")),m(),o()}catch(a){u(a instanceof Error?a.message:"Failed to save equipment.","error")}finally{y(!1)}},className:"space-y-4",children:[a.jsx("input",{type:"text",value:p,onChange:e=>h(e.target.value),placeholder:"Equipment Name",className:"w-full p-2 border rounded",required:!0}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-slate-300",children:"Status"}),b&&a.jsxs("div",{className:"p-2 mt-1 bg-sky-50 dark:bg-sky-900/50 rounded-md text-sm text-sky-800 dark:text-sky-200",children:["This item is currently ",a.jsx("span",{className:"font-semibold",children:"In Use"})," based on the schedule. You can set its underlying status below for when the assignment ends."]}),a.jsxs("select",{value:g,onChange:e=>j(e.target.value),className:"w-full p-2 border bg-white rounded mt-2 dark:bg-slate-800 dark:border-slate-600",disabled:f,children:[a.jsx("option",{value:i.AVAILABLE,children:"Available"}),a.jsx("option",{value:i.MAINTENANCE,children:"Maintenance"})]})]}),e&&a.jsxs("div",{className:"pt-4 border-t dark:border-slate-700",children:[a.jsx("h4",{className:"font-semibold text-base mb-2",children:"Assignment History"}),k.length>0?a.jsx("div",{className:"max-h-48 overflow-y-auto space-y-2 pr-2",children:k.map(e=>{const s=e.id===x?.id;return a.jsxs("div",{className:"p-2 rounded-md text-sm "+(s?"bg-sky-100 dark:bg-sky-900/50 border border-sky-200 dark:border-sky-700":"bg-slate-50 dark:bg-slate-800"),children:[a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("p",{className:"font-medium",children:N.get(e.projectId)||"Unknown Project"}),s&&a.jsx("span",{className:"text-xs font-bold text-sky-600 dark:text-sky-300",children:"ACTIVE"})]}),a.jsxs("p",{className:"text-slate-500 dark:text-slate-400",children:[new Date(e.startDate).toLocaleDateString()," - ",new Date(e.endDate).toLocaleDateString()]})]},e.id)})}):a.jsx("p",{className:"text-sm text-slate-500 p-2",children:"No assignments found. Manage assignments in the Resource Scheduler."})]}),a.jsxs("div",{className:"flex justify-end gap-2 pt-2 border-t dark:border-slate-700",children:[a.jsx(r,{type:"button",variant:"secondary",onClick:o,children:"Close"}),a.jsx(r,{type:"submit",isLoading:f,children:e?"Save Changes":"Save"})]})]})]})})},o=({user:o,addToast:m})=>{const[u,x]=l.useState([]),[p,h]=l.useState([]),[g,j]=l.useState([]),[f,y]=l.useState(!0),[b,N]=l.useState(!1),[k,v]=l.useState(null),E=l.useRef(null),A=e(o,s.MANAGE_EQUIPMENT),w=l.useCallback(async()=>{const e=new AbortController;E.current?.abort(),E.current=e,y(!0);try{if(!o.companyId)return;const[s,a,n]=await Promise.all([t.getEquipmentByCompany(o.companyId,{signal:e.signal}),t.getProjectsByCompany(o.companyId,{signal:e.signal}),t.getResourceAssignments(o.companyId,{signal:e.signal})]);if(e.signal.aborted)return;if(x(s),e.signal.aborted)return;if(h(a),e.signal.aborted)return;j(n)}catch(s){if(e.signal.aborted)return;m("Failed to load equipment data.","error")}finally{if(e.signal.aborted)return;y(!1)}},[o.companyId,m]);l.useEffect(()=>(w(),()=>{E.current?.abort()}),[w]);const S=l.useMemo(()=>new Map(p.map(e=>[e.id,e.name])),[p]),I=l.useMemo(()=>{const e=new Map,s=new Date;return s.setHours(0,0,0,0),g.forEach(t=>{if("equipment"===t.resourceType){const a=new Date(t.startDate),n=new Date(t.endDate);a.setHours(0,0,0,0),n.setHours(0,0,0,0),a<=s&&s<=n&&e.set(t.resourceId,t)}}),e},[g]),C=e=>I.has(e.id)?i.IN_USE:e.status===i.IN_USE?i.AVAILABLE:e.status,q=(e=null)=>{v(e),N(!0)};return f?a.jsx(n,{children:a.jsx("p",{children:"Loading equipment..."})}):a.jsxs("div",{className:"space-y-6",children:[b&&a.jsx(c,{equipmentToEdit:k,projects:p,assignments:g,user:o,onClose:()=>N(!1),onSuccess:w,addToast:m,currentAssignment:k?I.get(k.id):void 0}),a.jsxs("div",{className:"flex justify-between items-center",children:[a.jsx("h2",{className:"text-3xl font-bold text-slate-800 dark:text-slate-100",children:"Equipment"}),A&&a.jsx(r,{onClick:()=>q(),children:"Add Equipment"})]}),a.jsx(n,{children:a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-slate-700",children:[a.jsx("thead",{className:"bg-slate-50 dark:bg-slate-800",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Name"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Status"}),a.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase",children:"Current Project"}),A&&a.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase",children:"Actions"})]})}),a.jsx("tbody",{className:"bg-white dark:bg-slate-900 divide-y divide-gray-200 dark:divide-slate-700",children:u.map(e=>a.jsxs("tr",{children:[a.jsx("td",{className:"px-6 py-4 font-medium",children:e.name}),a.jsx("td",{className:"px-6 py-4",children:a.jsx(d,{status:C(e)})}),a.jsx("td",{className:"px-6 py-4",children:I.has(e.id)?S.get(I.get(e.id).projectId):"Unassigned"}),A&&a.jsx("td",{className:"px-6 py-4 text-right",children:a.jsx(r,{variant:"ghost",size:"sm",onClick:()=>q(e),children:"Details"})})]},e.id))})]})})})]})};export{o as EquipmentView};
