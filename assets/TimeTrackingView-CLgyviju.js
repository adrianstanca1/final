import{a as e,j as t,C as a,B as s}from"./index-D85gtc9V.js";import{r as n}from"./leaflet-QxLtkkBL.js";import{M as o}from"./MapView-D6xwUiFQ.js";import"./react-Z2Iecplj.js";import"./genai-DmvHCT3V.js";const i=({geofences:e=[]})=>{const[t,a]=n.useState(null),[s,o]=n.useState(null),[i,r]=n.useState(new Set),l=n.useRef(null);return{data:t,error:s,watchLocation:n.useCallback(()=>{navigator.geolocation?l.current=navigator.geolocation.watchPosition(t=>{const{latitude:s,longitude:n,accuracy:i}=t.coords,l={coords:{latitude:s,longitude:n,accuracy:i},timestamp:t.timestamp};a(l);const c=new Set;e.forEach(e=>{((e,t,a,s)=>{const n=e*Math.PI/180,o=a*Math.PI/180,i=(a-e)*Math.PI/180,r=(s-t)*Math.PI/180,l=Math.sin(i/2)*Math.sin(i/2)+Math.cos(n)*Math.cos(o)*Math.sin(r/2)*Math.sin(r/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371e3})(s,n,e.lat,e.lng)<e.radius&&c.add(e.id)}),r(c),o(null)},e=>{o(e.message)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}):o("Geolocation is not supported by this browser.")},[e]),stopWatching:n.useCallback(()=>{null!==l.current&&(navigator.geolocation.clearWatch(l.current),l.current=null)},[]),insideGeofenceIds:i}},r=({startTime:e})=>{const[a,s]=n.useState("");return n.useEffect(()=>{const t=()=>{const t=Date.now()-new Date(e).getTime(),a=Math.floor(t/36e5).toString().padStart(2,"0"),n=Math.floor(t%36e5/6e4).toString().padStart(2,"0"),o=Math.floor(t%6e4/1e3).toString().padStart(2,"0");s(`${a}:${n}:${o}`)};t();const a=setInterval(t,1e3);return()=>clearInterval(a)},[e]),t.jsx("p",{className:"text-4xl font-mono font-bold text-center",children:a})},l=({user:l,addToast:c,setActiveView:d})=>{const[u,g]=n.useState(!0),[m,h]=n.useState([]),[f,x]=n.useState([]),[p,j]=n.useState(""),[w,b]=n.useState(!1),k=n.useRef(null),y=n.useMemo(()=>p?m.find(e=>e.id.toString()===p):null,[m,p]),S=n.useMemo(()=>y&&y.geofenceRadius?[{id:y.id,lat:y.location.lat,lng:y.location.lng,radius:y.geofenceRadius}]:[],[y]),{data:M,watchLocation:v,stopWatching:I,insideGeofenceIds:N}=i({geofences:S}),C=n.useMemo(()=>f.find(e=>null===e.clockOut),[f]),T=n.useCallback(async()=>{const t=new AbortController;k.current?.abort(),k.current=t,g(!0);try{const[a,s]=await Promise.all([e.getProjectsByUser(l.id,{signal:t.signal}),e.getTimesheetsByUser(l.id,{signal:t.signal})]);if(t.signal.aborted)return;if(h(a),t.signal.aborted)return;if(x(s.sort((e,t)=>new Date(t.clockIn).getTime()-new Date(e.clockIn).getTime())),t.signal.aborted)return;if(C)j(C.projectId.toString());else if(a.length>0&&!p){if(t.signal.aborted)return;j(a[0].id.toString())}}catch(a){if(t.signal.aborted)return;c("Failed to load time tracking data","error")}finally{if(t.signal.aborted)return;g(!1)}},[l.id,c,p,C]);n.useEffect(()=>(T(),()=>{k.current?.abort()}),[T]),n.useEffect(()=>(v(),()=>I()),[v,I]);const D=n.useMemo(()=>{const e=[];return y&&e.push({id:y.id,lat:y.location.lat,lng:y.location.lng,radius:y.geofenceRadius}),M&&e.push({id:"user",lat:M.coords.latitude,lng:M.coords.longitude,isUserLocation:!0,popupContent:"Your Location"}),e},[y,M]);return u?t.jsx(a,{children:"Loading..."}):t.jsxs("div",{className:"space-y-6 max-w-2xl mx-auto",children:[t.jsx("h2",{className:"text-3xl font-bold text-slate-800 dark:text-slate-100 text-center",children:"Time Clock"}),t.jsx(a,{children:C?t.jsxs("div",{className:"space-y-4",children:[t.jsxs("p",{className:"text-center text-lg",children:["Currently clocked in at ",t.jsx("strong",{children:m.find(e=>e.id===C.projectId)?.name})]}),t.jsx(r,{startTime:C.clockIn}),t.jsx(s,{variant:"danger",className:"w-full",onClick:async()=>{b(!0);try{await e.clockOut(l.id),c("Clocked out successfully","success"),T()}catch(t){c(t instanceof Error?t.message:"Clock-out failed","error")}finally{b(!1)}},isLoading:w,children:"Clock Out"})]}):t.jsxs("div",{className:"space-y-4",children:[t.jsxs("select",{value:p,onChange:e=>j(e.target.value),className:"w-full p-3 border rounded-md bg-white dark:bg-slate-800",children:[t.jsx("option",{value:"",children:"-- Select a project --"}),m.map(e=>t.jsx("option",{value:e.id,children:e.name},e.id))]}),t.jsx("div",{className:"h-64 w-full rounded-lg overflow-hidden",children:t.jsx(o,{markers:D})}),t.jsx(s,{className:"w-full",onClick:async()=>{if(y){if(y.geofenceRadius){if(!N.has(y.id)){if(!window.confirm("Warning: You appear to be outside the project's geofence. This action will be logged. Are you sure you want to clock in?"))return}}b(!0);try{await e.clockIn(y.id,l.id),c(`Clocked into project ${y.name}`,"success"),T()}catch(t){c(t instanceof Error?t.message:"Clock-in failed","error")}finally{b(!1)}}else c("Please select a project.","error")},disabled:!p||w,isLoading:w,children:"Clock In"})]})}),t.jsxs(a,{children:[t.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Recent Shifts"}),t.jsx("ul",{className:"space-y-2",children:f.slice(0,5).map(e=>{const a=e.clockOut?((new Date(e.clockOut).getTime()-new Date(e.clockIn).getTime())/36e5).toFixed(2)+" hrs":"Active";return t.jsxs("li",{className:"p-2 border rounded-md flex justify-between items-center dark:border-slate-700",children:[t.jsxs("div",{children:[t.jsx("p",{className:"font-medium",children:m.find(t=>t.id==e.projectId)?.name}),t.jsx("p",{className:"text-xs text-slate-500",children:new Date(e.clockIn).toLocaleDateString()})]}),t.jsxs("div",{className:"text-right",children:[t.jsx("p",{className:"font-semibold",children:a}),t.jsx("p",{className:"text-xs text-slate-500",children:e.status})]})]},e.id)})})]})]})};export{l as TimeTrackingView};
