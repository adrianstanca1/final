import{h as e,P as s,T as t,a,j as l,C as r,B as i}from"./index-D85gtc9V.js";import{r as n}from"./leaflet-QxLtkkBL.js";import{V as c}from"./ViewHeader-B8uhkq6P.js";import"./react-Z2Iecplj.js";import"./genai-DmvHCT3V.js";const d=({user:d,addToast:o,isOnline:m})=>{const[h,p]=n.useState(!0),[u,x]=n.useState([]),[g,j]=n.useState([]),[N,f]=n.useState([]),[y,b]=n.useState("all"),[v,S]=n.useState(new Set),[k,w]=n.useState(!1),[C,P]=n.useState(null),[A,E]=n.useState({type:"",value:""});e(d,s.MANAGE_ALL_TASKS);const I=n.useRef(null);n.useMemo(()=>{const e=g.length,s=g.filter(e=>e.status===t.IN_PROGRESS).length,a=g.filter(e=>e.status===t.DONE).length;return{total:e,inProgress:s,completed:a,overdue:g.filter(e=>{if(!e.dueDate||e.status===t.DONE)return!1;const s=new Date(e.dueDate);return!Number.isNaN(s.getTime())&&s<new Date}).length,completionRate:e>0?Math.round(a/e*100):0}},[g]);const T=n.useCallback(async()=>{const e=new AbortController;I.current?.abort(),I.current=e,p(!0);try{if(!d.companyId)return;const[s,t]=await Promise.all([a.getProjectsByCompany(d.companyId,{signal:e.signal}),a.getUsersByCompany(d.companyId,{signal:e.signal})]);if(e.signal.aborted)return;if(x(s),e.signal.aborted)return;if(f(t),s.length>0){const t=await a.getTodosByProjectIds(s.map(e=>e.id),{signal:e.signal});if(e.signal.aborted)return;j(t)}}catch(s){"AbortError"!==s.name&&o("Failed to load tasks.","error")}finally{if(e.signal.aborted)return;p(!1)}},[d,o]);n.useEffect(()=>(T(),()=>{I.current?.abort()}),[T]),n.useMemo(()=>"all"===y?g:g.filter(e=>e.projectId.toString()===y),[g,y]);const D=(e,s)=>{const t=[...g],l=g.map(t=>t.id===e?{...t,status:s}:t);j(l),a.updateTodo(String(e),{status:s},d.id).then(s=>j(t=>t.map(t=>t.id===e?s:t))).catch(()=>{o("Failed to update task. Reverting.","error"),j(t)})};if(h)return l.jsx(r,{children:"Loading tasks..."});const R=g.filter(e=>e.status===t.PENDING),M=g.filter(e=>e.status===t.IN_PROGRESS),O=g.filter(e=>e.status===t.COMPLETED);return l.jsxs("div",{className:"space-y-6",children:[l.jsx(c,{view:"all-tasks",title:"All Tasks",description:"Manage all project tasks",actions:l.jsx(i,{children:"Add Task"}),meta:[{label:"Total tasks",value:tasks.length.toString(),helper:"All tasks across projects"},{label:"In progress",value:M.length.toString(),helper:"Actively being worked"},{label:"Completed",value:O.length.toString(),helper:"Finished tasks"}]}),l.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[l.jsx(r,{children:l.jsxs("div",{className:"p-6",children:[l.jsxs("h3",{className:"text-lg font-semibold mb-4",children:["Pending (",R.length,") "]}),l.jsx("div",{className:"space-y-3",children:R.slice(0,10).map(e=>l.jsxs("div",{className:"p-3 border rounded-lg",children:[l.jsx("h4",{className:"font-medium",children:e.title}),l.jsx("p",{className:"text-sm text-gray-500",children:e.description}),l.jsxs("div",{className:"flex justify-between items-center mt-2",children:[l.jsx("span",{className:"text-xs text-gray-400",children:e.priority}),l.jsx(i,{variant:"secondary",size:"sm",onClick:()=>D(e.id,"in_progress"),children:"Start"})]})]},e.id))})]})}),l.jsx(r,{children:l.jsxs("div",{className:"p-6",children:[l.jsxs("h3",{className:"text-lg font-semibold mb-4",children:["In Progress (",M.length,") "]}),l.jsx("div",{className:"space-y-3",children:M.slice(0,10).map(e=>l.jsxs("div",{className:"p-3 border rounded-lg",children:[l.jsx("h4",{className:"font-medium",children:e.title}),l.jsx("p",{className:"text-sm text-gray-500",children:e.description}),l.jsxs("div",{className:"flex justify-between items-center mt-2",children:[l.jsx("span",{className:"text-xs text-gray-400",children:e.priority}),l.jsx(i,{variant:"secondary",size:"sm",onClick:()=>D(e.id,"completed"),children:"Complete"})]})]},e.id))})]})}),l.jsx(r,{children:l.jsxs("div",{className:"p-6",children:[l.jsxs("h3",{className:"text-lg font-semibold mb-4",children:["Completed (",O.length,") "]}),l.jsx("div",{className:"space-y-3",children:O.slice(0,10).map(e=>l.jsxs("div",{className:"p-3 border rounded-lg opacity-75",children:[l.jsx("h4",{className:"font-medium",children:e.title}),l.jsx("p",{className:"text-sm text-gray-500",children:e.description}),l.jsx("div",{className:"flex justify-between items-center mt-2",children:l.jsx("span",{className:"text-xs text-green-600",children:"âœ“ Completed"})})]},e.id))})]})})]})]})};export{d as AllTasksView};
