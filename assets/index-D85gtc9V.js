const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Dashboard-l5ZD31sQ.js","assets/leaflet-QxLtkkBL.js","assets/react-Z2Iecplj.js","assets/StatusBadge-DqYvwqgD.js","assets/Tag-CPyoOo4I.js","assets/ViewHeader-B8uhkq6P.js","assets/projectPortfolio-VMbW4p0T.js","assets/dateFns-RCDwAoDQ.js","assets/genai-DmvHCT3V.js","assets/OwnerDashboard-FjUUYyqO.js","assets/finance-C6WgNQzT.js","assets/MyDayView-Dvq2cjFJ.js","assets/PrincipalAdminDashboard-BftXn6y3.js","assets/ProjectsView-DsVUKU2E.js","assets/ProjectDetailView-CBFjL1co.js","assets/AllTasksView-CAerpRT9.js","assets/ProjectsMapView-BgMfa9zS.js","assets/MapView-D6xwUiFQ.js","assets/TimeTrackingView-CLgyviju.js","assets/TimesheetsView-BWacfgmE.js","assets/DocumentsView-BK4c7-de.js","assets/SafetyView-Cq0XJCdX.js","assets/FinancialsView-DAqoWPvA.js","assets/TeamView-gZZeM_PZ.js","assets/EquipmentView-BxmQ3B8e.js","assets/TemplatesView-DqPP4zhP.js","assets/ToolsView-Bb7ws0Va.js","assets/AuditLogView-NkmcrqGb.js","assets/SettingsView-CLzZsNhy.js","assets/ChatView-DU-naVsp.js","assets/ClientsView-BLjzyKUL.js","assets/InvoicesView-FJ4Krrxw.js","assets/UserRegistration-BqxZwAl-.js"])))=>i.map(i=>d[i]);
import{r as e,a as t,g as s}from"./react-Z2Iecplj.js";import{r as n,R as r}from"./leaflet-QxLtkkBL.js";import{G as a}from"./genai-DmvHCT3V.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var o,i,c={exports:{}},l={};var d,u=(i||(i=1,c.exports=function(){if(o)return l;o=1;var t=e(),s=Symbol.for("react.element"),n=Symbol.for("react.fragment"),r=Object.prototype.hasOwnProperty,a=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function c(e,t,n){var o,c={},l=null,d=null;for(o in void 0!==n&&(l=""+n),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(d=t.ref),t)r.call(t,o)&&!i.hasOwnProperty(o)&&(c[o]=t[o]);if(e&&e.defaultProps)for(o in t=e.defaultProps)void 0===c[o]&&(c[o]=t[o]);return{$$typeof:s,type:e,key:l,ref:d,props:c,_owner:a.current}}return l.Fragment=n,l.jsx=c,l.jsxs=c,l}()),c.exports),m={};const p=s(function(){if(d)return m;d=1;var e=t();return m.createRoot=e.createRoot,m.hydrateRoot=e.hydrateRoot,m}()),h={},g=function(e,t,s){let n=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),r=s?.nonce||s?.getAttribute("nonce");n=e(t.map(e=>{if((e=function(e){return"/"+e}(e))in h)return;h[e]=!0;const t=e.endsWith(".css"),s=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${s}`))return;const n=document.createElement("link");return n.rel=t?"stylesheet":"modulepreload",t||(n.as="script"),n.crossOrigin="",n.href=e,r&&n.setAttribute("nonce",r),document.head.appendChild(n),t?new Promise((t,s)=>{n.addEventListener("load",t),n.addEventListener("error",()=>s(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function r(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return n.then(t=>{for(const e of t||[])"rejected"===e.status&&r(e.reason);return e().catch(r)})};var f=(e=>(e.OWNER="OWNER",e.ADMIN="ADMIN",e.PROJECT_MANAGER="PROJECT_MANAGER",e.FOREMAN="FOREMAN",e.OPERATIVE="OPERATIVE",e.CLIENT="CLIENT",e.PRINCIPAL_ADMIN="PRINCIPAL_ADMIN",e))(f||{}),y=(e=>(e.VIEW_ALL_PROJECTS="VIEW_ALL_PROJECTS",e.VIEW_ASSIGNED_PROJECTS="VIEW_ASSIGNED_PROJECTS",e.CREATE_PROJECT="CREATE_PROJECT",e.MANAGE_PROJECT_DETAILS="MANAGE_PROJECT_DETAILS",e.MANAGE_PROJECT_TEMPLATES="MANAGE_PROJECT_TEMPLATES",e.VIEW_ALL_TASKS="VIEW_ALL_TASKS",e.MANAGE_ALL_TASKS="MANAGE_ALL_TASKS",e.SUBMIT_TIMESHEET="SUBMIT_TIMESHEET",e.VIEW_ALL_TIMESHEETS="VIEW_ALL_TIMESHEETS",e.MANAGE_TIMESHEETS="MANAGE_TIMESHEETS",e.UPLOAD_DOCUMENTS="UPLOAD_DOCUMENTS",e.VIEW_DOCUMENTS="VIEW_DOCUMENTS",e.SUBMIT_SAFETY_REPORT="SUBMIT_SAFETY_REPORT",e.VIEW_SAFETY_REPORTS="VIEW_SAFETY_REPORTS",e.MANAGE_SAFETY_REPORTS="MANAGE_SAFETY_REPORTS",e.VIEW_FINANCES="VIEW_FINANCES",e.MANAGE_FINANCES="MANAGE_FINANCES",e.VIEW_TEAM="VIEW_TEAM",e.MANAGE_TEAM="MANAGE_TEAM",e.MANAGE_EQUIPMENT="MANAGE_EQUIPMENT",e.VIEW_AUDIT_LOG="VIEW_AUDIT_LOG",e.SEND_DIRECT_MESSAGE="SEND_DIRECT_MESSAGE",e.ACCESS_ALL_TOOLS="ACCESS_ALL_TOOLS",e.SUBMIT_EXPENSE="SUBMIT_EXPENSE",e))(y||{}),w=(e=>(e.TODO="TODO",e.IN_PROGRESS="IN_PROGRESS",e.DONE="DONE",e))(w||{}),E=(e=>(e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH",e))(E||{}),x=(e=>(e.PENDING="PENDING",e.APPROVED="APPROVED",e.REJECTED="REJECTED",e.PAID="PAID",e))(x||{}),v=(e=>(e.DRAFT="DRAFT",e.SENT="SENT",e.PAID="PAID",e.OVERDUE="OVERDUE",e.CANCELLED="CANCELLED",e))(v||{}),I=(e=>(e.INFO="INFO",e.SUCCESS="SUCCESS",e.WARNING="WARNING",e.ERROR="ERROR",e.APPROVAL_REQUEST="APPROVAL_REQUEST",e.TASK_ASSIGNED="TASK_ASSIGNED",e.NEW_MESSAGE="NEW_MESSAGE",e.SAFETY_ALERT="SAFETY_ALERT",e.DOCUMENT_COMMENT="DOCUMENT_COMMENT",e))(I||{}),A=(e=>(e.PENDING="PENDING",e.APPROVED="APPROVED",e.REJECTED="REJECTED",e.DRAFT="DRAFT",e))(A||{}),b=(e=>(e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH",e.CRITICAL="CRITICAL",e))(b||{}),S=(e=>(e.REPORTED="REPORTED",e.UNDER_INVESTIGATION="UNDER_INVESTIGATION",e.RESOLVED="RESOLVED",e))(S||{}),N=(e=>(e.AVAILABLE="AVAILABLE",e.IN_USE="IN_USE",e.MAINTENANCE="MAINTENANCE",e.OUT_OF_ORDER="OUT_OF_ORDER",e))(N||{}),j=(e=>(e.AVAILABLE="AVAILABLE",e.ON_PROJECT="ON_PROJECT",e.ON_LEAVE="ON_LEAVE",e))(j||{});const T={OWNER:new Set(Object.values(y)),ADMIN:new Set(["VIEW_ALL_PROJECTS","CREATE_PROJECT","MANAGE_PROJECT_DETAILS","VIEW_ALL_TASKS","MANAGE_ALL_TASKS","VIEW_ALL_TIMESHEETS","MANAGE_TIMESHEETS","UPLOAD_DOCUMENTS","VIEW_DOCUMENTS","VIEW_SAFETY_REPORTS","MANAGE_SAFETY_REPORTS","VIEW_FINANCES","MANAGE_FINANCES","VIEW_TEAM","MANAGE_TEAM","MANAGE_EQUIPMENT","VIEW_AUDIT_LOG","SEND_DIRECT_MESSAGE","ACCESS_ALL_TOOLS","SUBMIT_EXPENSE","MANAGE_PROJECT_TEMPLATES"]),PROJECT_MANAGER:new Set(["VIEW_ALL_PROJECTS","MANAGE_PROJECT_DETAILS","VIEW_ALL_TASKS","MANAGE_ALL_TASKS","VIEW_ALL_TIMESHEETS","MANAGE_TIMESHEETS","UPLOAD_DOCUMENTS","VIEW_DOCUMENTS","VIEW_SAFETY_REPORTS","VIEW_FINANCES","VIEW_TEAM","MANAGE_EQUIPMENT","SEND_DIRECT_MESSAGE","SUBMIT_EXPENSE"]),FOREMAN:new Set(["VIEW_ASSIGNED_PROJECTS","SUBMIT_TIMESHEET","UPLOAD_DOCUMENTS","VIEW_DOCUMENTS","SUBMIT_SAFETY_REPORT","VIEW_SAFETY_REPORTS","SEND_DIRECT_MESSAGE","SUBMIT_EXPENSE"]),OPERATIVE:new Set(["VIEW_ASSIGNED_PROJECTS","SUBMIT_TIMESHEET","VIEW_DOCUMENTS","SUBMIT_SAFETY_REPORT","SUBMIT_EXPENSE"]),CLIENT:new Set(["VIEW_ASSIGNED_PROJECTS","VIEW_DOCUMENTS"]),PRINCIPAL_ADMIN:new Set(Object.values(y))},k={companies:[{id:"0",name:"Platform Administration"},{id:"1",name:"ConstructCo"},{id:"2",name:"Renovate Ltd."},{id:"3",name:"As Cladding and Roofing Ltd"}],users:[{id:"0",firstName:"Adrian",lastName:"Admin",email:"adrian@ascladdingltd.co.uk",role:f.PRINCIPAL_ADMIN,companyId:"0",avatar:"https://i.pravatar.cc/150?u=0",password:"Cumparavinde1",mfaEnabled:!1},{id:"1",firstName:"Samantha",lastName:"Lee",email:"sam@constructco.com",role:f.ADMIN,companyId:"1",avatar:"https://i.pravatar.cc/150?u=1",phone:"07123456781",password:"password123",mfaEnabled:!1},{id:"2",firstName:"David",lastName:"Chen",email:"david@constructco.com",role:f.PROJECT_MANAGER,companyId:"1",avatar:"https://i.pravatar.cc/150?u=2",phone:"07123456782",password:"password123",mfaEnabled:!0},{id:"3",firstName:"Maria",lastName:"Garcia",email:"maria@constructco.com",role:f.FOREMAN,companyId:"1",avatar:"https://i.pravatar.cc/150?u=3",phone:"07123456783",password:"password123",mfaEnabled:!1},{id:"4",firstName:"Bob",lastName:"Williams",email:"bob@constructco.com",role:f.OPERATIVE,companyId:"1",avatar:"https://i.pravatar.cc/150?u=4",phone:"07123456784",password:"password123",mfaEnabled:!1},{id:"5",firstName:"John",lastName:"Smith",email:"john@renovate.com",role:f.ADMIN,companyId:"2",avatar:"https://i.pravatar.cc/150?u=5",phone:"07123456785",password:"password123",mfaEnabled:!1},{id:"6",firstName:"Emily",lastName:"White",email:"emily@renovate.com",role:f.PROJECT_MANAGER,companyId:"2",avatar:"https://i.pravatar.cc/150?u=6",phone:"07123456786",password:"password123",mfaEnabled:!1},{id:"7",firstName:"Carlos",lastName:"Diaz",email:"carlos@constructco.com",role:f.OPERATIVE,companyId:"1",avatar:"https://i.pravatar.cc/150?u=7",phone:"07123456787",password:"password123",mfaEnabled:!1},{id:"8",firstName:"Admin",lastName:"User",email:"admin@ascladding.com",role:f.OWNER,companyId:"3",avatar:"https://i.pravatar.cc/150?u=8",phone:"07123456788",password:"password123",mfaEnabled:!1}],projects:[{id:"101",companyId:"1",name:"Downtown Tower",location:{address:"123 Main St, London",lat:51.5074,lng:-.1278},budget:5e6,spent:325e4,actualCost:325e4,startDate:"2023-01-15",status:"ACTIVE",image:"https://picsum.photos/seed/tower/800/400"},{id:"102",companyId:"1",name:"North Bridge Retrofit",location:{address:"456 Oak Ave, Manchester",lat:53.4808,lng:-2.2426},budget:12e5,spent:135e4,actualCost:135e4,startDate:"2022-11-01",status:"COMPLETED",image:"https://picsum.photos/seed/bridge/800/400"},{id:"201",companyId:"2",name:"Victorian House Reno",location:{address:"789 Pine Ln, Bristol",lat:51.4545,lng:-2.5879},budget:25e4,spent:18e4,actualCost:18e4,startDate:"2023-03-10",status:"ACTIVE",image:"https://picsum.photos/seed/house/800/400"}],todos:[{id:"t-1",text:"Finalize foundation pouring",title:"Finalize foundation pouring",status:w.IN_PROGRESS,priority:E.HIGH,assignedTo:"3",projectId:"101"},{id:"t-2",text:"Install HVAC system on floor 5",title:"Install HVAC system on floor 5",status:w.TODO,priority:E.MEDIUM,assignedTo:"4",projectId:"101"},{id:"t-3",text:"Source interior fixtures",title:"Source interior fixtures",status:w.TODO,priority:E.LOW,assignedTo:"2",projectId:"101"},{id:"t-4",text:"Strip wallpaper in living room",title:"Strip wallpaper in living room",status:w.DONE,priority:E.MEDIUM,assignedTo:"6",projectId:"201"}],expenses:[{id:"e-1",description:"Client Lunch",amount:150,category:"Other",projectId:"101",userId:"2",date:"2024-01-15",status:x.APPROVED}],invoices:[{id:"inv-1",companyId:"1",invoiceNumber:"INV-001",projectId:"101",clientId:"c-1",issueDate:"2024-01-20",dueDate:"2024-02-20",status:v.PAID,lineItems:[{id:"li-1",description:"Phase 1",quantity:1,rate:1e5,amount:1e5}],subtotal:1e5,taxRate:.2,taxAmount:2e4,retentionRate:.05,retentionAmount:5e3,total:115e3,amountPaid:115e3,balance:0}],siteUpdates:[{id:"su-1",projectId:"101",userId:"3",message:"Concrete pour for the ground floor is complete.",timestamp:new Date(Date.now()-72e5).toISOString(),images:["https://picsum.photos/seed/concrete/400/200"]}],projectMessages:[{id:"pm-1",projectId:"101",senderId:"2",message:"Team, please remember the safety briefing at 7 AM sharp tomorrow.",timestamp:new Date(Date.now()-12e5).toISOString()}],safetyIncidents:[{id:"si-1",title:"Minor Slip",description:"Minor slip on wet surface, no injury.",severity:b.LOW,projectId:"101",reportedBy:"3",incidentDate:(new Date).toISOString(),status:S.RESOLVED}],equipment:[{id:"eq-1",name:"Excavator CAT 320",status:N.AVAILABLE,companyId:"1"}],timeEntries:[{id:"te-1",userId:"4",projectId:"101",startTime:new Date(Date.now()-288e5).toISOString(),endTime:(new Date).toISOString(),status:A.PENDING}],projectInsights:[],clients:[{id:"c-1",companyId:"1",name:"Global Real Estate Inc.",contactPerson:"Ava Harris",contactEmail:"ava.harris@gre.com",contactPhone:"+44 20 7946 0101",email:"accounts@gre.com",phone:"+44 20 7946 0101",billingAddress:"Accounts Payable, 100 Market Street, London SW1A 1AA",paymentTerms:"Net 30",isActive:!0,createdAt:"2024-01-15T09:00:00Z",updatedAt:"2024-12-10T10:30:00Z",address:{street:"100 Market Street",city:"London",state:"Greater London",zipCode:"SW1A 1AA",country:"United Kingdom"}},{id:"c-2",companyId:"1",name:"Northbridge Retail Group",contactPerson:"Leo Patel",contactEmail:"leo.patel@northbridge.com",contactPhone:"+44 161 555 0198",email:"finance@northbridge.com",phone:"+44 161 555 0198",billingAddress:"Finance Office, 50 King Street, Manchester M2 4LY",paymentTerms:"Net 45",isActive:!0,createdAt:"2024-11-28T12:00:00Z",updatedAt:"2024-12-15T08:15:00Z",address:{street:"50 King Street",city:"Manchester",state:"Greater Manchester",zipCode:"M2 4LY",country:"United Kingdom"}}]},_=(()=>{if(void 0!==globalThis.crypto)return globalThis.crypto;throw new Error("Secure crypto APIs are not available in this environment.")})(),P=new TextEncoder,C=e=>Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join(""),M=async(e,t)=>{const s=P.encode(`${t}:${e}`),n=await _.subtle.digest("SHA-256",s);return C(n)},D=async e=>{const t=((e=16)=>{const t=new Uint8Array(e);return _.getRandomValues(t),C(t.buffer)})();return{hash:await M(e,t),salt:t}},R=async e=>{if(!e.passwordHash&&!e.passwordSalt&&e.password){const{hash:t,salt:s}=await D(e.password);e.passwordHash=t,e.passwordSalt=s,delete e.password}return e};let L=null;const O=()=>{if(L)return L;try{const e=globalThis;if(e&&e.localStorage){const t="__asagents_storage_test__";return e.localStorage.setItem(t,"1"),e.localStorage.removeItem(t),L=e.localStorage,L}}catch(e){console.warn("Falling back to in-memory storage adapter.",e)}return L=(()=>{const e=new Map;return{getItem:t=>e.has(t)?e.get(t):null,setItem(t,s){e.set(t,String(s))},removeItem(t){e.delete(t)},clear(){e.clear()},key:t=>Array.from(e.keys())[t]??null,get length(){return e.size}}})(),L};class V{constructor(e={}){this.cache=new Map,this.defaultTtl=e.ttl||3e5,this.maxSize=e.maxSize||100,this.persistent=e.persistent||!1,this.namespace=e.namespace||"app-cache",this.persistent&&this.loadFromStorage(),"undefined"!=typeof window&&setInterval(()=>this.cleanup(),6e4)}set(e,t,s){const n=Date.now(),r={data:t,timestamp:n,ttl:s||this.defaultTtl,accessCount:0,lastAccessed:n};this.cache.size>=this.maxSize&&this.evictLRU(),this.cache.set(e,r),this.persistent&&this.saveToStorage()}get(e){const t=this.cache.get(e);if(!t)return null;const s=Date.now();return s-t.timestamp>t.ttl?(this.cache.delete(e),this.persistent&&this.saveToStorage(),null):(t.accessCount++,t.lastAccessed=s,t.data)}has(e){return null!==this.get(e)}delete(e){const t=this.cache.delete(e);return t&&this.persistent&&this.saveToStorage(),t}clear(){this.cache.clear(),this.persistent&&this.saveToStorage()}keys(){return Array.from(this.cache.keys())}size(){return this.cache.size}getStats(){const e=Array.from(this.cache.values());return{size:this.cache.size,maxSize:this.maxSize,totalAccesses:e.reduce((e,t)=>e+t.accessCount,0),averageAge:e.length>0?e.reduce((e,t)=>e+(Date.now()-t.timestamp),0)/e.length:0}}evictLRU(){let e="",t=Date.now();for(const[s,n]of this.cache.entries())n.lastAccessed<t&&(t=n.lastAccessed,e=s);e&&this.cache.delete(e)}cleanup(){const e=Date.now(),t=[];for(const[s,n]of this.cache.entries())e-n.timestamp>n.ttl&&t.push(s);t.forEach(e=>this.cache.delete(e)),t.length>0&&this.persistent&&this.saveToStorage()}saveToStorage(){if("undefined"!=typeof window&&window.localStorage)try{const e=JSON.stringify(Array.from(this.cache.entries()));localStorage.setItem(`${this.namespace}-cache`,e)}catch(e){console.warn("Failed to save cache to localStorage:",e)}}loadFromStorage(){if("undefined"!=typeof window&&window.localStorage)try{const e=localStorage.getItem(`${this.namespace}-cache`);if(e){const t=JSON.parse(e);this.cache=new Map(t),this.cleanup()}}catch(e){console.warn("Failed to load cache from localStorage:",e)}}}const $=new V({ttl:3e5,maxSize:200,persistent:!0,namespace:"api-cache"});new V({ttl:18e5,maxSize:50,persistent:!0,namespace:"user-cache"}),new V({ttl:6e5,maxSize:100,persistent:!0,namespace:"project-cache"});const U=class{static validate(e,t){const s={},n={...e};for(const r of t){const t=String(r.field),a=e[r.field],o=[];if(!r.required||null!=a&&""!==a){if(r.required||null!=a&&""!==a){if(r.type){const e=this.validateType(a,r.type,t);e&&o.push(e)}if("string"==typeof a&&(r.minLength&&a.length<r.minLength&&o.push(`${t} must be at least ${r.minLength} characters`),r.maxLength&&a.length>r.maxLength&&o.push(`${t} must not exceed ${r.maxLength} characters`)),"number"==typeof a&&(void 0!==r.min&&a<r.min&&o.push(`${t} must be at least ${r.min}`),void 0!==r.max&&a>r.max&&o.push(`${t} must not exceed ${r.max}`)),r.pattern&&"string"==typeof a&&!r.pattern.test(a)&&o.push(`${t} format is invalid`),r.custom){const e=r.custom(a);e&&o.push(e)}r.sanitize&&(n[r.field]=r.sanitize(a)),o.length>0&&(s[t]=o)}}else o.push(`${t} is required`)}return{isValid:0===Object.keys(s).length,errors:s,sanitizedData:0===Object.keys(s).length?n:void 0}}static validateType(e,t,s){switch(t){case"string":return"string"!=typeof e?`${s} must be a string`:null;case"number":return"number"!=typeof e||isNaN(e)?`${s} must be a valid number`:null;case"boolean":return"boolean"!=typeof e?`${s} must be true or false`:null;case"email":return"string"==typeof e&&this.emailRegex.test(e)?null:`${s} must be a valid email address`;case"phone":return"string"==typeof e&&this.phoneRegex.test(e.replace(/\s/g,""))?null:`${s} must be a valid phone number`;case"url":return"string"==typeof e&&this.urlRegex.test(e)?null:`${s} must be a valid URL`;case"date":const t=new Date(e);return isNaN(t.getTime())?`${s} must be a valid date`:null;default:return null}}};U.emailRegex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,U.phoneRegex=/^[\+]?[1-9][\d]{0,15}$/,U.urlRegex=/^https?:\/\/.+/,U.sanitizers={trim:e=>"string"==typeof e?e.trim():e,toLowerCase:e=>"string"==typeof e?e.toLowerCase():e,toUpperCase:e=>"string"==typeof e?e.toUpperCase():e,removeSpecialChars:e=>"string"==typeof e?e.replace(/[^a-zA-Z0-9\s]/g,""):e,normalizePhone:e=>"string"==typeof e?e.replace(/\D/g,""):e,normalizeEmail:e=>"string"==typeof e?e.toLowerCase().trim():e,escapeHtml:e=>"string"!=typeof e?e:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;"),limitLength:e=>t=>"string"==typeof t?t.substring(0,e):t},U.commonRules={email:{field:"email",required:!0,type:"email",sanitize:U.sanitizers.normalizeEmail},password:{field:"password",required:!0,type:"string",minLength:8,custom:e=>/(?=.*[a-z])/.test(e)?/(?=.*[A-Z])/.test(e)?/(?=.*\d)/.test(e)?null:"Password must contain at least one number":"Password must contain at least one uppercase letter":"Password must contain at least one lowercase letter"},phone:{field:"phone",type:"phone",sanitize:U.sanitizers.normalizePhone},name:{field:"name",required:!0,type:"string",minLength:2,maxLength:50,sanitize:U.sanitizers.trim},currency:{field:"amount",required:!0,type:"number",min:0,custom:e=>e<0?"Amount cannot be negative":e>1e6?"Amount exceeds maximum limit":null}};const F=e=>{if("function"==typeof btoa)return btoa(e);if("undefined"!=typeof Buffer)return Buffer.from(e,"binary").toString("base64");throw new Error("Base64 encoding is not supported in this environment.")},B=(e=50)=>new Promise(t=>setTimeout(t,e)),G=e=>{if(e?.aborted)throw new DOMException("Aborted","AbortError")},z=9e5,W=6048e5,q=e=>e.trim().toLowerCase(),H=e=>e.trim().toUpperCase(),J=new Map,Y=O(),K=[["JOIN-CONSTRUCTCO",{companyId:"1",allowedRoles:[f.ADMIN,f.PROJECT_MANAGER,f.FOREMAN,f.OPERATIVE],suggestedRole:f.PROJECT_MANAGER}],["JOIN-RENOVATE",{companyId:"2",allowedRoles:[f.ADMIN,f.PROJECT_MANAGER,f.FOREMAN,f.OPERATIVE],suggestedRole:f.FOREMAN}],["JOIN-CLIENT",{companyId:"3",allowedRoles:[f.CLIENT],suggestedRole:f.CLIENT}]],Q=new Map;Q.clear(),K.forEach(([e,t])=>{Q.set(e,{...t})});const Z=(e,t)=>{const s={...e,iat:Date.now(),exp:Math.floor((Date.now()+t)/1e3)};return`${F(JSON.stringify({alg:"HS256",typ:"JWT"}))}.${F(JSON.stringify(s))}.${F("your-super-secret-key-for-mock-jwt")}`},X=e=>{try{const t=JSON.parse((e=>{if("function"==typeof atob)return atob(e);if("undefined"!=typeof Buffer)return Buffer.from(e,"base64").toString("binary");throw new Error("Base64 decoding is not supported in this environment.")})(e.split(".")[1]));if(1e3*t.exp<Date.now())throw new Error("Token expired");return t}catch(t){return console.error("Token decode/validation failed:",t),null}},ee="asagents_",te=e=>JSON.parse(JSON.stringify(e)),se=(e,t)=>{try{const s=Y.getItem(e);return s?JSON.parse(s):t}catch(s){return console.error(`Failed to read ${e} from storage`,s),t}},ne=(e,t)=>{Y.setItem(e,JSON.stringify(t))},re={companies:te(k.companies),users:te(k.users),projects:te(k.projects),todos:te(k.todos),timeEntries:te(k.timeEntries),safetyIncidents:te(k.safetyIncidents),equipment:te(k.equipment),clients:te(k.clients),invoices:te(k.invoices),expenses:te(k.expenses||[]),siteUpdates:te(k.siteUpdates),projectMessages:te(k.projectMessages),notifications:te(k.notifications||[]),quotes:te(k.quotes||[]),auditLogs:[],resourceAssignments:[],conversations:[],messages:[],projectAssignments:[],projectTemplates:[],whiteboardNotes:[],documents:[],projectInsights:te(k.projectInsights||[])},ae=e=>{const t=`${ee}${String(e)}`;try{const e=Y.getItem(t);if(e)return JSON.parse(e)}catch(n){console.error(`Failed to hydrate ${String(e)} from storage`,n)}const s=te(re[e]);return Y.setItem(t,JSON.stringify(s)),s};let oe={companies:ae("companies"),users:ae("users"),projects:ae("projects"),todos:ae("todos"),timeEntries:ae("timeEntries"),safetyIncidents:ae("safetyIncidents"),equipment:ae("equipment"),clients:ae("clients"),invoices:ae("invoices"),expenses:ae("expenses"),siteUpdates:ae("siteUpdates"),projectMessages:ae("projectMessages"),notifications:ae("notifications"),quotes:ae("quotes"),auditLogs:ae("auditLogs"),resourceAssignments:ae("resourceAssignments"),conversations:ae("conversations"),messages:ae("messages"),projectAssignments:ae("projectAssignments"),projectTemplates:ae("projectTemplates"),whiteboardNotes:ae("whiteboardNotes"),documents:ae("documents"),projectInsights:ae("projectInsights")};const ie=()=>{Object.keys(oe).forEach(e=>{Y.setItem(`${ee}${String(e)}`,JSON.stringify(oe[e]))})},ce=e=>{const t=q(e);return oe.users.find(e=>e.email&&e.email.toLowerCase()===t)},le=e=>(e=>{const{password:t,passwordHash:s,passwordSalt:n,...r}=e;return r})(e);(()=>{const e=oe.users.filter(e=>e.password&&(!e.passwordHash||!e.passwordSalt));0!==e.length&&Promise.all(e.map(e=>R(e))).then(()=>{ie()}).catch(e=>console.error("Failed to upgrade legacy user credentials",e))})();(()=>{let e=!1;oe.users.forEach(t=>{!t.role||t.permissions&&0!==t.permissions.length||(t.permissions=Array.from(T[t.role]),e=!0)}),e&&ie()})();const de=(e,t,s)=>{const n={id:String(Date.now()+Math.random()),actorId:e,action:t,target:s,timestamp:(new Date).toISOString()};oe.auditLogs.push(n),ie()},ue={register:async e=>{if(await B(),!e.email||!e.password)throw new Error("Email and password are required.");if(!e.termsAccepted)throw new Error("You must accept the terms and conditions to create an account.");const t=q(e.email);if(ce(t))throw new Error("An account with this email already exists.");const s=e.password.trim();if(![s.length>=8,/[A-Z]/.test(s),/[a-z]/.test(s),/\d/.test(s),/[^A-Za-z0-9]/.test(s)].every(Boolean))throw new Error("Password does not meet the minimum complexity requirements.");const n=e.firstName?.trim(),r=e.lastName?.trim(),a=e.phone?.trim();let o,i,c=e.role||f.OPERATIVE;if("create"===e.companySelection){const t=e.companyName?.trim(),s=e.companyType,n=e.companyEmail?q(e.companyEmail):void 0,r=e.companyPhone?.trim(),a=e.companyWebsite?.trim();if(!t||!s)throw new Error("Company information is incomplete.");const l=String(Date.now());o=l,i={id:o,name:t,type:s,email:n,phone:r,website:a,status:"Active",subscriptionPlan:"FREE",storageUsageGB:0,settings:{theme:"light",accessibility:{highContrast:!1},timeZone:"Europe/London",dateFormat:"DD/MM/YYYY",currency:"GBP",workingHours:{start:"08:00",end:"17:00",workDays:[1,2,3,4,5]},features:{projectManagement:!0,timeTracking:!0,financials:!0,documents:!0,safety:!0,equipment:!0,reporting:!0}},address:{street:"",city:"",state:"",zipCode:"",country:"United Kingdom"},createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()},oe.companies.push(i),Q.set(`JOIN-${o}`,{companyId:o,allowedRoles:[f.ADMIN,f.PROJECT_MANAGER,f.FOREMAN,f.OPERATIVE],suggestedRole:f.ADMIN}),c=f.OWNER}else{if("join"!==e.companySelection)throw new Error("Invalid company selection.");{const t=e.inviteToken?H(e.inviteToken):"";if(!t)throw new Error("An invite token is required to join an existing company.");const s=Q.get(t);if(!s)throw new Error("Invalid invite token.");if(o=s.companyId,i=oe.companies.find(e=>e.id===o),!i)throw new Error("Company not found for invite token.");if(e.role&&!s.allowedRoles.includes(e.role))throw new Error("Selected role is not permitted for this invite.");c=e.role&&s.allowedRoles.includes(e.role)?e.role:s.suggestedRole||s.allowedRoles[0]}}const l=await D(s),d=(new Date).toISOString(),u={id:String(Date.now()+Math.random()),firstName:n,lastName:r,email:t,passwordHash:l.hash,passwordSalt:l.salt,phone:a,role:c,permissions:Array.from(T[c]),companyId:o,isActive:!0,isEmailVerified:!0,mfaEnabled:!1,createdAt:d,updatedAt:d,preferences:{theme:"system",language:"en",notifications:{email:!0,push:!1,sms:!1,taskReminders:!0,projectUpdates:!0,systemAlerts:!0},dashboard:{defaultView:"dashboard",pinnedWidgets:[],hiddenWidgets:[]}}};!1===e.updatesOptIn&&(u.preferences.notifications.projectUpdates=!1),oe.users.push(u);const m=i||oe.companies.find(e=>e.id===o);m?.name&&(de(u.id,"USER_REGISTERED",{type:"Company",id:o,name:m.name}),"create"===e.companySelection&&de(u.id,"COMPANY_CREATED",{type:"Company",id:o,name:m.name})),ie();const p=oe.users.find(e=>e.id===u.id),h=oe.companies.find(e=>e.id===o);return{success:!0,token:Z({userId:p.id,companyId:h.id,role:p.role},z),refreshToken:Z({userId:p.id},W),user:le(p),company:h}},checkEmailAvailability:async e=>{if(await B(120),!e)return{available:!1};const t=q(e);return{available:!ce(t)}},lookupInviteToken:async e=>{if(await B(200),!e)throw new Error("An invite token is required.");const t=H(e),s=Q.get(t);if(!s)throw new Error("Invite token not recognized.");const n=oe.companies.find(e=>e.id===s.companyId);if(!n)throw new Error("Company not found for invite token.");return{companyId:n.id,companyName:n.name||"Unnamed Company",companyType:n.type,allowedRoles:s.allowedRoles,suggestedRole:s.suggestedRole}},login:async e=>{await B(200);const t=q(e.email),s=ce(t);if(!s)throw new Error("Invalid email or password.");if(!(!s.password||s.passwordHash&&s.passwordSalt)&&(await R(s),ie()),!s.passwordHash||!s.passwordSalt)throw new Error("Invalid email or password.");if(!(await(async(e,t,s)=>((e,t)=>{if(e.length!==t.length)return!1;let s=0;for(let n=0;n<e.length;n++)s|=e.charCodeAt(n)^t.charCodeAt(n);return 0===s})(await M(e,s),t))(e.password,s.passwordHash,s.passwordSalt)))throw new Error("Invalid email or password.");return s.mfaEnabled?{success:!0,mfaRequired:!0,userId:s.id}:ue.finalizeLogin(s.id)},verifyMfa:async(e,t)=>{if(await B(200),"123456"!==t)throw new Error("Invalid MFA code.");return ue.finalizeLogin(e)},finalizeLogin:async e=>{await B();const t=oe.users.find(t=>t.id===e);if(!t)throw new Error("User not found during finalization.");const s=oe.companies.find(e=>e.id===t.companyId);if(!s)throw new Error("Company not found for user.");return{success:!0,token:Z({userId:t.id,companyId:s.id,role:t.role},z),refreshToken:Z({userId:t.id},W),user:le(t),company:s}},refreshToken:async e=>{await B();const t=X(e);if(!t)throw new Error("Invalid refresh token");const s=oe.users.find(e=>e.id===t.userId);if(!s)throw new Error("User not found for refresh token");return{token:Z({userId:s.id,companyId:s.companyId,role:s.role},z)}},me:async e=>{await B();const t=X(e);if(!t)throw new Error("Invalid or expired token");const s=oe.users.find(e=>e.id===t.userId),n=oe.companies.find(e=>e.id===t.companyId);if(!s||!n)throw new Error("User or company not found");return{user:le(s),company:n}},requestPasswordReset:async e=>{await B(300);const t=e?ce(e):void 0;if(t){const s=`reset-${Date.now()}-${Math.random()}`;J.set(s,{userId:t.id,expires:Date.now()+36e5}),console.log(`Password reset for ${e}. Token: ${s}`)}return{success:!0}},resetPassword:async(e,t)=>{await B(300);const s=J.get(e);if(!s||s.expires<Date.now())throw new Error("Invalid or expired password reset token.");const n=oe.users.findIndex(e=>e.id===s.userId);if(-1===n)throw new Error("User not found.");const r=await D(t);return oe.users[n].passwordHash=r.hash,oe.users[n].passwordSalt=r.salt,delete oe.users[n].password,ie(),J.delete(e),{success:!0}}};let me=se("asagents_offline_queue",[]),pe=se("asagents_failed_sync_actions",[]);const he=()=>{ne("asagents_offline_queue",me),ne("asagents_failed_sync_actions",pe)},ge=async()=>{if(0===me.length)return{successCount:0,movedToFailedCount:0};let e=0,t=0;const s=[...me];me=[];for(const r of s)try{await B(100),console.log(`Successfully synced action: ${r.type}`,r.payload),e++}catch(n){r.retries++,r.error=n instanceof Error?n.message:"Unknown sync error",r.retries>=3?(pe.push(r),t++):me.push(r)}return he(),{successCount:e,movedToFailedCount:t}},fe=()=>[...pe],ye=async e=>{const t=pe.findIndex(t=>t.id===e);if(t>-1){const[e]=pe.splice(t,1);e.retries=0,me.push(e),he(),await ge()}},we=e=>{pe=pe.filter(t=>t.id!==e),he()},Ee=e=>({id:e.id,summary:`${e.type.replace(/_/g," ")}: ${JSON.stringify(e.payload).substring(0,100)}...`,error:e.error||"Unknown Error",timestamp:new Date(e.id).toLocaleString()}),xe={getCompanySettings:async e=>{await B();const t=oe.companies.find(t=>t.id===e);if(!t)throw new Error("Company not found");return t.settings||(t.settings={theme:"light",accessibility:{highContrast:!1},timeZone:"Europe/London",dateFormat:"DD/MM/YYYY",currency:"GBP",workingHours:{start:"08:00",end:"17:00",workDays:[1,2,3,4,5]},features:{projectManagement:!0,timeTracking:!0,financials:!0,documents:!0,safety:!0,equipment:!0,reporting:!0}},ie()),te(t.settings)},updateCompanySettings:async(e,t,s)=>{await B();const n=oe.companies.find(t=>t.id===e);if(!n)throw new Error("Company not found");const r=((e,t)=>{const s=t.workingHours?{...e.workingHours,...t.workingHours,...t.workingHours.workDays?{workDays:[...t.workingHours.workDays]}:{}}:e.workingHours,n=t.features?{...e.features,...t.features}:e.features,r=t.accessibility?{...e.accessibility,...t.accessibility}:e.accessibility;return{...e,...t,workingHours:s,features:n,accessibility:r}})(n.settings||{theme:"light",accessibility:{highContrast:!1},timeZone:"Europe/London",dateFormat:"DD/MM/YYYY",currency:"GBP",workingHours:{start:"08:00",end:"17:00",workDays:[1,2,3,4,5]},features:{projectManagement:!0,timeTracking:!0,financials:!0,documents:!0,safety:!0,equipment:!0,reporting:!0}},t);return n.settings=te(r),n.updatedAt=(new Date).toISOString(),ie(),s&&n.name&&de(s,"COMPANY_SETTINGS_UPDATED",{type:"Company",id:e,name:n.name}),te(r)},getTimesheetsByCompany:async(e,t,s)=>(G(s?.signal),await B(),G(s?.signal),oe.timeEntries.map(e=>({...e,clockIn:new Date(e.clockIn),clockOut:e.clockOut?new Date(e.clockOut):null}))),getSafetyIncidentsByCompany:async(e,t)=>(G(t?.signal),await B(),G(t?.signal),oe.safetyIncidents.filter(t=>resolveCompanyIdFromProject(t.projectId)===e)),getConversationsForUser:async(e,t)=>(G(t?.signal),await B(),G(t?.signal),oe.conversations.filter(t=>t.participantIds?.includes(e))),getNotificationsForUser:async(e,t)=>(G(t?.signal),await B(),G(t?.signal),oe.notifications.filter(t=>t.userId===e).map(e=>({...e,timestamp:new Date(e.timestamp)}))),markAllNotificationsAsRead:async e=>{await B(),oe.notifications.forEach(t=>{t.userId===e&&(t.isRead=!0,t.read=!0)}),ie()},markNotificationAsRead:async e=>{await B();const t=oe.notifications.find(t=>t.id===e);t&&(t.isRead=!0,t.read=!0,ie())},getProjectsByManager:async(e,t)=>(G(t?.signal),await B(),G(t?.signal),oe.projects.filter(t=>t.managerId===e)),getUsersByCompany:async(e,t)=>(G(t?.signal),await B(),G(t?.signal),oe.users.filter(t=>t.companyId===e)),getProjectById:async(e,t)=>{G(t?.signal),await B(),G(t?.signal);const s=oe.projects.find(t=>t.id===e);return s||null},getEquipmentByCompany:async(e,t)=>(G(t?.signal),await B(),G(t?.signal),oe.equipment.filter(t=>t.companyId===e)),getResourceAssignments:async(e,t)=>(G(t?.signal),await B(),G(t?.signal),oe.resourceAssignments),getAuditLogsByCompany:async(e,t)=>(G(t?.signal),await B(),G(t?.signal),oe.auditLogs),getTodosByProjectIds:async(e,t)=>{G(t?.signal),await B(),G(t?.signal);const s=new Set(e);return oe.todos.filter(e=>s.has(e.projectId))},getDocumentsByProject:async(e,t)=>(G(t?.signal),await B(),G(t?.signal),oe.documents.filter(t=>t.projectId===e)),getUsersByProject:async(e,t)=>{G(t?.signal),await B(),G(t?.signal);const s=oe.projectAssignments.filter(t=>t.projectId===e),n=new Set(s.map(e=>e.userId));return oe.users.filter(e=>n.has(e.id)).map(e=>le(e))},getProjectInsights:async(e,t)=>(G(t?.signal),await B(),G(t?.signal),oe.projectInsights.filter(t=>t.projectId===e).sort((e,t)=>new Date(t.createdAt||0).getTime()-new Date(e.createdAt||0).getTime()).map(e=>({id:e.id,projectId:e.projectId,summary:e.summary||"",type:e.type||"CUSTOM",createdAt:e.createdAt||(new Date).toISOString(),createdBy:e.createdBy||"system",model:e.model,metadata:e.metadata}))),createProjectInsight:async(e,t)=>{if(await B(),!e.projectId)throw new Error("projectId is required to create an insight.");if(!e.summary.trim())throw new Error("summary is required to create an insight.");const s={id:String(Date.now()+Math.random()),projectId:e.projectId,summary:e.summary,type:e.type||"CUSTOM",createdAt:(new Date).toISOString(),createdBy:t,model:e.model,metadata:e.metadata};oe.projectInsights.push(s);const n=oe.projects.find(t=>t.id===e.projectId);return de(t,"generated_project_insight",n?{type:"project",id:n.id,name:n.name||""}:void 0),ie(),s},getFinancialForecasts:async(e,t)=>(G(t?.signal),await B(),G(t?.signal),oe.financialForecasts.filter(t=>t.companyId===e).sort((e,t)=>new Date(t.createdAt||0).getTime()-new Date(e.createdAt||0).getTime()).map(e=>({id:e.id,companyId:e.companyId,summary:e.summary||"",horizonMonths:"number"==typeof e.horizonMonths?e.horizonMonths:Number(e.metadata?.horizonMonths)||3,createdAt:e.createdAt||(new Date).toISOString(),createdBy:e.createdBy||"system",model:e.model,metadata:e.metadata}))),createFinancialForecast:async(e,t)=>{if(await B(),!e.companyId)throw new Error("companyId is required to create a financial forecast.");if(!e.summary.trim())throw new Error("summary is required to create a financial forecast.");const s={id:String(Date.now()+Math.random()),companyId:e.companyId,summary:e.summary,horizonMonths:e.horizonMonths,createdAt:(new Date).toISOString(),createdBy:t,model:e.model,metadata:e.metadata};oe.financialForecasts.push(s);const n=oe.companies.find(t=>t.id===e.companyId);return de(t,"generated_financial_forecast",n?{type:"company",id:n.id,name:n.name||""}:void 0),ie(),s},getExpensesByCompany:async(e,t)=>{G(t?.signal),await B(),G(t?.signal);const s=new Set(oe.projects.filter(t=>t.companyId===e).map(e=>e.id));return oe.expenses.filter(e=>s.has(e.projectId))},updateTodo:async(e,t,s)=>{await B();const n=oe.todos.findIndex(t=>t.id===e);if(-1===n)throw new Error("Todo not found");return oe.todos[n]={...oe.todos[n],...t,updatedAt:(new Date).toISOString()},ie(),oe.todos[n]},getProjectsByUser:async(e,t)=>{G(t?.signal),await B(),G(t?.signal);const s=oe.projectAssignments.filter(t=>t.userId===e),n=new Set(s.map(e=>e.projectId));return oe.projects.filter(e=>n.has(e.id))},updateEquipment:async(e,t,s)=>{await B();const n=oe.equipment.findIndex(t=>t.id===e);if(-1===n)throw new Error("Equipment not found");return oe.equipment[n]={...oe.equipment[n],...t},ie(),oe.equipment[n]},createEquipment:async(e,t)=>{await B();const s={...e,id:String(Date.now()),companyId:oe.users.find(e=>e.id===t)?.companyId};return oe.equipment.push(s),ie(),s},createResourceAssignment:async(e,t)=>{const s={...e,id:String(Date.now())};return oe.resourceAssignments.push(s),ie(),s},updateResourceAssignment:async(e,t,s)=>{const n=oe.resourceAssignments.findIndex(t=>t.id===e);return oe.resourceAssignments[n]={...oe.resourceAssignments[n],...t},ie(),oe.resourceAssignments[n]},deleteResourceAssignment:async(e,t)=>{oe.resourceAssignments=oe.resourceAssignments.filter(t=>t.id!==e),ie()},uploadDocument:async(e,t)=>{const s={...e,id:String(Date.now()),uploadedBy:t,version:1,uploadedAt:(new Date).toISOString()};return oe.documents.push(s),ie(),s},getDocumentsByCompany:async(e,t)=>(G(t?.signal),oe.documents),getProjectsByCompany:async(e,t)=>(G(t?.signal),oe.projects.filter(t=>t.companyId===e)),getProjectPortfolioSummary:async(e,t)=>{G(t?.signal),await B(),G(t?.signal);const s=t?.projectIds?.map(String),n=s&&s.length>0?new Set(s):null,r=oe.projects.filter(t=>t.companyId===e&&(!n||null!=t.id&&n.has(String(t.id))));return computeProjectPortfolioSummary(r)},findGrants:async(e,t)=>(await B(1e3),[{id:"g1",name:"Green Retrofit Grant",agency:"Gov UK",amount:"£50,000",description:"For sustainable energy retrofits.",url:"#"}]),analyzeForRisks:async e=>(await B(1e3),{summary:"Low risk detected.",identifiedRisks:[{severity:"Low",description:"Ambiguous payment terms.",recommendation:"Clarify payment schedule before signing."}]}),generateBidPackage:async(e,t,s)=>(await B(1500),{summary:"Executive summary...",coverLetter:"Dear Sir/Madam...",checklist:["Form A","Form B"]}),generateSafetyAnalysis:async(e,t,s)=>(await B(1500),{report:`Analysis for project #${t}:\n- Common issue: Slips on wet surfaces (${e.length} incidents).\n- Recommendation: Increase signage and regular clean-up patrols.`}),getCompanies:async e=>(G(e?.signal),oe.companies),getPlatformUsageMetrics:async e=>(G(e?.signal),[{name:"Active Users (24h)",value:oe.users.length-2,unit:"users"},{name:"API Calls (24h)",value:12543,unit:"calls"}]),updateTimesheetEntry:async(e,t,s)=>{const n=oe.timeEntries.findIndex(t=>t.id===e);return oe.timeEntries[n]={...oe.timeEntries[n],...t},ie(),oe.timeEntries[n]},submitTimesheet:async(e,t)=>{const s={...e,id:String(Date.now()),status:A.PENDING};return oe.timeEntries.push(s),ie(),s},updateTimesheetStatus:async(e,t,s,n)=>{const r=oe.timeEntries.findIndex(t=>t.id===e);return oe.timeEntries[r].status=t,n&&(oe.timeEntries[r].rejectionReason=n),ie(),oe.timeEntries[r]},generateDailySummary:async(e,t,s)=>(await B(1e3),`Summary for ${t.toDateString()}:\n- Task A completed.\n- Task B in progress.`),getFinancialKPIsForCompany:async(e,t)=>{G(t?.signal),await B(),G(t?.signal);const s=getCompanyCurrency(e),n=oe.invoices.filter(t=>resolveCompanyIdForInvoice(t)===e).reduce((e,t)=>{const s=safeNumber(t.total??t.amount??0),n=safeNumber(t.amountPaid??0),r=t.balance,a=null!=r?safeNumber(r):Math.max(s-n,0);return e.pipeline+=s,e.collected+=n>0?Math.min(s,n):s-a,e.outstanding+=a,e},{pipeline:0,collected:0,outstanding:0}),r=new Set([x.APPROVED,x.PAID]),a=oe.expenses.filter(t=>{if(resolveCompanyIdForExpense(t)!==e)return!1;if(!t.status)return!1;const s=String(t.status);return r.has(s)}).reduce((e,t)=>e+safeNumber(t.amount),0),o=n.collected>0?(n.collected-a)/n.collected*100:0,i=Math.round(10*Math.max(-100,Math.min(100,o)))/10,c=oe.projects.filter(t=>t.companyId===e).map(e=>{const t=safeNumber(e.budget);if(t<=0)return null;const s=(t-safeNumber(e.actualCost??e.spent??0))/t*100;return Math.max(-100,Math.min(100,s))}).filter(e=>null!==e);return{profitability:i,projectMargin:c.length?Math.round(c.reduce((e,t)=>e+t,0)/c.length*10)/10:0,cashFlow:Math.round(100*(n.collected-a))/100,currency:s}},getMonthlyFinancials:async(e,t)=>{G(t?.signal),await B(),G(t?.signal);const s=new Map,n=e=>{const t=getMonthKey(e);if(!s.has(t)){const n=new Date(e.getFullYear(),e.getMonth(),1);s.set(t,{label:getMonthLabel(e),date:n,revenue:0,expense:0})}return s.get(t)};for(const a of oe.invoices){if(resolveCompanyIdForInvoice(a)!==e)continue;const t=parseDate(a.issueDate??a.issuedAt??a.createdAt);if(!t)continue;n(t).revenue+=safeNumber(a.total??a.amount??0)}const r=new Set([x.APPROVED,x.PAID]);for(const a of oe.expenses){if(resolveCompanyIdForExpense(a)!==e)continue;if(!a.status||!r.has(String(a.status)))continue;const t=parseDate(a.date??a.createdAt??a.submittedAt);if(!t)continue;n(t).expense+=safeNumber(a.amount)}return Array.from(s.values()).sort((e,t)=>e.date.getTime()-t.date.getTime()).map(e=>({month:e.label,revenue:Math.round(100*e.revenue)/100,profit:Math.round(100*(e.revenue-e.expense))/100}))},getCostBreakdown:async(e,t)=>{G(t?.signal),await B(),G(t?.signal);const s=new Set([x.APPROVED,x.PAID]),n=new Map;for(const r of oe.expenses){if(resolveCompanyIdForExpense(r)!==e)continue;if(!r.status||!s.has(String(r.status)))continue;const t=(r.category??"Uncategorised").toString(),a=safeNumber(r.amount);a<=0||n.set(t,(n.get(t)??0)+a)}return Array.from(n.entries()).map(([e,t])=>({category:e,amount:Math.round(100*t)/100})).sort((e,t)=>t.amount-e.amount)},getOperationalInsights:async(e,t)=>{G(t?.signal),await B(),G(t?.signal);const s=new Date,n=s.toISOString(),r=s.getTime(),a=new Date(s.getFullYear(),s.getMonth(),1);a.setHours(0,0,0,0);const o=new Date(s);o.setHours(0,0,0,0);const i=o.getDay(),c=0===i?6:i-1;o.setDate(o.getDate()-c);const l=new Date(o);l.setDate(o.getDate()+7);const d=getCompanyCurrency(e),u=oe.projects.filter(t=>t.companyId===e),m=new Set;for(const w of u)null!=w.id&&m.add(String(w.id));const p=oe.users.filter(t=>t.companyId===e),h=new Set;for(const w of p)null!=w.id&&h.add(String(w.id));const g=oe.todos.filter(e=>{const t=e.projectId??e.projectId;if(null!=t&&m.has(String(t)))return!0;const s=e.assignedTo??e.assigneeId;return null!=s&&h.has(String(s))}),f=oe.timeEntries.filter(t=>{if(resolveCompanyIdFromProject(t.projectId)===e)return!0;return resolveCompanyIdFromUser(t.userId)===e}),y=oe.safetyIncidents.filter(t=>resolveCompanyIdFromProject(t.projectId)===e),E=oe.invoices.filter(t=>resolveCompanyIdForInvoice(t)===e),v=oe.expenses.filter(t=>resolveCompanyIdForExpense(t)===e),I=e=>{if(!e)return null;const t=String(e).toUpperCase();return Object.values(w).includes(t)?t:null},N=e=>{if(!e)return null;const t=String(e).toUpperCase();return Object.values(A).includes(t)?t:null},j=f.filter(e=>{const t=N(e.status);return null!==t&&t!==A.DRAFT}),T=j.filter(e=>N(e.status)===A.APPROVED),k=j.filter(e=>N(e.status)===A.PENDING).length,_=f.filter(e=>{if(N(e.status)!==A.PENDING)return!1;return!(null!=e.endTime||null!=e.clockOut)}).length,P=j.length?T.length/j.length*100:0,C=j.map(e=>(e=>{const t=parseDate(e.startTime??e.clockIn),s=parseDate(e.endTime??e.clockOut);if(t&&s)return Math.max(0,(s.getTime()-t.getTime())/MILLISECONDS_PER_HOUR);const n=safeNumber(e.duration??e.duration);return n<=0?0:n>48?n/60:n})(e)).filter(e=>e>0),M=C.reduce((e,t)=>e+t,0),D=C.length?M/C.length:0,R=C.reduce((e,t)=>e+Math.max(0,t-8),0),L=T.filter(e=>{const t=parseDate(e.updatedAt??e.endTime??e.clockOut??e.approvedAt);return!!t&&(t>=o&&t<l)}).length,O=g.filter(e=>parseDate(e.dueDate??e.due_at)),V=O.filter(e=>{const t=parseDate(e.dueDate??e.due_at);if(!t)return!1;const s=t.getTime();return s>=r&&s<=r+7*MILLISECONDS_PER_DAY}).length,$=O.filter(e=>{const t=parseDate(e.dueDate??e.due_at);if(!t)return!1;const s=I(e.status??e.status);return t.getTime()<r&&s!==w.DONE}).length,U=g.filter(e=>I(e.status??e.status)===w.IN_PROGRESS).length,F=y.filter(e=>(e.status?String(e.status).toUpperCase():null)!==S.RESOLVED),z=F.filter(e=>{const t=e.severity?String(e.severity).toUpperCase():null;return t===b.HIGH||t===b.CRITICAL}).length,W=y.reduce((e,t)=>{const s=parseDate(t.incidentDate??t.timestamp??t.createdAt);return s&&(!e||s.getTime()>e.getTime())?s:e},null),q=W?Math.max(0,Math.floor((r-W.getTime())/MILLISECONDS_PER_DAY)):null,H=computeProjectPortfolioSummary(u),J=H.activeProjects>0?H.activeProjects:u.filter(e=>"ACTIVE"===String(e.status).toUpperCase()).length,Y=u.reduce((e,t)=>{const s=t.status?String(t.status).toUpperCase():null;if("COMPLETED"===s||"CANCELLED"===s)return e;const n=safeNumber(t.budget);if(n<=0)return e;return safeNumber(t.actualCost??t.spent??0)>1.05*n?e+1:e},0),K=v.reduce((e,t)=>{if(!(e=>{if(!e)return!1;const t=String(e).toUpperCase();return t===x.APPROVED||t===x.PAID})(t.status))return e;const s=parseDate(t.date??t.submittedAt??t.createdAt);return!s||s<a?e:e+safeNumber(t.amount)},0),Q=J>0?K/J:K,Z=E.reduce((e,t)=>e+getInvoiceFinancials(t).balance,0),X=[];var ee;return j.length>0&&P<85&&X.push({id:"low-timesheet-compliance",severity:P<60?"critical":"warning",message:`Timesheet approvals are at ${Math.round(P)}%. Clear pending entries to restore compliance.`}),z>0&&X.push({id:"high-severity-incidents",severity:"critical",message:`${z} high-severity incident${1===z?" requires":"s require"} immediate action.`}),$>0&&X.push({id:"overdue-field-tasks",severity:"warning",message:`${$} task${1===$?" is":"s are"} past due. Rebalance crew priorities.`}),Z>0&&X.push({id:"outstanding-receivables",severity:Z>1e5?"warning":"info",message:`${ee=Z,new Intl.NumberFormat("en-GB",{style:"currency",currency:d,maximumFractionDigits:0}).format(Math.round(ee))} outstanding in receivables.`}),{updatedAt:n,safety:{openIncidents:F.length,highSeverity:z,daysSinceLastIncident:q},workforce:{complianceRate:Math.round(10*P)/10,approvedThisWeek:L,overtimeHours:Math.round(10*R)/10,averageHours:Math.round(10*D)/10,activeTimesheets:_,pendingApprovals:k},schedule:{atRiskProjects:Y,overdueProjects:H.overdueProjects,tasksDueSoon:V,overdueTasks:$,tasksInProgress:U,averageProgress:Math.round(10*H.averageProgress)/10},financial:{currency:d,approvedExpensesThisMonth:Math.round(100*K)/100,burnRatePerActiveProject:Math.round(100*Q)/100,outstandingReceivables:Math.round(100*Z)/100},alerts:X}},getInvoicesByCompany:async(e,t)=>(G(t?.signal),oe.invoices),getQuotesByCompany:async(e,t)=>(G(t?.signal),oe.quotes),getClientsByCompany:async(e,t)=>(G(t?.signal),oe.clients.filter(t=>t.companyId===e).map(e=>({...e,isActive:e.isActive??!0}))),updateClient:async(e,t,s)=>{const n=oe.clients.findIndex(t=>t.id===e);if(-1===n)throw new Error("Client not found");return oe.clients[n]={...oe.clients[n],...t,updatedAt:(new Date).toISOString()},ie(),oe.clients[n]},createClient:async(e,t)=>{const s=(new Date).toISOString(),n=oe.users.find(e=>e.id===t).companyId,r={isActive:!0,createdAt:s,updatedAt:s,contactPerson:e.contactPerson||"",contactEmail:e.contactEmail,contactPhone:e.contactPhone||e.phone,paymentTerms:e.paymentTerms||"Net 30",billingAddress:e.billingAddress||"",address:e.address||{street:"",city:"",state:"",zipCode:"",country:""},...e,id:String(Date.now()),companyId:n};return oe.clients.push(r),ie(),r},updateInvoice:async(e,t,s)=>{await B();const n=oe.invoices.findIndex(t=>t.id===e);if(-1===n)throw new Error("Invoice not found");const r=oe.invoices[n],a=r.companyId??oe.users.find(e=>e.id===s)?.companyId,o=t.invoiceNumber??r.invoiceNumber;if(!o)throw new Error("Invoice number is required.");if(oe.invoices.some((e,t)=>t!==n&&(!!e.invoiceNumber&&e.invoiceNumber===o)))throw new Error("Invoice number already exists.");const i=r?.status;return oe.invoices[n]={...r,...t,companyId:r.companyId??a,invoiceNumber:o},i!==t.status?de(s,`UPDATE_INVOICE_STATUS: ${i} -> ${t.status}`,{type:"Invoice",id:e,name:o}):de(s,"UPDATE_INVOICE",{type:"Invoice",id:e,name:o}),ie(),oe.invoices[n]},createInvoice:async(e,t)=>{await B();const s=oe.users.find(e=>e.id===t)?.companyId;if(!s)throw new Error("Unable to determine company for invoice creation.");const n=oe.invoices.filter(e=>!e.companyId||e.companyId===s),r=new Set(n.map(e=>e.invoiceNumber).filter(e=>Boolean(e)));let a,o=n.reduce((e,t)=>{const s=(e=>{if(!e)return 0;const t=e.match(/(\d+)$/);return t?parseInt(t[1],10):0})(t.invoiceNumber);return Math.max(e,s)},0);do{o+=1,a=`INV-${String(o).padStart(3,"0")}`}while(r.has(a));if(!a)throw new Error("Failed to generate invoice number.");const i={...e,id:String(Date.now()),companyId:s,invoiceNumber:a};return oe.invoices.push(i),de(t,"CREATE_INVOICE",{type:"Invoice",id:i.id,name:i.invoiceNumber}),ie(),i},recordPaymentForInvoice:async(e,t,s)=>{await B();const n=oe.invoices.findIndex(t=>t.id===e);if(-1===n)throw new Error("Invoice not found");const r=oe.invoices[n];r.payments||(r.payments=[]);const a={...t,id:String(Date.now()),createdBy:s,date:(new Date).toISOString(),invoiceId:e};r.payments.push(a),r.amountPaid=(r.amountPaid||0)+t.amount;const o=(r.total||0)-(r.amountPaid||0);return r.balance=o,o<=0&&r.status!==v.CANCELLED?(r.status=v.PAID,de(s,`RECORD_PAYMENT (amount: ${t.amount})`,{type:"Invoice",id:e,name:r.invoiceNumber}),de(s,`UPDATE_INVOICE_STATUS: ${v.SENT} -> ${v.PAID}`,{type:"Invoice",id:e,name:r.invoiceNumber})):de(s,`RECORD_PAYMENT (amount: ${t.amount})`,{type:"Invoice",id:e,name:r.invoiceNumber}),ie(),r},submitExpense:async(e,t)=>{const s={...e,id:String(Date.now()),userId:t,status:x.PENDING,submittedAt:(new Date).toISOString()};return oe.expenses.push(s),ie(),s},updateExpense:async(e,t,s)=>{const n=oe.expenses.findIndex(t=>t.id===e);return oe.expenses[n]={...oe.expenses[n],...t,status:x.PENDING},ie(),oe.expenses[n]},clockIn:async(e,t)=>{const s={id:String(Date.now()),userId:t,projectId:e,clockIn:new Date,clockOut:null,status:A.DRAFT};return oe.timeEntries.push(s),ie(),s},clockOut:async e=>{const t=oe.timeEntries.find(t=>t.userId===e&&null===t.clockOut);if(!t)throw new Error("Not clocked in");return t.clockOut=new Date,t.status=A.PENDING,ie(),t},getTimesheetsByUser:async(e,t)=>(G(t?.signal),oe.timeEntries.filter(t=>t.userId===e).map(e=>({...e,clockIn:new Date(e.clockIn),clockOut:e.clockOut?new Date(e.clockOut):null}))),createSafetyIncident:async(e,t)=>{const s={...e,id:String(Date.now()),reportedById:t,timestamp:(new Date).toISOString(),status:S.REPORTED};return oe.safetyIncidents.push(s),ie(),s},updateSafetyIncidentStatus:async(e,t,s)=>{const n=oe.safetyIncidents.findIndex(t=>t.id===e);return oe.safetyIncidents[n].status=t,ie(),oe.safetyIncidents[n]},createProject:async(e,t,s)=>{const n=oe.users.find(e=>e.id===s)?.companyId,r={...e,id:String(Date.now()),companyId:n,status:"PLANNING",actualCost:0};return oe.projects.push(r),oe.projectAssignments.push({userId:s,projectId:r.id}),ie(),r},updateProject:async(e,t,s)=>{const n=oe.projects.findIndex(t=>t.id===e);return oe.projects[n]={...oe.projects[n],...t},ie(),oe.projects[n]},getProjectTemplates:async(e,t)=>(G(t?.signal),oe.projectTemplates),createProjectTemplate:async(e,t)=>{const s={...e,id:String(Date.now())};return oe.projectTemplates.push(s),ie(),s},getProjectAssignmentsByCompany:async(e,t)=>(G(t?.signal),oe.projectAssignments),getUserPerformanceMetrics:async e=>({totalHours:120,tasksCompleted:15}),createUser:async(e,t)=>{const s={...e,id:String(Date.now()),companyId:oe.users.find(e=>e.id===t)?.companyId};if(s.email&&(s.email=q(s.email)),e?.password){const t=await D(e.password);s.passwordHash=t.hash,s.passwordSalt=t.salt,delete s.password}return oe.users.push(s),ie(),le(s)},updateUser:async(e,t,s,n)=>{const r=oe.users.findIndex(t=>t.id===e);if(-1===r)throw new Error("User not found");const a={...t};if(a.email&&(a.email=q(a.email)),t?.password){const e=await D(t.password);a.passwordHash=e.hash,a.passwordSalt=e.salt,delete a.password}return oe.users[r]={...oe.users[r],...a},delete oe.users[r].password,void 0!==s&&(oe.projectAssignments=oe.projectAssignments.filter(t=>t.userId!==e),s.forEach(t=>oe.projectAssignments.push({userId:e,projectId:String(t)}))),ie(),le(oe.users[r])},prioritizeTasks:async(e,t,s)=>(await B(1e3),{prioritizedTaskIds:e.sort((e,t)=>(t.priority===E.HIGH?1:-1)-(e.priority===E.HIGH?1:-1)).map(e=>e.id)}),getMessagesForConversation:async(e,t,s)=>(G(s?.signal),oe.messages.filter(t=>t.conversationId===e).map(e=>({...e,timestamp:new Date(e.timestamp)}))),sendMessage:async(e,t,s,n)=>{let r=n?oe.conversations.find(e=>e.id===n):oe.conversations.find(s=>s.participantIds?.includes(e)&&s.participantIds?.includes(t));r||(r={id:String(Date.now()),participantIds:[e,t],lastMessage:null},oe.conversations.push(r));const a={id:String(Date.now()),conversationId:r.id,senderId:e,content:s,timestamp:new Date,isRead:!1};return oe.messages.push(a),r.lastMessage=a,ie(),{conversation:r,message:a}},getWhiteboardNotesByProject:async(e,t)=>(G(t?.signal),oe.whiteboardNotes.filter(t=>t.projectId===e)),createWhiteboardNote:async(e,t)=>{const s={...e,id:String(Date.now())};return oe.whiteboardNotes.push(s),ie(),s},updateWhiteboardNote:async(e,t,s)=>{const n=oe.whiteboardNotes.findIndex(t=>t.id===e);return oe.whiteboardNotes[n]={...oe.whiteboardNotes[n],...t},ie(),oe.whiteboardNotes[n]},deleteWhiteboardNote:async(e,t)=>{oe.whiteboardNotes=oe.whiteboardNotes.filter(t=>t.id!==e),ie()},createTodo:async(e,t)=>{const s={...e,id:String(Date.now()),status:w.TODO,createdAt:(new Date).toISOString()};return oe.todos.push(s),ie(),s},bulkUpdateTodos:async(e,t,s)=>{const n=new Set(e.map(String));oe.todos.forEach(e=>{n.has(e.id)&&Object.assign(e,t)}),ie()},getSiteUpdatesByProject:async(e,t)=>(G(t?.signal),oe.siteUpdates.filter(t=>t.projectId===e)),getProjectMessages:async(e,t)=>(G(t?.signal),oe.projectMessages.filter(t=>t.projectId===e)),getWeatherForLocation:async(e,t,s)=>(G(s?.signal),{temperature:18,condition:"Sunny",windSpeed:10,icon:"☀️"}),createSiteUpdate:async(e,t)=>{const s={...e,id:String(Date.now()),userId:t,timestamp:(new Date).toISOString()};return oe.siteUpdates.push(s),ie(),s},sendProjectMessage:async(e,t)=>{const s={...e,id:String(Date.now()),senderId:t,timestamp:(new Date).toISOString()};return oe.projectMessages.push(s),ie(),s}},ve=({children:e,className:t="",...s})=>u.jsx("div",{className:`bg-card text-card-foreground rounded-[--radius] border border-border p-6 shadow-sm transition-all duration-300 ${t}`,...s,children:e}),Ie=({size:e})=>u.jsxs("svg",{className:`animate-spin ${{sm:"h-4 w-4",md:"h-5 w-5",lg:"h-6 w-6"}[e]}`,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[u.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),u.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),Ae=({variant:e="primary",size:t="md",children:s,className:n="",isLoading:r=!1,disabled:a,...o})=>{const i=a||r;return u.jsxs("button",{className:`inline-flex items-center justify-center font-medium rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed ${{primary:"bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500",secondary:"bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500",outline:"border border-gray-300 text-gray-700 hover:bg-gray-50 focus:ring-blue-500",ghost:"text-gray-700 hover:bg-gray-100 focus:ring-gray-500"}[e]} ${{sm:"px-3 py-1.5 text-sm",md:"px-4 py-2 text-sm",lg:"px-6 py-3 text-base"}[t]} ${n}`,disabled:i,...o,children:[r&&u.jsx(Ie,{size:t}),u.jsx("span",{className:r?"ml-2":"",children:s})]})};class be{constructor(){this.loginAttempts=new Map,this.activeSessions=new Map,this.maxLoginAttempts=5,this.lockoutDuration=9e5,this.sessionTimeout=18e5}static getInstance(){return be.instance||(be.instance=new be),be.instance}hasPermission(e,t,s){if(!e)return!1;if(e.role===f.PRINCIPAL_ADMIN)return!0;const n=T[e.role];if(!n)return!1;const r=n.has(t);return r&&s?this.checkContextualPermissions(e,t,s):r}isAccountLocked(e){return(this.loginAttempts.get(e)||[]).filter(e=>!e.success&&Date.now()-e.timestamp<this.lockoutDuration).length>=this.maxLoginAttempts}recordLoginAttempt(e,t,s){const n=this.loginAttempts.get(e)||[];n.push({email:e,timestamp:Date.now(),success:t,...s});const r=Date.now()-864e5,a=n.filter(e=>e.timestamp>r);this.loginAttempts.set(e,a)}validatePasswordStrength(e){const t=[];return e.length<8&&t.push("Password must be at least 8 characters long"),/[a-z]/.test(e)||t.push("Password must contain at least one lowercase letter"),/[A-Z]/.test(e)||t.push("Password must contain at least one uppercase letter"),/\d/.test(e)||t.push("Password must contain at least one number"),/[!@#$%^&*(),.?":{}|<>]/.test(e)||t.push("Password must contain at least one special character"),this.isCommonPassword(e)&&t.push("Password is too common, please choose a more unique password"),{isValid:0===t.length,errors:t}}createSession(e,t){const s=this.generateSessionId(),n=new Set(T[e.role]||[]),r={user:e,sessionId:s,lastActivity:Date.now(),permissions:n,...t};return this.activeSessions.set(s,r),this.cleanupExpiredSessions(),s}validateSession(e){const t=this.activeSessions.get(e);return t?Date.now()-t.lastActivity>this.sessionTimeout?(this.activeSessions.delete(e),null):(t.lastActivity=Date.now(),t):null}revokeSession(e){return this.activeSessions.delete(e)}revokeAllUserSessions(e){let t=0;for(const[s,n]of this.activeSessions.entries())n.user.id===e&&(this.activeSessions.delete(s),t++);return t}getSecurityMetrics(){const e=Date.now()-36e5;let t=0,s=0,n=0;for(const r of this.loginAttempts.values()){const a=r.filter(t=>t.timestamp>e);t+=a.length,s+=a.filter(e=>!e.success).length;a.filter(e=>!e.success).length>=this.maxLoginAttempts&&n++}return{activeSessions:this.activeSessions.size,totalLoginAttempts:t,failedLoginAttempts:s,lockedAccounts:n,successRate:t>0?(t-s)/t*100:100}}checkContextualPermissions(e,t,s){return t===y.EDIT_USER&&s.userId?e.id===s.userId||this.hasPermission(e,y.MANAGE_USERS):(t===y.VIEW_PROJECT&&s.projectId,!0)}isCommonPassword(e){return["password","123456","123456789","qwerty","abc123","password123","admin","letmein","welcome","monkey"].includes(e.toLowerCase())}generateSessionId(){const e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}cleanupExpiredSessions(){const e=Date.now();for(const[t,s]of this.activeSessions.entries())e-s.lastActivity>this.sessionTimeout&&this.activeSessions.delete(t)}}const Se=(e,t)=>be.getInstance().hasPermission(e,t);be.getInstance();const Ne=n.createContext(void 0);let je=null;const Te=({children:e})=>{const[t,s]=n.useState({isAuthenticated:!1,token:null,refreshToken:null,user:null,company:null,loading:!0,error:null}),r=n.useCallback(()=>{localStorage.removeItem("token"),localStorage.removeItem("refreshToken"),je&&clearTimeout(je),s({isAuthenticated:!1,token:null,refreshToken:null,user:null,company:null,loading:!1,error:null})},[]),a=n.useCallback(e=>{je&&clearTimeout(je);const t=(e=>{try{return JSON.parse(atob(e.split(".")[1]))}catch(t){return null}})(e);if(t&&t.exp){const e=1e3*t.exp-Date.now()-6e4;e>0?je=setTimeout(async()=>{const e=localStorage.getItem("refreshToken");if(e)try{console.log("Proactively refreshing token...");const{token:t}=await ue.refreshToken(e);localStorage.setItem("token",t),s(e=>({...e,token:t})),a(t)}catch(t){console.error("Proactive token refresh failed",t),r()}},e):(console.warn("Token is already expired or has less than a minute left. Logging out."),r())}},[r]),o=n.useCallback(e=>{localStorage.setItem("token",e.token),localStorage.setItem("refreshToken",e.refreshToken),s({isAuthenticated:!0,token:e.token,refreshToken:e.refreshToken,user:e.user,company:e.company,loading:!1,error:null}),a(e.token)},[a]),i=n.useCallback(async()=>{const e=localStorage.getItem("token"),t=localStorage.getItem("refreshToken");if(e&&t)try{const{user:s,company:n}=await ue.me(e);o({token:e,refreshToken:t,user:s,company:n})}catch(n){console.log("Access token invalid, attempting reactive refresh...");try{const{token:e}=await ue.refreshToken(t),{user:s,company:n}=await ue.me(e);o({token:e,refreshToken:t,user:s,company:n})}catch(a){console.error("Auth init with refresh token failed, logging out.",a),r()}}else s(e=>({...e,loading:!1}))},[o,r]);n.useEffect(()=>(i(),()=>{je&&clearTimeout(je)}),[i]);const c={...t,login:async e=>{s(e=>({...e,loading:!0,error:null}));try{const t=await ue.login(e);return t.mfaRequired?(s(e=>({...e,loading:!1})),{mfaRequired:!0,userId:t.userId}):(o(t),{mfaRequired:!1})}catch(t){throw s(e=>({...e,token:null,refreshToken:null,user:null,company:null,isAuthenticated:!1,loading:!1,error:t.message||"Login failed"})),t}},register:async e=>{s(e=>({...e,loading:!0,error:null}));try{const t=await ue.register(e);o(t)}catch(t){throw s(e=>({...e,loading:!1,error:t.message||"Registration failed"})),t}},logout:r,hasPermission:e=>Se(t.user,e),verifyMfaAndFinalize:async(e,t)=>{s(e=>({...e,loading:!0,error:null}));try{const s=await ue.verifyMfa(e,t);o(s)}catch(n){throw s(e=>({...e,loading:!1,error:n.message||"MFA verification failed"})),n}},updateUserProfile:async e=>{if(!t.user)throw new Error("Not authenticated");const n=await xe.updateUser(t.user.id,e,void 0,t.user.id);s(e=>({...e,user:{...e.user,...n}}))},requestPasswordReset:async e=>{s(e=>({...e,loading:!0,error:null}));try{await ue.requestPasswordReset(e),s(e=>({...e,loading:!1}))}catch(t){throw s(e=>({...e,loading:!1,error:t.message||"Request failed"})),t}},resetPassword:async(e,t)=>{s(e=>({...e,loading:!0,error:null}));try{await ue.resetPassword(e,t),s(e=>({...e,loading:!1}))}catch(n){throw s(e=>({...e,loading:!1,error:n.message||"Password reset failed"})),n}}};return u.jsx(Ne.Provider,{value:c,children:e})},ke=()=>{const e=n.useContext(Ne);if(void 0===e)throw new Error("useAuth must be used within an AuthProvider");return e},_e=({onSwitchToRegister:e,onSwitchToForgotPassword:t})=>{const{login:s,verifyMfaAndFinalize:r,error:a,loading:o}=ke(),[i,c]=n.useState("credentials"),[l,d]=n.useState("admin@ascladding.com"),[m,p]=n.useState("password123"),[h,g]=n.useState(""),[f,y]=n.useState(!1),[w,E]=n.useState(null),[x,v]=n.useState({}),[I,A]=n.useState(null),b=n.useRef(null);n.useEffect(()=>{E(a)},[a]),n.useEffect(()=>{"mfa"===i&&b.current?.focus()},[i]);const S=async e=>{e.preventDefault(),E(null);const t={};if((e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))(l)||(t.email="Please enter a valid email."),m.length<6&&(t.password="Password is too short."),v(t),!(Object.keys(t).length>0))try{const e=await s({email:l,password:m,rememberMe:f});e.mfaRequired&&e.userId&&(A(e.userId),c("mfa"))}catch(n){}},N=async e=>{if(e.preventDefault(),E(null),6===h.length)try{if(!I)throw new Error("User ID not found");await r(I,h)}catch(t){}else v({mfa:"Code must be 6 digits."})};return u.jsxs("div",{className:"min-h-screen bg-background flex flex-col justify-center py-12 sm:px-6 lg:px-8",children:[u.jsxs("div",{className:"sm:mx-auto sm:w-full sm:max-w-md text-center",children:[u.jsxs("div",{className:"inline-flex items-center justify-center gap-2 mb-2",children:[u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",className:"w-10 h-10 text-primary",children:u.jsx("path",{fill:"currentColor",d:"M12 2L2 22h20L12 2z"})}),u.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"AS Agents"})]}),u.jsx("h2",{className:"text-muted-foreground",children:"Sign in to your account"})]}),u.jsxs(ve,{className:"mt-8 sm:mx-auto sm:w-full sm:max-w-md",children:[w&&u.jsx("div",{className:"mb-4 p-3 bg-destructive/10 text-destructive text-sm rounded-md border border-destructive/20",children:w}),"credentials"===i?u.jsxs("form",{onSubmit:S,className:"space-y-6",children:[u.jsxs("div",{children:[u.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-muted-foreground",children:"Email Address"}),u.jsx("input",{id:"email",type:"email",value:l,onChange:e=>d(e.target.value),required:!0,className:"mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm "+(x.email?"border-destructive":"border-border")}),x.email&&u.jsx("p",{className:"text-xs text-destructive mt-1",children:x.email})]}),u.jsxs("div",{children:[u.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-muted-foreground",children:"Password"}),u.jsx("input",{id:"password",type:"password",value:m,onChange:e=>p(e.target.value),required:!0,className:"mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm "+(x.password?"border-destructive":"border-border")}),x.password&&u.jsx("p",{className:"text-xs text-destructive mt-1",children:x.password})]}),u.jsxs("div",{className:"flex items-center justify-between",children:[u.jsxs("div",{className:"flex items-center",children:[u.jsx("input",{id:"remember-me",type:"checkbox",checked:f,onChange:e=>y(e.target.checked),className:"h-4 w-4 text-primary focus:ring-ring border-border rounded"}),u.jsx("label",{htmlFor:"remember-me",className:"ml-2 block text-sm text-muted-foreground",children:"Remember me"})]}),u.jsx("div",{className:"text-sm",children:u.jsx("button",{type:"button",onClick:t,className:"font-medium text-primary hover:text-primary/90",children:"Forgot your password?"})})]}),u.jsx("div",{children:u.jsx(Ae,{type:"submit",className:"w-full",isLoading:o,children:"Sign in"})})]}):u.jsxs("form",{onSubmit:N,className:"space-y-6",children:[u.jsxs("div",{className:"text-center",children:[u.jsx("h3",{className:"text-lg font-medium text-foreground",children:"Two-Factor Authentication"}),u.jsx("p",{className:"mt-1 text-sm text-muted-foreground",children:"Enter the 6-digit code from your authenticator app."})]}),u.jsxs("div",{children:[u.jsx("label",{htmlFor:"mfa",className:"sr-only",children:"Authentication Code"}),u.jsx("input",{id:"mfa",type:"text",ref:b,value:h,onChange:e=>g(e.target.value.replace(/\D/g,"")),maxLength:6,required:!0,className:"block w-full text-center text-2xl tracking-[0.5em] px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary "+(x.mfa?"border-destructive":"border-border")}),x.mfa&&u.jsx("p",{className:"text-xs text-destructive mt-1 text-center",children:x.mfa})]}),u.jsx("div",{children:u.jsx(Ae,{type:"submit",className:"w-full",isLoading:o,children:"Verify"})}),u.jsx("div",{className:"text-center",children:u.jsx("button",{type:"button",onClick:()=>c("credentials"),className:"text-sm font-medium text-primary hover:text-primary/90",children:"Back to login"})})]})]}),u.jsxs("p",{className:"mt-6 text-center text-sm text-muted-foreground",children:["Not a member?"," ",u.jsx("button",{onClick:e,className:"font-semibold text-primary hover:text-primary/80",children:"Create an account"})]})]})},Pe=({name:e,imageUrl:t,className:s=""})=>{if(t)return u.jsx("img",{src:t,alt:e,title:e,className:`rounded-full object-cover ${s}`});return u.jsx("div",{title:e,className:`rounded-full bg-slate-700 flex items-center justify-center text-white font-bold flex-shrink-0 ${s}`,children:(e=>{if(!e)return"";const t=e.split(" ").filter(e=>e.length>0);return t.length>1?`${t[0][0]}${t[t.length-1][0]}`.toUpperCase():1===t.length?t[0].substring(0,2).toUpperCase():""})(e)})},Ce={[f.OWNER]:"amber",[f.ADMIN]:"sky",[f.PROJECT_MANAGER]:"violet",[f.FOREMAN]:"emerald",[f.OPERATIVE]:"slate",[f.CLIENT]:"sky",[f.PRINCIPAL_ADMIN]:"rose"},Me={sky:"bg-sky-100 text-sky-700 border-sky-200 dark:bg-sky-500/10 dark:text-sky-200 dark:border-sky-500/30",emerald:"bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-500/10 dark:text-emerald-200 dark:border-emerald-500/30",amber:"bg-amber-100 text-amber-700 border-amber-200 dark:bg-amber-500/10 dark:text-amber-200 dark:border-amber-500/30",violet:"bg-violet-100 text-violet-700 border-violet-200 dark:bg-violet-500/10 dark:text-violet-200 dark:border-violet-500/30",slate:"bg-slate-100 text-slate-700 border-slate-200 dark:bg-slate-500/10 dark:text-slate-200 dark:border-slate-500/30",rose:"bg-rose-100 text-rose-700 border-rose-200 dark:bg-rose-500/10 dark:text-rose-200 dark:border-rose-500/30"},De=e=>e.replace(/_/g," ").toLowerCase().replace(/\b\w/g,e=>e.toUpperCase()),Re=({role:e,className:t=""})=>{const s=Ce[e]??"slate";return u.jsxs("span",{className:`inline-flex items-center gap-1 rounded-full border px-2.5 py-0.5 text-xs font-semibold tracking-wide uppercase ${Me[s]} ${t}`.trim(),"aria-label":`User role ${De(e)}`,children:[u.jsx("span",{className:"h-1.5 w-1.5 rounded-full bg-current"}),De(e)]})},Le="h-5 w-5",Oe={dashboard:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"})}),tasks:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-5 8l2 2 4-4"})}),projects:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})}),map:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 16.382V5.618a1 1 0 00-1.447-.894L15 7m0 13V7m0 0L9 4"})}),time:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"})}),timesheets:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"})}),documents:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),safety:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"})}),financials:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"})}),team:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656-.126-1.283-.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),chat:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),equipment:u.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[u.jsx("path",{d:"M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"}),u.jsx("path",{d:"M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"})]}),templates:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 10h16M4 14h16M4 18h16"})}),tools:u.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),u.jsx("path",{d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]}),audit:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 4a1 1 0 011-1h16a1 1 0 011 1v14a1 1 0 01-1 1h-6l-4 4v-4H4a1 1 0 01-1-1V4z"})}),settings:u.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),u.jsx("path",{d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]}),clients:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656-.126-1.283-.356-1.857M9 7a3 3 0 116 0 3 3 0 01-6 0zm10 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),invoices:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:Le,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-4 4h4m-4 4h4m-4 4h4m-8-8h.01m-.01 4h.01m-.01 4h.01"})})},Ve=[{id:"overview",title:"Overview",items:[{id:"dashboard",label:e=>e.role===f.OPERATIVE?"My Day":e.role===f.FOREMAN?"Field Dashboard":e.role===f.PRINCIPAL_ADMIN?"Platform Overview":"Operations Dashboard",view:"dashboard",icon:Oe.dashboard,description:"Stay on top of your jobs, resources, and risk alerts.",getView:e=>e.role===f.OPERATIVE?"my-day":e.role===f.FOREMAN?"foreman-dashboard":e.role===f.PRINCIPAL_ADMIN?"principal-dashboard":"dashboard"},{id:"all-tasks",label:"Task Command Center",view:"all-tasks",icon:Oe.tasks,description:"Monitor and reassign open tasks across the portfolio.",requiredPermissions:[y.VIEW_ALL_TASKS]},{id:"projects",label:"Project Portfolio",view:"projects",icon:Oe.projects,description:"Access every job you own or are assigned to.",isVisible:e=>Se(e,y.VIEW_ALL_PROJECTS)||Se(e,y.VIEW_ASSIGNED_PROJECTS)},{id:"map",label:"Geospatial Map",view:"map",icon:Oe.map,description:"Visualise active projects on a live map.",isVisible:e=>Se(e,y.VIEW_ALL_PROJECTS)||Se(e,y.VIEW_ASSIGNED_PROJECTS)}]},{id:"operations",title:"Site Operations",items:[{id:"time",label:"Time Clock",view:"time",icon:Oe.time,description:"Clock in/out and capture labour hours.",requiredPermissions:[y.SUBMIT_TIMESHEET]},{id:"timesheets",label:"Timesheet Approvals",view:"timesheets",icon:Oe.timesheets,description:"Review pending submissions awaiting approval.",requiredPermissions:[y.VIEW_ALL_TIMESHEETS],getBadge:e=>e.pendingTimesheetCount},{id:"documents",label:"Document Vault",view:"documents",icon:Oe.documents,description:"Manage drawings, RFIs, and permits by project.",requiredPermissions:[y.VIEW_DOCUMENTS]},{id:"safety",label:"Safety & Compliance",view:"safety",icon:Oe.safety,description:"Track incidents, toolbox talks, and inspections.",requiredPermissions:[y.VIEW_SAFETY_REPORTS],getBadge:e=>e.openIncidentCount},{id:"equipment",label:"Equipment Control",view:"equipment",icon:Oe.equipment,description:"Monitor utilisation and maintenance windows.",requiredPermissions:[y.MANAGE_EQUIPMENT]}]},{id:"collaboration",title:"Collaboration",items:[{id:"team",label:"Workforce",view:"users",icon:Oe.team,description:"Coordinate staffing and availability.",requiredPermissions:[y.VIEW_TEAM]},{id:"chat",label:"Team Chat",view:"chat",icon:Oe.chat,description:"Direct messaging across crews and offices.",requiredPermissions:[y.SEND_DIRECT_MESSAGE],getBadge:e=>e.unreadMessageCount},{id:"clients",label:"Client Directory",view:"clients",icon:Oe.clients,description:"Centralise client contacts and account health.",isVisible:e=>Se(e,y.VIEW_ALL_PROJECTS)||e.role===f.ADMIN||e.role===f.OWNER}]},{id:"business",title:"Commercial",items:[{id:"financials",label:"Financials",view:"financials",icon:Oe.financials,description:"Track burn rate, budget variances, and forecasts.",requiredPermissions:[y.VIEW_FINANCES]},{id:"invoices",label:"Invoices",view:"invoices",icon:Oe.invoices,description:"Review accounts receivable and billing status.",requiredPermissions:[y.VIEW_FINANCES]},{id:"templates",label:"Project Templates",view:"templates",icon:Oe.templates,description:"Standardise bids, schedules, and document packs.",requiredPermissions:[y.MANAGE_PROJECT_TEMPLATES]},{id:"tools",label:"Intelligence Tools",view:"tools",icon:Oe.tools,description:"AI co-pilots for risk, bidding, and reporting.",requiredPermissions:[y.ACCESS_ALL_TOOLS]},{id:"audit",label:"Audit Log",view:"audit-log",icon:Oe.audit,description:"Trace configuration and data changes platform-wide.",requiredPermissions:[y.VIEW_AUDIT_LOG]},{id:"settings",label:"Workspace Settings",view:"settings",icon:Oe.settings,description:"Control company preferences, integrations, and theme."}]}],$e=(e,t)=>"function"==typeof e.label?e.label(t):e.label,Ue=(e,t)=>Ve.map(s=>{const n=s.items.filter(t=>((e,t)=>!(e.roles&&!e.roles.includes(t.role)||e.excludeRoles&&e.excludeRoles.includes(t.role)||e.requiredPermissions&&!e.requiredPermissions.every(e=>Se(t,e))||e.anyPermissions&&!e.anyPermissions.some(e=>Se(t,e))||e.isVisible&&!e.isVisible(t)))(t,e)).map(s=>{const n=s.getView?s.getView(e):s.view,r=s.getBadge?s.getBadge(t,e):void 0;return{id:s.id,label:$e(s,e),view:n,icon:s.icon,badgeCount:r,description:s.description}});return 0===n.length||s.roles&&!s.roles.includes(e.role)?null:{id:s.id,title:s.title,items:n}}).filter(e=>Boolean(e)),Fe=({title:e,children:t})=>u.jsxs("div",{className:"space-y-2",children:[u.jsx("h2",{className:"px-3 text-[0.7rem] font-semibold uppercase tracking-[0.18em] text-muted-foreground",children:e}),u.jsx("div",{className:"space-y-1.5",children:t})]}),Be=({icon:e,label:t,view:s,activeView:n,setActiveView:r,badgeCount:a,description:o})=>{const i=n===s;return u.jsxs("button",{onClick:()=>r(s),className:"group flex w-full items-center justify-between gap-3 rounded-xl px-3 py-2.5 text-sm transition-all duration-200 "+(i?"bg-primary text-primary-foreground shadow-lg shadow-primary/20":"border border-transparent text-muted-foreground hover:border-border/70 hover:bg-muted/70 hover:text-foreground"),title:o,children:[u.jsxs("span",{className:"flex items-center gap-3 text-left",children:[u.jsx("span",{className:"flex h-9 w-9 items-center justify-center rounded-lg border text-base transition-colors "+(i?"border-primary-foreground/60 bg-primary-foreground/20":"border-border bg-card group-hover:border-primary/40 group-hover:text-primary"),"aria-hidden":!0,children:e}),u.jsx("span",{className:"font-medium leading-tight",children:t})]}),void 0!==a&&a>0&&u.jsx("span",{className:"ml-auto inline-flex min-w-[1.75rem] justify-center rounded-full bg-red-500 px-2 py-0.5 text-xs font-semibold text-white",children:a>99?"99+":a})]})},Ge=({user:e,activeView:t,setActiveView:s,onLogout:r,pendingTimesheetCount:a,openIncidentCount:o,unreadMessageCount:i,companyName:c})=>{if(!e)return null;const l=n.useMemo(()=>({pendingTimesheetCount:a,openIncidentCount:o,unreadMessageCount:i}),[a,o,i]),d=n.useMemo(()=>Ue(e,l),[e,l]),m=`${e.firstName} ${e.lastName}`.trim(),p=(e=>e||null)(c);return u.jsxs("aside",{className:"flex h-full w-72 flex-shrink-0 flex-col border-r border-border/80 bg-card/95 p-5",children:[u.jsxs("div",{className:"mb-6 space-y-4",children:[u.jsxs("div",{className:"flex items-center gap-2 px-1",children:[u.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:"h-8 w-8 text-primary","aria-hidden":!0,children:[u.jsx("path",{fill:"currentColor",d:"M12 2l9.196 5.31a1 1 0 01.5.866v10.648a1 1 0 01-.5.866L12 24l-9.196-4.31a1 1 0 01-.5-.866V8.176a1 1 0 01.5-.866L12 2z",opacity:.12}),u.jsx("path",{fill:"currentColor",d:"M12 4.5l-6.5 3.752v7.496L12 19.5l6.5-3.752V8.252L12 4.5zm0 1.732l5 2.886v5.764l-5 2.886-5-2.886V9.118l5-2.886z"})]}),u.jsxs("div",{className:"leading-tight",children:[u.jsx("p",{className:"text-xs font-semibold uppercase tracking-[0.32em] text-muted-foreground",children:"AS Agents"}),u.jsx("p",{className:"text-lg font-semibold text-foreground",children:"Project Command"})]})]}),u.jsx("div",{className:"rounded-2xl border border-border/60 bg-gradient-to-br from-primary/10 via-transparent to-transparent p-4",children:u.jsxs("div",{className:"flex items-center gap-3",children:[u.jsx(Pe,{name:m,imageUrl:e.avatar,className:"h-12 w-12"}),u.jsxs("div",{className:"min-w-0",children:[u.jsx("p",{className:"truncate text-sm font-semibold text-foreground",children:m}),u.jsx(Re,{role:e.role,className:"mt-1"}),p&&u.jsx("p",{className:"mt-1 truncate text-xs text-muted-foreground",children:p})]})]})})]}),u.jsx("nav",{"aria-label":"Main navigation",className:"flex-1 space-y-6 overflow-y-auto pr-1",children:d.map(e=>u.jsx(Fe,{title:e.title,children:e.items.map(e=>u.jsx(Be,{view:e.view,icon:e.icon,label:e.label,activeView:t,setActiveView:s,badgeCount:e.badgeCount,description:e.description},e.id))},e.id))}),u.jsx("div",{className:"mt-6",children:u.jsxs("button",{onClick:r,className:"flex w-full items-center justify-center gap-2 rounded-xl border border-red-200/70 bg-red-500/10 px-3 py-2 text-sm font-semibold text-red-600 transition hover:bg-red-500/20",children:[u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",className:"h-5 w-5",fill:"none",stroke:"currentColor",strokeWidth:2,children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 7l-5 5 5 5M4 12h11"})}),"Sign out"]})})]})},ze=({user:e,notifications:t,onClose:s,addToast:n,onNotificationClick:a,onMarkAllAsRead:o})=>{const[i,c]=r.useState(!1),l=t.some(e=>!(e.isRead??e.read));return u.jsx(ve,{className:"absolute right-0 top-12 w-80 max-h-96 overflow-y-auto z-50 shadow-lg",children:u.jsxs("div",{className:"p-4",children:[u.jsxs("div",{className:"flex justify-between items-center mb-4",children:[u.jsx("h3",{className:"text-lg font-semibold",children:"Notifications"}),u.jsxs("div",{className:"flex items-center space-x-2",children:[l&&u.jsx(Ae,{variant:"ghost",size:"sm",onClick:async()=>{if(o){c(!0);try{await o(),n("All notifications marked as read","success")}catch(e){n("Failed to mark notifications as read","error")}finally{c(!1)}}},disabled:i,children:i?"Marking...":"Mark all read"}),u.jsx("button",{onClick:s,className:"text-gray-400 hover:text-gray-600",children:"×"})]})]}),0===t.length?u.jsxs("div",{className:"text-center py-8 text-gray-500",children:[u.jsx("div",{className:"text-4xl mb-2",children:"📭"}),u.jsx("p",{children:"No notifications"})]}):u.jsx("div",{className:"space-y-3",children:t.map(e=>{const t=!(e.isRead??e.read);return u.jsx("div",{onClick:()=>(e=>{a&&a(e),s()})(e),className:`p-3 rounded-lg cursor-pointer transition-colors ${t?"bg-blue-50 border-blue-200":"bg-gray-50 hover:bg-gray-100"} border`,children:u.jsxs("div",{className:"flex items-start space-x-3",children:[t&&u.jsx("div",{className:"flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2"}),u.jsxs("div",{className:"flex-1 min-w-0",children:[u.jsx("p",{className:"text-sm "+(t?"font-semibold":"font-medium"),children:e.title}),e.message&&u.jsx("p",{className:"text-sm text-gray-600 mt-1",children:e.message}),u.jsx("p",{className:"text-xs text-gray-500 mt-1",children:new Date(e.createdAt).toLocaleDateString()})]})]})},e.id)})})]})})},We=({user:e,onLogout:t,onSearchClick:s,onCommandPaletteClick:r,unreadNotificationCount:a,notifications:o,onNotificationClick:i,onMarkAllNotificationsAsRead:c,addToast:l})=>{const[d,m]=n.useState(!1),[p,h]=n.useState(!1),g=`${e.firstName} ${e.lastName}`;return u.jsxs("header",{className:"sticky top-0 z-30 bg-background/80 backdrop-blur-lg border-b border-border h-16 flex-shrink-0 flex items-center justify-end px-6 gap-4",children:[u.jsx("button",{onClick:s,className:"p-2 rounded-full hover:bg-accent text-muted-foreground",children:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),u.jsxs("button",{onClick:r,className:"p-2 rounded-lg hover:bg-accent text-muted-foreground hidden md:flex items-center gap-2 border text-xs",children:[u.jsx("kbd",{children:"⌘"}),u.jsx("kbd",{children:"K"})]}),u.jsxs("div",{className:"relative",children:[u.jsxs("button",{onClick:()=>h(e=>!e),className:"p-2 rounded-full hover:bg-accent text-muted-foreground relative",children:[u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"})}),a>0&&u.jsx("span",{className:"absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-background"})]}),p&&u.jsx(ze,{user:e,notifications:o,onClose:()=>h(!1),addToast:l,onNotificationClick:i,onMarkAllAsRead:c})]}),u.jsxs("div",{className:"relative",children:[u.jsxs("button",{onClick:()=>m(e=>!e),className:"flex items-center gap-2",children:[u.jsx(Pe,{name:g,imageUrl:e.avatar,className:"w-9 h-9"}),u.jsxs("div",{className:"hidden md:block text-left",children:[u.jsx("p",{className:"text-sm font-semibold text-foreground",children:g}),u.jsx("p",{className:"text-xs text-muted-foreground",children:e.role.replace(/_/g," ")})]})]}),d&&u.jsxs("div",{className:"absolute right-0 mt-2 w-48 bg-card rounded-md shadow-lg border border-border z-10 py-1",children:[u.jsx("a",{href:"#",className:"block px-4 py-2 text-sm text-card-foreground hover:bg-accent",children:"My Profile"}),u.jsx("button",{onClick:t,className:"w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-500/10",children:"Logout"})]})]})]})},qe={maxAttempts:3,baseDelay:1e3,maxDelay:1e4,backoffFactor:2,retryCondition:e=>"AbortError"!==e.name&&(!e.message.includes("401")&&!e.message.includes("403")&&!e.message.includes("404"))};class He extends Error{constructor(e,t,s={}){super(e),this.name="AppError",this.id=`error_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,this.context=t,this.severity=s.severity||"medium",this.userMessage=s.userMessage||this.getDefaultUserMessage(),this.isRetryable=s.isRetryable??!0,s.cause&&(this.stack=`${this.stack}\nCaused by: ${s.cause.stack}`)}getDefaultUserMessage(){const e=this.context.operation.toLowerCase();return e.includes("load")||e.includes("fetch")?"Failed to load data. Please try again.":e.includes("save")||e.includes("create")||e.includes("update")?"Failed to save changes. Please try again.":e.includes("delete")?"Failed to delete item. Please try again.":e.includes("upload")?"Failed to upload file. Please check your connection and try again.":"An unexpected error occurred. Please try again."}toReport(){return{id:this.id,message:this.message,stack:this.stack,context:this.context,userAgent:navigator.userAgent,url:window.location.href,severity:this.severity}}}function Je(e,t,s){if(e instanceof He)return e;const n=e instanceof Error?e.message:String(e),r=e instanceof Error?e:void 0;return new He(n,t,{...s,cause:r})}const Ye=new class{constructor(){this.reportQueue=[],this.reportTimeout=null,this.BATCH_SIZE=10,this.BATCH_DELAY=2e3}report(e){this.reportQueue.push(e.toReport()),this.reportTimeout&&clearTimeout(this.reportTimeout),this.reportTimeout=window.setTimeout(()=>{this.flushReports()},this.BATCH_DELAY),this.reportQueue.length>=this.BATCH_SIZE&&this.flushReports()}flushReports(){if(0===this.reportQueue.length)return;const e=[...this.reportQueue];this.reportQueue=[],this.reportTimeout&&(clearTimeout(this.reportTimeout),this.reportTimeout=null),console.group("📊 Error Reports Batch"),e.forEach(e=>{console.error(`[${e.severity.toUpperCase()}] ${e.message}`,e)}),console.groupEnd()}};const Ke={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_GEMINI_API_KEY:"your_gemini_api_key_here",VITE_SUPABASE_ANON_KEY:"your_supabase_anon_key_here",VITE_SUPABASE_URL:"your_supabase_url_here"};var Qe={};const Ze={VITE_API_BASE_URL:"__ASAGENTS_API_BASE_URL__"},Xe=e=>{if("string"!=typeof e)return null;const t=e.trim();return t.length>0?t:null},et=e=>{if(null==e)return null;if("boolean"==typeof e)return e;const t=String(e).trim().toLowerCase();return t?!!["1","true","yes","on","enabled"].includes(t)||!["0","false","no","off","disabled"].includes(t)&&null:null},tt=e=>{try{const t=void 0!==import.meta?Ke:void 0,s=t?t[e]:void 0;return"string"==typeof s?s:void 0}catch(t){return void console.warn("[environment] Unable to read value from import.meta.env",e,t)}},st=e=>{try{const t="undefined"!=typeof process?Qe:void 0,s=t?t[e]:void 0;return"string"==typeof s?s:void 0}catch(t){return void console.warn("[environment] Unable to read value from process.env",e,t)}},nt=e=>{if("undefined"==typeof window)return;const t=Ze[e];if(!t)return;const s=window[t];return"string"==typeof s?s:void 0},rt=(e,t=[])=>{const s=[e,...t];for(const n of s){const e=tt(n)??st(n)??nt(n),t=Xe(e);if(t)return t}return null};let at=null;const ot=()=>(at||(at=(()=>{const e=et(rt("VITE_USE_SUPABASE"))??!1,t=et(rt("VITE_ALLOW_MOCK_FALLBACK")),s="undefined"!=typeof process&&(Boolean(Qe?.VITEST)||Boolean(Qe?.VITEST_WORKER_ID)),n=e||s?null:rt("VITE_API_BASE_URL",["API_BASE_URL"]);return e&&"undefined"!=typeof console&&console.warn("[environment] VITE_USE_SUPABASE is enabled but Supabase client wiring is pending. Falling back to mock auth."),{apiBaseUrl:n,analyticsWriteKey:rt("VITE_ANALYTICS_WRITE_KEY",["ANALYTICS_WRITE_KEY"]),geminiApiKey:rt("VITE_GEMINI_API_KEY",["GEMINI_API_KEY"]),mapboxToken:rt("VITE_MAPBOX_TOKEN",["MAPBOX_TOKEN"]),supabaseUrl:rt("VITE_SUPABASE_URL",["SUPABASE_URL"]),supabaseAnonKey:rt("VITE_SUPABASE_ANON_KEY",["SUPABASE_ANON_KEY"]),featureFlags:{useSupabaseAuth:e,allowMockFallback:t}}})()),at),it="gemini-2.0-flash-001";let ct=null,lt=null;const dt={temperature:.35,maxOutputTokens:768},ut=async(e,t={})=>{const s=(()=>{const{geminiApiKey:e}=ot();if(!e)return null;if(ct&&lt===e)return ct;try{return ct=new a({apiKey:e}),lt=e,ct}catch(t){return ct=null,lt=null,console.error("Failed to initialise Gemini client",t),null}})();if(!s)return null;const n=`ai:${btoa(e).slice(0,50)}:${JSON.stringify(t)}`,r=$.get(n);if(r)return r;try{const r={...dt,...t},a=await async function(e,t={},s){const n={...qe,...t};let r,a=n.baseDelay;for(let i=1;i<=n.maxAttempts;i++)try{return await e()}catch(o){if(r=o instanceof Error?o:new Error(String(o)),i===n.maxAttempts)break;if(n.retryCondition&&!n.retryCondition(r))break;await new Promise(e=>setTimeout(e,a)),a=Math.min(a*n.backoffFactor,n.maxDelay),console.warn(`Retry attempt ${i}/${n.maxAttempts} for operation`,{error:r.message,context:s,nextDelay:a})}throw r}(async()=>await s.models.generateContent({model:it,contents:e,config:r}),{maxAttempts:3,delay:1e3,backoff:"exponential"});return a&&$.set(n,a,6e5),a}catch(o){const s=Je(o,{operation:"callGemini",component:"ai-service",metadata:{prompt:e.slice(0,100),config:t}});return console.error("Gemini request failed",s),null}},mt=(e,t="GBP")=>new Intl.NumberFormat("en-GB",{style:"currency",currency:t,maximumFractionDigits:0}).format(e),pt=e=>Math.max(0,Math.min(100,Math.round(e))),ht=e=>{if(!Number.isFinite(e))return"0%";const t=Number(e.toFixed(1));return`${t>0?"+":""}${t}%`},gt=e=>{const t=e.length,s=e.filter(e=>e.status===w.DONE).length,n=e.filter(e=>e.status===w.IN_PROGRESS).length;return{total:t,completed:s,inProgress:n,notStarted:t-s-n,averageProgress:0===t?0:Math.round(e.reduce((e,t)=>e+(t.progress??(t.status===w.DONE?100:0)),0)/t)}},ft=(e=[])=>{const t=e.filter(e=>"RESOLVED"!==e.status),s=t.filter(e=>e.severity===b.HIGH).length;return{total:e.length,open:t.length,highSeverity:s}},yt=(e=[])=>{const t=e.reduce((e,t)=>e+(t.amount||0),0);return{count:e.length,totalAmount:t}},wt=async e=>{const t=`You are an experienced construction operations analyst. Review the project information and produce a concise status update with:\n1. A one-line overall health classification (e.g., On Track, Needs Attention) using bold text.\n2. Bullet points covering progress, budget position, safety signals, and actionable recommendations.\n3. Keep the tone practical and data-driven, using figures from the context. If information is missing, acknowledge it rather than inventing details.\n\n${(({project:e,tasks:t,incidents:s,expenses:n})=>{const r=t.slice(0,12).map(e=>`- ${e.title||e.text}: status=${e.status} priority=${e.priority} progress=${e.progress??0}%`).join("\n"),a=(s??[]).slice(0,8).map(e=>`- ${e.title} (${e.severity}) status=${e.status}`).join("\n"),o=(n??[]).slice(0,8).map(e=>`- ${e.description} – ${mt(e.amount)} (${e.status})`).join("\n");return`Project overview:\nName: ${e.name}\nStatus: ${e.status}\nBudget: ${mt(e.budget)}\nActual cost: ${mt(e.actualCost)}\nProgress value: ${e.progress}%\nLocation: ${e.location.address}\n\nTasks:\n${r||"No active tasks listed."}\n\nSafety incidents:\n${a||"No incidents recorded."}\n\nExpenses:\n${o||"No expenses logged."}`})(e)}\n\nRespond in Markdown using bullet points as requested.`,s=await ut(t);if(s?.text){const t=s.text.trim();if(t.length>0){const n=gt(e.tasks),r=ft(e.incidents),a=yt(e.expenses),o=e.project.budget>0?e.project.actualCost/e.project.budget*100:0,i={completedTasks:n.completed,totalTasks:n.total,averageProgress:n.averageProgress,budgetUtilisation:o,openIncidents:r.open,highSeverityIncidents:r.highSeverity,expenseTotal:a.totalAmount,isFallback:!1};return s.modelVersion&&(i.modelVersion=s.modelVersion),s.usageMetadata&&(i.usageMetadata=s.usageMetadata),{summary:t,model:s.modelVersion??it,isFallback:!1,metadata:i}}}return(e=>{const{project:t,tasks:s,incidents:n=[],expenses:r=[]}=e,a=gt(s),o=ft(n),i=yt(r),c=t.budget>0?t.actualCost/t.budget*100:0,l=((e,t,s)=>t>110||e<40?"At Risk":t>95||s>1?"Needs Attention":e>85&&t<95&&0===s?"On Track":"Stable")(a.averageProgress,c,o.open);return{summary:[`Project health assessment for **${t.name}**: status **${l}**.`,`- **Progress:** ${pt(a.averageProgress)}% average progress with ${a.completed}/${a.total} tasks completed (${a.inProgress} in progress, ${a.notStarted} pending).`,`- **Budget:** ${pt(c)}% of the ${mt(t.budget)} budget used (${mt(t.actualCost)} spent).`,`- **Safety:** ${o.open} open incident(s) (${o.highSeverity} high severity) out of ${o.total} reported.`,`- **Expenses:** ${i.count} logged entries totalling ${mt(i.totalAmount)}.`,"- **Recommendation:** Focus on clearing blockers and monitor spending against contingency to keep the project on track."].join("\n"),isFallback:!0,metadata:{completedTasks:a.completed,totalTasks:a.total,averageProgress:a.averageProgress,budgetUtilisation:c,openIncidents:o.open,highSeverityIncidents:o.highSeverity,expenseTotal:i.totalAmount,isFallback:!0}}})(e)},Et=async e=>{const t=`You are an AI assistant embedded in a construction management platform. Answer the user's query using only the information in the context. If you cannot find a specific answer, suggest which dataset or module should be consulted.\n\nUser query: ${e.query}\n\nContext:\n${(e=>{const{project:t,tasks:s=[],documents:n=[],incidents:r=[],expenses:a=[]}=e;return`${t?`Focus project: ${t.name} (${t.status}) in ${t.location.address}. Budget ${mt(t.budget)}; spent ${mt(t.actualCost)}.`:"Focus project: not specified."}\n\nRelevant tasks:\n${s.slice(0,15).map(e=>`- [${e.projectId}] ${e.title||e.text} (status=${e.status}, priority=${e.priority}, due=${e.dueDate})`).join("\n")||"No tasks available."}\n\nDocuments:\n${n.slice(0,12).map(e=>`- [${e.projectId??"n/a"}] ${e.name} (${e.category||e.type}) tags=${e.tags?.join(", ")??"none"}`).join("\n")||"No documents captured."}\n\nSafety incidents:\n${r.slice(0,12).map(e=>`- [${e.projectId}] ${e.title} severity=${e.severity} status=${e.status}`).join("\n")||"No incidents logged."}\n\nExpenses:\n${a.slice(0,8).map(e=>`- [${e.projectId}] ${e.description} amount=${mt(e.amount)} status=${e.status}`).join("\n")||"No expenses recorded."}`})(e)}\n\nRespond with concise Markdown. Prioritise actionable insights, references to document names, task IDs, or incident statuses when relevant.`,s=await ut(t,{maxOutputTokens:512});if(s?.text){const e=s.text.trim();if(e.length>0)return{text:e,model:s.modelVersion??it,isFallback:!1}}return(e=>{const{query:t,tasks:s=[],documents:n=[],incidents:r=[],expenses:a=[]}=e,o=t.toLowerCase(),i=s.filter(e=>[e.title,e.text,e.description].filter(Boolean).some(e=>e.toLowerCase().includes(o))),c=n.filter(e=>[e.name,e.category,...e.tags??[]].filter(Boolean).some(e=>e.toLowerCase().includes(o))),l=r.filter(e=>[e.title,e.description].filter(Boolean).some(e=>e.toLowerCase().includes(o))),d=a.filter(e=>[e.description,e.category].filter(Boolean).some(e=>e.toLowerCase().includes(o))),u=[`AI search results for "${t}":`];return i.length&&(u.push("- Tasks:"),i.slice(0,5).forEach(e=>{u.push(`  • ${e.title||e.text} (project ${e.projectId}, status ${e.status})`)})),c.length&&(u.push("- Documents:"),c.slice(0,5).forEach(e=>{u.push(`  • ${e.name} (${e.category||e.type})`)})),l.length&&(u.push("- Safety incidents:"),l.slice(0,3).forEach(e=>{u.push(`  • ${e.title} (${e.severity}, status ${e.status})`)})),d.length&&(u.push("- Expenses:"),d.slice(0,3).forEach(e=>{u.push(`  • ${e.description} (${mt(e.amount)})`)})),1===u.length?u.push("- No matching records found. Consider refining the query or checking another project."):u.push("- Tip: run a broader search or open the related module for full context."),{text:u.join("\n"),isFallback:!0}})(e)},xt=async e=>{const t=Number.isFinite(e.horizonMonths)?Math.max(1,Math.round(e.horizonMonths)):3,s=((e,t)=>{const s=e.monthly??[],n=s.map(e=>e.profit??0),r=s.length,a=n.reduce((e,t)=>e+t,0),o=r>0?a/r:0,i=r>0?n[r-1]:0,c=r>1?n[r-2]:i,l=r>1&&0!==c?(i-c)/Math.abs(c)*100:0,d=Number.isFinite(l)?l:0,u=(e.invoices??[]).reduce((e,t)=>t&&t.status!==v.PAID&&t.status!==v.CANCELLED?e+("number"==typeof t.balance?t.balance:Math.max((t.total??0)-(t.amountPaid??0),0)):e,0),m=(e.expenses??[]).filter(e=>e.status===x.APPROVED||e.status===x.PAID).reduce((e,t)=>e+(t.amount??0),0),p=r>0?m/r:m,h=e.kpis?.cashFlow??0;return{monthsCount:r,averageProfit:o,lastProfit:i,profitTrendPct:d,openInvoiceBalance:u,approvedExpenseTotal:m,approvedExpenseRunRate:p,cashFlow:h,currency:e.currency||e.kpis?.currency||"GBP",projectedCash:h+t*(o-p)}})(e,t),n=`You are the CFO co-pilot for a construction company. Draft an actionable cash flow and profitability outlook for the next ${t} month(s).\n- Emphasise momentum (improving or declining) and quantify expected profit/runway.\n- Highlight risks, e.g. outstanding invoices or elevated spend, and suggest mitigations.\n- Keep it to 4-5 concise bullet points, using bold sparingly for key figures.\n- Base recommendations strictly on the provided data.\n\n${((e,t)=>{const s=(e.monthly??[]).map(e=>`- ${e.month}: revenue ${mt(e.revenue,t.currency)}, profit ${mt(e.profit,t.currency)}`).join("\n"),n=(e.costs??[]).map(e=>`- ${e.category}: ${mt(e.amount,t.currency)}`).join("\n"),r=(e.invoices??[]).filter(e=>e.status!==v.PAID&&e.status!==v.CANCELLED).slice(0,8).map(e=>{const s="number"==typeof e.balance?e.balance:Math.max((e.total??0)-(e.amountPaid??0),0);return`- ${e.invoiceNumber||e.id}: ${e.status} • total ${mt(e.total??0,t.currency)} • balance ${mt(s,t.currency)}`}).join("\n"),a=(e.expenses??[]).filter(e=>e.status===x.APPROVED||e.status===x.PAID).slice(0,8).map(e=>`- ${e.description}: ${mt(e.amount,e.currency||t.currency)} (${e.status})`).join("\n");return`Company: ${e.companyName}\nCurrency in use: ${t.currency}\nPlanning horizon: ${e.horizonMonths} month(s)\nCurrent KPIs: profitability ${"number"==typeof e.kpis?.profitability?`${e.kpis.profitability}%`:"n/a"}, project margin ${"number"==typeof e.kpis?.projectMargin?`${e.kpis.projectMargin}%`:"n/a"}, cash flow ${mt(t.cashFlow,t.currency)}\n\nMonthly revenue and profit history:\n${s||"No monthly history captured."}\n\nCost allocation snapshot:\n${n||"No cost breakdown provided."}\n\nOutstanding invoices:\n${r||"All invoices are settled."}\n\nApproved or paid expenses:\n${a||"No approved expenses logged."}\n\nDerived metrics:\n- Average monthly profit: ${mt(t.averageProfit,t.currency)}\n- Profit trend vs prior month: ${ht(t.profitTrendPct)}\n- Open invoice balance: ${mt(t.openInvoiceBalance,t.currency)}\n- Expense run rate: ${mt(t.approvedExpenseRunRate,t.currency)} per month\n- Projected cash position (${e.horizonMonths} mo): ${mt(t.projectedCash,t.currency)}\n- Notes: Focus on actionable recommendations and highlight risks to runway.`})({...e,horizonMonths:t},s)}\n\nRespond in Markdown using bullet points.`,r=await ut(n,{maxOutputTokens:768,temperature:.3});if(r?.text){const e=r.text.trim();if(e.length>0){const n={horizonMonths:t,averageMonthlyProfit:s.averageProfit,projectedCash:s.projectedCash,profitTrendPct:Number(s.profitTrendPct.toFixed(1)),openInvoiceBalance:s.openInvoiceBalance,approvedExpenseRunRate:s.approvedExpenseRunRate,cashFlow:s.cashFlow,currency:s.currency,isFallback:!1};return r.modelVersion&&(n.modelVersion=r.modelVersion),r.usageMetadata&&(n.usageMetadata=r.usageMetadata),{summary:e,model:r.modelVersion??it,isFallback:!1,metadata:n}}}return((e,t)=>{const s=t.monthsCount>0?`${t.monthsCount} month${1===t.monthsCount?"":"s"} of trading`:"limited trading data";return{summary:[`**${e.companyName}** – ${e.horizonMonths}-month financial outlook`,`- Average profit: ${mt(t.averageProfit,t.currency)} per month (${s}).`,`- Cash position: ${mt(t.cashFlow,t.currency)} on hand with projected runway ${mt(t.projectedCash,t.currency)} after ${e.horizonMonths} month(s).`,`- Trend: ${0===t.profitTrendPct?"Flat":t.profitTrendPct>0?"Improving":"Softening"} ${ht(t.profitTrendPct)} versus last month.`,`- Pipeline vs. spend: ${mt(t.openInvoiceBalance,t.currency)} outstanding invoices; monthly approved spend about ${mt(t.approvedExpenseRunRate,t.currency)}.`,"- Recommendation: Accelerate collections and hold discretionary costs to protect cash coverage over the planning window."].join("\n"),isFallback:!0,metadata:{horizonMonths:e.horizonMonths,averageMonthlyProfit:t.averageProfit,projectedCash:t.projectedCash,profitTrendPct:Number(Number.isFinite(t.profitTrendPct)?t.profitTrendPct.toFixed(1):"0"),openInvoiceBalance:t.openInvoiceBalance,approvedExpenseRunRate:t.approvedExpenseRunRate,cashFlow:t.cashFlow,currency:t.currency,isFallback:!0}}})({...e,horizonMonths:t},s)},vt=({user:e,currentProject:t,onClose:s,addToast:r})=>{const[a,o]=n.useState(""),[i,c]=n.useState(!1),[l,d]=n.useState(null),[m,p]=n.useState(null);return u.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex justify-center pt-24",onClick:s,children:u.jsxs(ve,{className:"w-full max-w-2xl h-fit max-h-[70vh] flex flex-col",onClick:e=>e.stopPropagation(),children:[u.jsx("h2",{className:"text-2xl font-bold text-slate-800 mb-4",children:"AI Search"}),u.jsxs("div",{className:"flex gap-2",children:[u.jsx("input",{type:"text",value:a,onChange:e=>o(e.target.value),placeholder:"e.g., 'Find all safety reports for Downtown Tower' or 'Who knows about HVAC installation?'",className:"w-full p-2 border rounded-md"}),u.jsx(Ae,{onClick:async()=>{if(a.trim()){c(!0),d(null),p(null);try{let s=[],n=[],r=[],o=[],i=t??null;if(e.companyId){const[a,c,l,d]=await Promise.all([t?Promise.resolve([]):xe.getProjectsByCompany(e.companyId),xe.getSafetyIncidentsByCompany(e.companyId),xe.getExpensesByCompany(e.companyId),t?xe.getDocumentsByProject(t.id):xe.getDocumentsByCompany(e.companyId)]);r=c,o=l,n=d.slice(0,20);let u=[];if(t)u=[t.id];else{const e=a.slice(0,5);u=e.map(e=>e.id),i||1!==e.length||(i=e[0])}u.length>0&&(s=await xe.getTodosByProjectIds(u))}const c=await Et({query:a,user:e,project:i??t??void 0,tasks:s,documents:n,incidents:r,expenses:o});d(c.text),c.isFallback?p("Generated using offline knowledge search fallback."):c.model?p(`Generated with ${c.model}.`):p(null)}catch(s){console.error("AI search failed",s),r("AI search failed. Please try again later.","error"),d("Unable to complete the AI search right now. Please try again later."),p(null)}finally{c(!1)}}else r("Please enter a search query.","error")},isLoading:i,children:"Search"})]}),u.jsxs("div",{className:"mt-4 flex-grow overflow-y-auto",children:[i&&u.jsx("p",{children:"Searching..."}),l&&u.jsx("div",{className:"p-4 bg-slate-50 rounded-md whitespace-pre-wrap font-mono text-sm",children:l}),m&&u.jsx("p",{className:"mt-2 text-xs text-muted-foreground",children:m})]})]})})},It=({user:e,onClose:t,setActiveView:s,onProjectSelect:r})=>{const[a,o]=n.useState(""),[i,c]=n.useState([]),[l,d]=n.useState(0),m=n.useRef(null);n.useEffect(()=>{(async()=>{if(e.companyId)try{const t=e.role===f.ADMIN?await xe.getProjectsByCompany(e.companyId):await xe.getProjectsByUser(e.id);c(t)}catch(t){console.error("Failed to load projects for command palette",t)}})()},[e]);const p=n.useMemo(()=>[...[{id:"nav-dashboard",type:"navigation",title:"Go to Dashboard",category:"Navigation",action:()=>s("dashboard"),keywords:"home main",icon:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"})})},{id:"nav-timesheets",type:"navigation",title:"Go to Timesheets",category:"Navigation",action:()=>s("timesheets"),icon:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"})})},{id:"nav-documents",type:"navigation",title:"Go to Documents",category:"Navigation",action:()=>s("documents"),icon:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})},{id:"nav-settings",type:"navigation",title:"Go to Settings",category:"Navigation",action:()=>s("settings"),icon:u.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})}],...i.map(e=>({id:`proj-${e.id}`,type:"project",title:e.name,category:"Projects",action:()=>r(e),keywords:[e.location?.address,e.projectType,e.status].filter(Boolean).join(" "),icon:u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"})})}))],[i,s,r]),h=n.useMemo(()=>{if(!a)return p;const e=a.toLowerCase();return p.filter(t=>t.title.toLowerCase().includes(e)||t.category.toLowerCase().includes(e)||t.keywords?.toLowerCase().includes(e))},[a,p]);n.useEffect(()=>{d(0)},[h]);const g=n.useCallback(e=>{if("ArrowDown"===e.key){if(e.preventDefault(),0===h.length)return;d(e=>(e+1)%h.length)}else if("ArrowUp"===e.key){if(e.preventDefault(),0===h.length)return;d(e=>(e-1+h.length)%h.length)}else if("Enter"===e.key){if(e.preventDefault(),0===h.length)return;h[l]&&y(h[l])}},[h,l]);n.useEffect(()=>{const e=e=>g(e);return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[g]);const y=e=>{e.action(),t()};return n.useEffect(()=>{m.current?.focus()},[]),u.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex justify-center pt-24",onClick:t,children:u.jsxs("div",{className:"w-full max-w-lg bg-white rounded-lg shadow-2xl h-fit max-h-[60vh] flex flex-col",onClick:e=>e.stopPropagation(),children:[u.jsxs("div",{className:"p-3 border-b flex items-center gap-3",children:[u.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-slate-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:2,children:u.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),u.jsx("input",{ref:m,type:"text",value:a,onChange:e=>o(e.target.value),placeholder:"Search commands or projects...",className:"w-full bg-transparent focus:outline-none"})]}),u.jsx("div",{className:"overflow-y-auto flex-grow",children:h.length>0?u.jsx("ul",{children:h.map((e,t)=>u.jsx("li",{children:u.jsxs("button",{onClick:()=>y(e),className:"w-full text-left p-3 flex items-center justify-between gap-3 "+(t===l?"bg-slate-100":"hover:bg-slate-50"),children:[u.jsxs("div",{className:"flex items-center gap-3",children:[u.jsx("span",{className:"text-slate-400",children:e.icon}),u.jsx("span",{children:e.title})]}),u.jsx("span",{className:"text-xs bg-slate-200 text-slate-600 px-1.5 py-0.5 rounded",children:e.category})]})},e.id))}):u.jsx("p",{className:"text-center text-slate-500 py-10",children:"No results found."})})]})})},At="asagents_reminders_fired",bt=O(),St=()=>{try{const e=bt.getItem(At);return e?JSON.parse(e):[]}catch(e){return[]}},Nt=e=>{const t=St();t.includes(e)||(t.push(e),bt.setItem(At,JSON.stringify(t)))};class jt extends n.Component{constructor(){super(...arguments),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("Uncaught error:",e,t)}render(){return this.state.hasError?u.jsxs(ve,{className:"border-destructive",children:[u.jsx("h2",{className:"text-xl font-bold text-destructive",children:"Something went wrong."}),u.jsx("p",{className:"text-muted-foreground mt-2",children:"A component on this dashboard has crashed. You can try refreshing the page."}),u.jsxs("details",{className:"mt-4 text-sm bg-muted p-2 rounded",children:[u.jsx("summary",{children:"Error Details"}),u.jsx("pre",{className:"whitespace-pre-wrap text-xs mt-2",children:this.state.error?.toString()})]}),u.jsx(Ae,{variant:"secondary",className:"mt-4",onClick:()=>window.location.reload(),children:"Refresh Page"})]}):this.props.children}}const Tt=jt,kt=()=>({environment:"development",status:"disconnected",message:"Auth service not configured"}),_t=e=>()=>{},Pt=({align:e="center",className:t=""})=>{const s=n.useSyncExternalStore(_t,kt,kt),r=n.useMemo(()=>(e=>{if("backend"===e.mode)return`Authenticated against ${e.baseHost||e.baseUrl||"configured backend"}.${e.allowMockFallback?" If the service cannot be reached we will seamlessly fall back to the local demo store.":""}`;return"Operating in secure offline demo mode. Accounts are stored locally in your browser."})(s),[s.mode,s.baseHost,s.baseUrl,s.allowMockFallback]),a="left"===e?"text-left":"text-center";return u.jsx("p",{className:`text-xs text-muted-foreground ${a} ${t}`.trim(),children:r})},Ct=({label:e,name:t,type:s="text",value:n="",onChange:r,error:a})=>u.jsxs("div",{children:[u.jsx("label",{htmlFor:t,className:"block text-sm font-medium text-muted-foreground",children:e}),u.jsx("input",{id:t,name:t,type:s,value:n,onChange:e=>r(t,e.target.value),required:!0,className:"mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm "+(a?"border-destructive":"border-border")}),a&&u.jsx("p",{className:"text-xs text-destructive mt-1",children:a})]}),Mt=({onSwitchToLogin:e})=>{const{requestPasswordReset:t,error:s,loading:r}=ke(),[a,o]=n.useState(""),[i,c]=n.useState(null),[l,d]=n.useState(null);return u.jsxs("div",{className:"min-h-screen bg-background flex flex-col justify-center py-12 sm:px-6 lg:px-8",children:[u.jsxs("div",{className:"sm:mx-auto sm:w-full sm:max-w-md text-center",children:[u.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"Forgot Your Password?"}),u.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Enter your email address and we'll send you a link to reset your password."})]}),u.jsxs(ve,{className:"mt-8 sm:mx-auto sm:w-full sm:max-w-md",children:[u.jsx(Pt,{className:"mb-4"}),s&&u.jsx("div",{className:"mb-4 p-3 bg-destructive/10 text-destructive text-sm rounded-md",children:s}),l&&u.jsx("div",{className:"mb-4 p-3 bg-destructive/10 text-destructive text-sm rounded-md",children:l}),i?u.jsx("div",{className:"p-3 bg-green-100 text-green-800 text-sm rounded-md",children:i}):u.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),d(null),c(null),/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a))try{await t(a),c("If an account with that email exists, a password reset link has been sent.")}catch(s){d(s.message||"An unexpected error occurred.")}else d("Please enter a valid email address.")},className:"space-y-6",children:[u.jsx(Ct,{label:"Email Address",name:"email",type:"email",value:a,onChange:(e,t)=>o(t)}),u.jsx(Ae,{type:"submit",className:"w-full",isLoading:r,children:"Send Reset Link"})]})]}),u.jsxs("p",{className:"mt-6 text-center text-sm text-muted-foreground",children:["Remember your password?"," ",u.jsx("button",{onClick:e,className:"font-semibold text-primary hover:text-primary/80",children:"Sign in"})]})]})},Dt=({token:e,onSuccess:t})=>{const{resetPassword:s,error:r,loading:a}=ke(),[o,i]=n.useState(""),[c,l]=n.useState(""),[d,m]=n.useState("");return u.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8",children:u.jsxs("div",{className:"max-w-md w-full space-y-8",children:[u.jsxs("div",{children:[u.jsx("h2",{className:"mt-6 text-center text-3xl font-extrabold text-gray-900",children:"Reset Your Password"}),u.jsx("p",{className:"mt-2 text-center text-sm text-gray-600",children:"Enter your new password below"})]}),u.jsx(ve,{children:u.jsx("div",{className:"p-6",children:u.jsxs("form",{onSubmit:async n=>{if(n.preventDefault(),m(""),o===c)if(o.length<8)m("Password must be at least 8 characters long");else try{await s(e,o),t()}catch(r){m("Failed to reset password. Please try again.")}else m("Passwords do not match")},className:"space-y-4",children:[u.jsxs("div",{children:[u.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700",children:"New Password"}),u.jsx("input",{id:"password",type:"password",required:!0,value:o,onChange:e=>i(e.target.value),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500",placeholder:"Enter new password"})]}),u.jsxs("div",{children:[u.jsx("label",{htmlFor:"confirmPassword",className:"block text-sm font-medium text-gray-700",children:"Confirm Password"}),u.jsx("input",{id:"confirmPassword",type:"password",required:!0,value:c,onChange:e=>l(e.target.value),className:"mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500",placeholder:"Confirm new password"})]}),(d||r)&&u.jsx("div",{className:"text-red-600 text-sm",children:d||r}),u.jsx(Ae,{type:"submit",disabled:a,className:"w-full",children:a?"Resetting...":"Reset Password"})]})})})]})})},Rt=()=>u.jsx(ve,{children:u.jsxs("div",{className:"p-6 text-center",children:[u.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Access Denied"}),u.jsx("p",{className:"text-gray-600",children:"You don't have permission to view this section."})]})}),Lt=({user:e,view:t,children:s,fallback:n,requiredPermissions:r=[],anyRequiredPermissions:a=[]})=>{if(!e)return n||u.jsx(Rt,{});const o=r.every(t=>Se(t,e)),i=0===a.length||a.some(t=>t.every(t=>Se(t,e)));return o&&i?u.jsx(u.Fragment,{children:s}):n||u.jsx(Rt,{})},Ot={anyPermissions:[y.VIEW_ALL_PROJECTS,y.VIEW_ASSIGNED_PROJECTS],description:"Project visibility is required to review portfolio information."},Vt={anyPermissions:[y.VIEW_DOCUMENTS,y.UPLOAD_DOCUMENTS],description:"Document access is needed to browse project files and upload content."},$t={anyPermissions:[y.VIEW_SAFETY_REPORTS,y.SUBMIT_SAFETY_REPORT],description:"Safety permissions ensure only authorised crew can view and log incidents."},Ut={anyPermissions:[y.VIEW_FINANCES,y.MANAGE_FINANCES],description:"Financial permissions allow visibility into invoices, payments and cost tracking."},Ft={projects:Ot,map:Ot,"project-detail":Ot,"all-tasks":{anyPermissions:[y.VIEW_ALL_TASKS,y.MANAGE_ALL_TASKS],description:"Task visibility is required to review and manage work packages."},time:{anyPermissions:[y.SUBMIT_TIMESHEET,y.MANAGE_TIMESHEETS],description:"Only authorised crew can log or manage time entries."},timesheets:{anyPermissions:[y.VIEW_ALL_TIMESHEETS,y.MANAGE_TIMESHEETS],description:"Timesheet approval rights are needed to review labour history."},documents:Vt,safety:$t,financials:Ut,invoices:Ut,users:{anyPermissions:[y.VIEW_TEAM,y.MANAGE_TEAM],description:"Team administration requires workforce visibility permissions."},equipment:{anyPermissions:[y.MANAGE_EQUIPMENT],description:"Equipment control ensures assets are managed by the operations team."},templates:{anyPermissions:[y.MANAGE_PROJECT_TEMPLATES],description:"Template library is reserved for portfolio leads."},tools:{anyPermissions:[y.ACCESS_ALL_TOOLS],description:"Toolbox modules are restricted to teams with platform extensions."},"audit-log":{anyPermissions:[y.VIEW_AUDIT_LOG],description:"Audit information is available to compliance and admin roles."},chat:{anyPermissions:[y.SEND_DIRECT_MESSAGE],description:"Messaging requires communication privileges."},clients:{anyPermissions:[y.VIEW_ALL_PROJECTS,y.MANAGE_FINANCES],description:"Client records are tied to portfolio or commercial permissions."},"foreman-dashboard":{allowedRoles:[f.FOREMAN,f.PROJECT_MANAGER,f.ADMIN,f.OWNER],description:"Field dashboards are tailored for operations leadership.",fallbackView:"dashboard"},"principal-dashboard":{allowedRoles:[f.PRINCIPAL_ADMIN],description:"Only platform administrators can access the principal dashboard.",fallbackView:"dashboard"}};function Bt({id:e,type:t="info",title:s,message:r,action:a,onDismiss:o}){const[i,c]=n.useState(!1),[l,d]=n.useState(!1);n.useEffect(()=>{const e=setTimeout(()=>c(!0),10);return()=>clearTimeout(e)},[]);return u.jsx("div",{className:`\n        max-w-sm w-full pointer-events-auto transform transition-all duration-300 ease-in-out\n        ${i&&!l?"translate-x-0 opacity-100":"translate-x-full opacity-0"}\n        ${{success:"bg-green-50 border-green-200 text-green-800",error:"bg-red-50 border-red-200 text-red-800",warning:"bg-yellow-50 border-yellow-200 text-yellow-800",info:"bg-blue-50 border-blue-200 text-blue-800"}[t]}\n        border rounded-lg shadow-lg p-4 mb-4\n      `,children:u.jsxs("div",{className:"flex items-start",children:[u.jsx("div",{className:"flex-shrink-0",children:u.jsx("span",{className:"text-lg",children:{success:"✓",error:"✕",warning:"⚠",info:"ℹ"}[t]})}),u.jsxs("div",{className:"ml-3 flex-1",children:[u.jsx("p",{className:"text-sm font-medium",children:s}),r&&u.jsx("p",{className:"mt-1 text-sm opacity-90",children:r})]}),u.jsxs("div",{className:"flex flex-shrink-0 ml-4 space-x-2",children:[a&&u.jsx("button",{onClick:a.onClick,className:"text-sm underline hover:no-underline focus:outline-none",children:a.label}),u.jsx("button",{onClick:()=>{d(!0),setTimeout(()=>o(),300)},className:"text-lg leading-none hover:opacity-75 focus:outline-none",children:"×"})]})]})})}const Gt=n.createContext(void 0),zt=({children:e,maxToasts:t=5})=>{const[s,r]=n.useState([]),a=n.useCallback(e=>{const s=`toast-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,n={id:s,type:e.type,title:e.title,message:e.message,action:e.action,onDismiss:()=>{o(s),e.onDismiss?.()}};if(r(e=>[n,...e].slice(0,t)),0!==e.duration){const t=e.duration||5e3;setTimeout(()=>{o(s)},t)}return s},[t]),o=n.useCallback(e=>{r(t=>t.filter(t=>t.id!==e))},[]),i={addToast:a,removeToast:o,toasts:s};return u.jsxs(Gt.Provider,{value:i,children:[e,u.jsx("div",{className:"fixed top-4 right-4 z-50 flex flex-col space-y-2",children:s.map(e=>u.jsx(Bt,{...e},e.id))})]})},Wt=r.lazy(()=>g(()=>import("./Dashboard-l5ZD31sQ.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8])).then(e=>({default:e.Dashboard})));r.lazy(()=>g(()=>import("./OwnerDashboard-FjUUYyqO.js"),__vite__mapDeps([9,1,2,4,5,6,10,8])).then(e=>({default:e.OwnerDashboard})));const qt=r.lazy(()=>g(()=>import("./MyDayView-Dvq2cjFJ.js"),__vite__mapDeps([11,1,2,8])).then(e=>({default:e.MyDayView}))),Ht=r.lazy(()=>g(()=>import("./ForemanDashboard-Bl3tXQOr.js"),[]).then(e=>({default:e.ForemanDashboard}))),Jt=r.lazy(()=>g(()=>import("./PrincipalAdminDashboard-BftXn6y3.js"),__vite__mapDeps([12,1,2,8])).then(e=>({default:e.PrincipalAdminDashboard}))),Yt=r.lazy(()=>g(()=>import("./ProjectsView-DsVUKU2E.js"),__vite__mapDeps([13,1,2,8])).then(e=>({default:e.ProjectsView}))),Kt=r.lazy(()=>g(()=>import("./ProjectDetailView-CBFjL1co.js"),__vite__mapDeps([14,1,2,8])).then(e=>({default:e.ProjectDetailView}))),Qt=r.lazy(()=>g(()=>import("./AllTasksView-CAerpRT9.js"),__vite__mapDeps([15,1,2,5,8])).then(e=>({default:e.AllTasksView}))),Zt=r.lazy(()=>g(()=>import("./ProjectsMapView-BgMfa9zS.js"),__vite__mapDeps([16,1,2,17,8])).then(e=>({default:e.ProjectsMapView}))),Xt=r.lazy(()=>g(()=>import("./TimeTrackingView-CLgyviju.js"),__vite__mapDeps([18,1,2,17,8])).then(e=>({default:e.TimeTrackingView}))),es=r.lazy(()=>g(()=>import("./TimesheetsView-BWacfgmE.js"),__vite__mapDeps([19,1,2,3,4,8])).then(e=>({default:e.TimesheetsView}))),ts=r.lazy(()=>g(()=>import("./DocumentsView-BK4c7-de.js"),__vite__mapDeps([20,1,2,8])).then(e=>({default:e.DocumentsView}))),ss=r.lazy(()=>g(()=>import("./SafetyView-Cq0XJCdX.js"),__vite__mapDeps([21,1,2,8])).then(e=>({default:e.SafetyView}))),ns=r.lazy(()=>g(()=>import("./FinancialsView-DAqoWPvA.js"),__vite__mapDeps([22,1,2,10,8])).then(e=>({default:e.FinancialsView}))),rs=r.lazy(()=>g(()=>import("./TeamView-gZZeM_PZ.js"),__vite__mapDeps([23,1,2,4,8])).then(e=>({default:e.TeamView}))),as=r.lazy(()=>g(()=>import("./EquipmentView-BxmQ3B8e.js"),__vite__mapDeps([24,1,2,3,4,8])).then(e=>({default:e.EquipmentView}))),os=r.lazy(()=>g(()=>import("./TemplatesView-DqPP4zhP.js"),__vite__mapDeps([25,1,2,8])).then(e=>({default:e.TemplatesView}))),is=r.lazy(()=>g(()=>import("./ToolsView-Bb7ws0Va.js"),__vite__mapDeps([26,1,2,8])).then(e=>({default:e.ToolsView}))),cs=r.lazy(()=>g(()=>import("./AuditLogView-NkmcrqGb.js"),__vite__mapDeps([27,1,2,8])).then(e=>({default:e.AuditLogView}))),ls=r.lazy(()=>g(()=>import("./SettingsView-CLzZsNhy.js"),__vite__mapDeps([28,1,2,8])).then(e=>({default:e.SettingsView}))),ds=r.lazy(()=>g(()=>import("./ChatView-DU-naVsp.js"),__vite__mapDeps([29,1,2,8])).then(e=>({default:e.ChatView}))),us=r.lazy(()=>g(()=>import("./ClientsView-BLjzyKUL.js"),__vite__mapDeps([30,1,2,8])).then(e=>({default:e.ClientsView}))),ms=r.lazy(()=>g(()=>import("./InvoicesView-FJ4Krrxw.js"),__vite__mapDeps([31,1,2,3,4,5,10,7,8])).then(e=>({default:e.InvoicesView}))),ps=r.lazy(()=>g(()=>import("./UserRegistration-BqxZwAl-.js"),__vite__mapDeps([32,1,2,8])).then(e=>({default:e.UserRegistration}))),hs=({toast:e,onDismiss:t})=>{n.useEffect(()=>{const s=setTimeout(()=>t(e.id),5e3);return()=>clearTimeout(s)},[e,t]);const s=!!e.notification,r={success:"bg-primary text-primary-foreground border-transparent",error:"bg-destructive text-destructive-foreground border-transparent",notification:"bg-card text-card-foreground border-border"},a=s?r.notification:r[e.type],o=s?"New Notification":"success"===e.type?"Success":"Error";return u.jsxs("div",{className:`p-4 rounded-[--radius] shadow-lg text-sm font-medium animate-card-enter flex items-start gap-3 w-80 border ${a}`,children:[u.jsx("span",{className:"text-xl mt-0.5",children:(()=>{if(!s)return"success"===e.type?"🎉":"🚨";switch(e.notification?.type){case I.APPROVAL_REQUEST:return"📄";case I.TASK_ASSIGNED:return"✅";case I.NEW_MESSAGE:return"💬";case I.SAFETY_ALERT:return"⚠️";default:return"🔔"}})()}),u.jsxs("div",{className:"flex-grow",children:[u.jsx("p",{className:"font-bold",children:o}),u.jsx("p",{children:e.message})]}),u.jsx("button",{type:"button",onClick:()=>t(e.id),className:"p-1 -m-1 rounded-full hover:bg-black/10 flex-shrink-0",children:"×"})]})};function gs(){const{isAuthenticated:e,user:t,loading:s,logout:r}=ke(),[a,o]=n.useState("login"),[i,c]=n.useState(null),[l,d]=n.useState("dashboard"),[m,p]=n.useState(null),[h,g]=n.useState([]),[y,w]=n.useState(null),[E,x]=n.useState(!1),[v,b]=n.useState(null),[N,j]=n.useState(0),[T,k]=n.useState(0),[_,P]=n.useState(0),[C,M]=n.useState(0),[D,R]=n.useState([]),L=n.useRef([]),O=n.useCallback(e=>{"project-detail"!==e&&p(null),d(e)},[]),V=n.useCallback((e,t="success",s)=>{g(n=>[...n,{id:Date.now(),message:e,type:t,notification:s}])},[]),$=e=>{g(t=>t.filter(t=>t.id!==e))};n.useEffect(()=>{const e=new URLSearchParams(window.location.search).get("token");e&&(c(e),o("reset-password"))},[]);const{isOnline:U}=(e=>{const[t,s]=n.useState(navigator.onLine),r=n.useCallback(async()=>{const{successCount:t,movedToFailedCount:s}=await ge();t>0&&e(`Successfully synced ${t} offline action(s). Your data is now up-to-date.`,"success"),s>0&&e(`${s} action(s) failed to sync after multiple attempts. You can review them in Settings.`,"error")},[e]);return n.useEffect(()=>{const t=()=>{s(!0),e("You are back online.","success"),r()},n=()=>{s(!1),e("You are now offline. Changes will be saved locally and synced later.","error")};return window.addEventListener("online",t),window.addEventListener("offline",n),navigator.onLine&&r(),()=>{window.removeEventListener("online",t),window.removeEventListener("offline",n)}},[e,r]),{isOnline:t}})(V),{isCommandPaletteOpen:F,setIsCommandPaletteOpen:B}=(()=>{const[e,t]=n.useState(!1),s=n.useCallback(e=>{(e.metaKey||e.ctrlKey)&&"k"===e.key&&(e.preventDefault(),t(e=>!e)),"Escape"===e.key&&t(!1)},[]);return n.useEffect(()=>(document.addEventListener("keydown",s),()=>{document.removeEventListener("keydown",s)}),[s]),{isCommandPaletteOpen:e,setIsCommandPaletteOpen:t}})();(e=>{const t=n.useCallback(async()=>{if(e)try{const t=await xe.getProjectsByUser(e.id);if(0===t.length)return;const s=(await xe.getTodosByProjectIds(t.map(e=>e.id))).filter(t=>t.assigneeId===e.id&&t.reminderAt),n=St();for(const e of s){const s=e.reminderAt;s&&new Date(s)<=new Date&&!n.includes(e.id)&&"granted"===Notification.permission&&(new Notification(`Reminder: ${e.text||e.title}`,{body:`This task is due soon on project: ${t.find(t=>t.id===e.projectId)?.name||"Unknown"}.`,icon:"/favicon.svg"}),Nt(e.id))}}catch(t){console.error("Failed to check for reminders:",t)}},[e]);n.useEffect(()=>{if(!e)return;t();const s=setInterval(t,3e4);return()=>{clearInterval(s)}},[e,t])})(t),n.useEffect(()=>{t?.companyId&&xe.getCompanySettings(t.companyId).then(w)},[t]),n.useEffect(()=>{y&&document.documentElement.classList.toggle("dark","dark"===y.theme)},[y]),n.useEffect(()=>{e&&t&&d((e=>{switch(e.role){case f.OPERATIVE:return"my-day";case f.FOREMAN:return"foreman-dashboard";case f.PRINCIPAL_ADMIN:return"principal-dashboard";default:return"dashboard"}})(t))},[e,t]);const G=n.useCallback(async e=>{if(e.companyId)try{const[t,s,n,r]=await Promise.all([xe.getTimesheetsByCompany(e.companyId,e.id),xe.getSafetyIncidentsByCompany(e.companyId),xe.getConversationsForUser(e.id),xe.getNotificationsForUser(e.id)]);j(t.filter(e=>e.status===A.PENDING).length),k(s.filter(e=>e.status!==S.RESOLVED).length),P(n.filter(t=>t.lastMessage&&!t.lastMessage.isRead&&t.lastMessage.senderId!==e.id).length);const a=r.filter(e=>!e.isRead);M(a.length);const o=new Set(L.current.filter(e=>!e.isRead).map(e=>e.id)),i=a.filter(e=>!o.has(e.id));i.length>0&&i.forEach(e=>{V(e.message,"success",e)}),L.current=r,R(r)}catch(t){console.error("Could not update notification counts.",t)}},[V]);n.useEffect(()=>{t&&xe.getNotificationsForUser(t.id).then(e=>{L.current=e,R(e),G(t)});const e=setInterval(()=>{t&&G(t)},5e3);return()=>clearInterval(e)},[t,G]);const z=()=>{r(),o("login"),O("dashboard")},W=e=>{p(e),d("project-detail")},q=e=>{b(e),d("chat")},H=n.useCallback(async e=>{if(!t)return;const s=!(e.isRead??e.read);try{s&&await xe.markNotificationAsRead(e.id),R(t=>t.map(t=>t.id===e.id?{...t,isRead:!0,read:!0}:t)),L.current=L.current.map(t=>t.id===e.id?{...t,isRead:!0,read:!0}:t),s&&M(e=>Math.max(0,e-1))}catch(r){return console.error("Failed to update notification state",r),void V("Unable to update that notification right now.","error")}const n=e.metadata??{};if(n.projectId)try{const e=await xe.getProjectById(n.projectId);return e?(p(e),void O("project-detail")):(V("The project linked to this notification is no longer available.","error"),void O("projects"))}catch(r){return console.error("Failed to load project from notification",r),V("We could not open the related project.","error"),void O("projects")}else{if(n.view&&n.view!==l)return void O(n.view);if(e.type===I.NEW_MESSAGE)return void O("chat")}s&&V("Notification marked as read.","success")},[t,V,O,l]);if(s)return u.jsx("div",{className:"flex h-screen w-full items-center justify-center bg-background text-foreground",children:u.jsx("p",{children:"Loading application..."})});if(!e||!t)switch(a){case"login":default:return u.jsx(_e,{onSwitchToRegister:()=>o("register"),onSwitchToForgotPassword:()=>o("forgot-password")});case"register":return u.jsx(ps,{onSwitchToLogin:()=>o("login")});case"forgot-password":return u.jsx(Mt,{onSwitchToLogin:()=>o("login")});case"reset-password":return i?u.jsx(Dt,{token:i,onSuccess:()=>{o("login"),c(null),window.history.pushState({},"",window.location.pathname)}}):u.jsx(_e,{onSwitchToRegister:()=>o("register"),onSwitchToForgotPassword:()=>o("forgot-password")})}const J=((e,t)=>{const s=Ft[t];if(!s)return{view:t,allowed:!0,missingPermissions:[],missingAnyPermissionGroups:[]};if(s.allowedRoles&&!s.allowedRoles.includes(e.role))return{view:t,allowed:!1,missingPermissions:[],missingAnyPermissionGroups:[],allowedRoles:s.allowedRoles,reason:s.description,fallbackView:s.fallbackView};const n=[],r=[];s.anyPermissions&&(s.anyPermissions.some(t=>Se(e,t))||(r.push(s.anyPermissions),n.push(...s.anyPermissions)));if(s.allPermissions){const t=s.allPermissions.filter(t=>!Se(e,t));n.push(...t)}return n.length>0||r.length>0?{view:t,allowed:!1,missingPermissions:n,missingAnyPermissionGroups:r,reason:s.description,fallbackView:s.fallbackView}:{view:t,allowed:!0,missingPermissions:[],missingAnyPermissionGroups:[]}})(t,l),Y=J.allowed?(()=>{if(!t)return null;if("project-detail"===l&&m)return u.jsx(Kt,{project:m,user:t,onBack:()=>O("projects"),addToast:V,isOnline:U,onStartChat:q});switch(l){case"dashboard":default:return u.jsx(Wt,{user:t,addToast:V,activeView:l,setActiveView:O,onSelectProject:W});case"my-day":return u.jsx(qt,{user:t,addToast:V});case"foreman-dashboard":return u.jsx(Ht,{user:t,addToast:V});case"principal-dashboard":return u.jsx(Jt,{user:t,addToast:V});case"projects":return u.jsx(Yt,{user:t,addToast:V,onSelectProject:W});case"all-tasks":return u.jsx(Qt,{user:t,addToast:V,isOnline:U});case"map":return u.jsx(Zt,{user:t,addToast:V});case"time":return u.jsx(Xt,{user:t,addToast:V,setActiveView:O});case"timesheets":return u.jsx(es,{user:t,addToast:V});case"documents":return u.jsx(ts,{user:t,addToast:V,isOnline:U,settings:y});case"safety":return u.jsx(ss,{user:t,addToast:V,setActiveView:O});case"financials":return u.jsx(ns,{user:t,addToast:V});case"users":return u.jsx(rs,{user:t,addToast:V,onStartChat:q});case"equipment":return u.jsx(as,{user:t,addToast:V});case"templates":return u.jsx(os,{user:t,addToast:V});case"tools":return u.jsx(is,{user:t,addToast:V,setActiveView:O});case"audit-log":return u.jsx(cs,{user:t,addToast:V});case"settings":return u.jsx(ls,{user:t,addToast:V,settings:y,onSettingsUpdate:e=>w(t=>({...t,...e}))});case"chat":return u.jsx(ds,{user:t,addToast:V,initialRecipient:v});case"clients":return u.jsx(us,{user:t,addToast:V});case"invoices":return u.jsx(ms,{user:t,addToast:V})}})():null;return u.jsxs("div",{className:"relative flex h-screen overflow-hidden bg-background text-foreground",children:[u.jsx("div",{className:"pointer-events-none absolute inset-0 bg-gradient-to-br from-primary/10 via-transparent to-transparent dark:from-primary/20","aria-hidden":"true"}),u.jsx("div",{className:"pointer-events-none absolute inset-y-0 right-[-10%] w-1/2 rounded-full bg-primary/5 blur-3xl dark:bg-primary/10","aria-hidden":"true"}),u.jsx(Ge,{user:t,activeView:l,setActiveView:O,onLogout:z,pendingTimesheetCount:N,openIncidentCount:T,unreadMessageCount:_}),u.jsxs("div",{className:"relative z-10 flex flex-1 flex-col overflow-hidden",children:[u.jsx(We,{user:t,onLogout:z,onSearchClick:()=>x(!0),onCommandPaletteClick:()=>B(!0),unreadNotificationCount:C,notifications:D,onNotificationClick:H,onMarkAllNotificationsAsRead:async()=>{t&&(await xe.markAllNotificationsAsRead(t.id),G(t))},addToast:V}),u.jsx("main",{className:"flex-1 overflow-y-auto p-6 lg:p-8",children:u.jsx(Tt,{children:u.jsx(Lt,{user:t,view:l,evaluation:J,fallbackView:J.fallbackView,onNavigate:O,children:u.jsx(n.Suspense,{fallback:u.jsx("div",{className:"p-6 text-sm text-muted-foreground",children:"Loading view…"}),children:Y})})})})]}),E&&u.jsx(vt,{user:t,currentProject:m,onClose:()=>x(!1),addToast:V}),F&&u.jsx(It,{user:t,onClose:()=>B(!1),setActiveView:O}),u.jsx("div",{className:"fixed bottom-4 right-4 z-50 space-y-2",children:h.map(e=>u.jsx(hs,{toast:e,onDismiss:$},e.id))})]})}function fs(){return u.jsx(zt,{children:u.jsx(gs,{})})}window.addEventListener("unhandledrejection",e=>{const t=Je(e.reason,{operation:"unhandled_promise_rejection",component:"global",timestamp:(new Date).toISOString()},{severity:"high",userMessage:"An unexpected error occurred in the background."});Ye.report(t),console.error("Unhandled promise rejection:",t)}),window.addEventListener("error",e=>{const t=Je(e.error||e.message,{operation:"uncaught_error",component:"global",timestamp:(new Date).toISOString(),metadata:{filename:e.filename,lineno:e.lineno,colno:e.colno}},{severity:"critical",userMessage:"A critical error occurred. Please refresh the page."});Ye.report(t),console.error("Uncaught error:",t)});const ys=document.getElementById("root");if(!ys)throw new Error("Could not find root element to mount to");p.createRoot(ys).render(u.jsx(r.StrictMode,{children:u.jsx(Te,{children:u.jsx(fs,{})})}));export{Pe as A,Ae as B,ve as C,x as E,S as I,y as P,f as R,w as T,xe as a,j as b,v as c,b as d,A as e,xt as f,wt as g,Se as h,N as i,u as j,fe as k,Ee as l,we as m,T as n,ye as r,ke as u};
