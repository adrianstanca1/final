version : '3.8'

          services : postgres : image : postgres : 15 -
                                        alpine
                                            restart : unless -
                                                      stopped
                                                              environment : POSTGRES_DB : ${POSTGRES_DB} POSTGRES_USER : ${POSTGRES_USER} POSTGRES_PASSWORD : ${POSTGRES_PASSWORD} volumes : -postgres_data : /
                                                                                                                                                                                                              var / lib / postgresql / data healthcheck : test : [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ] interval : 30s timeout : 10s retries : 5 networks : -app -
                                                      network

                                                          redis : image : redis : 7 -
                                                                          alpine
                                                                              restart : unless -
                                                                                        stopped
                                                                                            command : redis -
                                                                                                      server-- appendonly yes-- requirepass ${REDIS_PASSWORD} volumes : -redis_data : / data
                                                                                                                                                                                            healthcheck : test : [ "CMD", "redis-cli", "--raw", "incr", "ping" ] interval : 30s timeout : 10s retries : 5 networks : -app -
                                                                                                      network

                                                                                                              backend : image : ${REGISTRY_URL} /
                                                                                                                                construction -
                                                                                                      backend : ${IMAGE_TAG : -latest} restart : unless - stopped environment : NODE_ENV : staging DATABASE_URL : postgresql :                     //${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
                                                                                                                                                                                                                               REDIS_URL : redis : //:${REDIS_PASSWORD}@redis:6379
                                                                                                                                                                                                                                                   JWT_SECRET : ${JWT_SECRET} JWT_REFRESH_SECRET : ${JWT_REFRESH_SECRET} GEMINI_API_KEY : ${GEMINI_API_KEY} PORT : 3001 depends_on : postgres : condition : service_healthy redis : condition : service_healthy healthcheck : test : [ "CMD", "curl", "-f", "http://localhost:3001/health" ] interval : 30s timeout : 10s retries : 5 start_period : 60s networks : -app -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    network
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        labels : -"traefik.enable=true" -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "traefik.http.routers.backend-staging.rule=Host(`api-staging.constructionapp.com`)" - "traefik.http.routers.backend-staging.tls=true" - "traefik.http.routers.backend-staging.tls.certresolver=letsencrypt"

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             frontend : image : ${REGISTRY_URL} /
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                construction -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 frontend : ${IMAGE_TAG : -latest} restart : unless - stopped environment : VITE_API_URL : https : // api-staging.constructionapp.com
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   VITE_GEMINI_API_KEY : ${GEMINI_API_KEY} healthcheck : test : [ "CMD", "curl", "-f", "http://localhost:80/health" ] interval : 30s timeout : 10s retries : 5 networks : -app -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          network
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              labels : -"traefik.enable=true" -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "traefik.http.routers.frontend-staging.rule=Host(`staging.constructionapp.com`)" - "traefik.http.routers.frontend-staging.tls=true" - "traefik.http.routers.frontend-staging.tls.certresolver=letsencrypt"

#Reverse proxy and load balancer
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       traefik : image : traefik : v3.0 restart : unless -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ports : -"80:80" -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              "443:443" - "8080:8080" environment : -TRAEFIK_API_INSECURE = true - TRAEFIK_PROVIDERS_DOCKER = true - TRAEFIK_PROVIDERS_DOCKER_EXPOSEDBYDEFAULT = false - TRAEFIK_ENTRYPOINTS_WEB_ADDRESS = : 80 - TRAEFIK_ENTRYPOINTS_WEBSECURE_ADDRESS = : 443 - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_TLSCHALLENGE = true - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL = ${ACME_EMAIL} - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_STORAGE = / letsencrypt / acme.json volumes : -/ var / run / docker.sock : / var / run / docker.sock : ro - letsencrypt : / letsencrypt networks : -app - network

#Monitoring and observability
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               prometheus : image : prom /
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    prometheus : latest restart : unless -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               volumes : -./
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           monitoring / prometheus.yml : / etc / prometheus / prometheus.yml -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       prometheus_data : / prometheus
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               command : -'--config.file=/etc/prometheus/prometheus.yml' -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       '--storage.tsdb.path=/prometheus' - '--web.console.libraries=/etc/prometheus/console_libraries' - '--web.console.templates=/etc/prometheus/consoles' - '--storage.tsdb.retention.time=200h' - '--web.enable-lifecycle' networks : -app - network

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        grafana : image : grafana /
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          grafana -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         oss : latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   restart : unless -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     environment : GF_SECURITY_ADMIN_USER : ${GRAFANA_USER} GF_SECURITY_ADMIN_PASSWORD : ${GRAFANA_PASSWORD} GF_USERS_ALLOW_SIGN_UP : false volumes : -grafana_data : /
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      var / lib / grafana -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ./ monitoring / grafana / provisioning : / etc / grafana / provisioning depends_on : -prometheus networks : -app - network

#Log aggregation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            loki : image : grafana /
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           loki : latest restart : unless -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     volumes : -./
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 monitoring / loki.yml : / etc / loki / local -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             config.yaml - loki_data : / loki networks : -app - network

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        promtail : image : grafana /
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           promtail : latest restart : unless -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             stopped
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     volumes : -/
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               var / log : / var / log : ro -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             / var / lib / docker / containers : / var / lib / docker / containers : ro -./ monitoring / promtail.yml : / etc / promtail / config.yml command : -config.file = / etc / promtail / config.yml networks : -app - network

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   volumes : postgres_data : driver : local redis_data : driver : local grafana_data : driver : local prometheus_data : driver : local loki_data : driver : local letsencrypt : driver : local

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             networks : app -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        network : driver : bridge